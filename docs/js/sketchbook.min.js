var AP_RESOURCES="resources/",AP_MODELS=AP_RESOURCES+"models/";(function(){"use strict";var b=void 0,o=this;function e(e,t){var n,a=e.split("."),i=o;!(a[0]in i)&&i.execScript&&i.execScript("var "+a[0]);for(;a.length&&(n=a.shift());)a.length||t===b?i=i[n]?i[n]:i[n]={}:i[n]=t}var T="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function x(e){var t,n,a,i,o,r,s,l,d,u,c=e.length,f=0,h=Number.POSITIVE_INFINITY;for(l=0;l<c;++l)e[l]>f&&(f=e[l]),e[l]<h&&(h=e[l]);for(t=1<<f,n=new(T?Uint32Array:Array)(t),a=1,i=0,o=2;a<=f;){for(l=0;l<c;++l)if(e[l]===a){for(s=i,d=r=0;d<a;++d)r=r<<1|1&s,s>>=1;for(u=a<<16|l,d=r;d<t;d+=o)n[d]=u;++i}++a,i<<=1,o<<=1}return[n,f,h]}function i(e,t){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=T?new Uint8Array(e):e,this.m=!1,this.i=S,this.r=!1,(t||(t={},0))&&(t.index&&(this.a=t.index),t.bufferSize&&(this.h=t.bufferSize),t.bufferType&&(this.i=t.bufferType),t.resize&&(this.r=t.resize)),this.i){case F:this.b=32768,this.c=new(T?Uint8Array:Array)(32768+this.h+258);break;case S:this.b=0,this.c=new(T?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:throw Error("invalid inflate mode")}}var F=0,S=1,t={t:F,s:S};i.prototype.k=function(){for(;!this.m;){var e=R(this,3);switch(1&e&&(this.m=!0),e>>>=1){case 0:var t=this.input,n=this.a,a=this.c,i=this.b,o=t.length,r=b,s=a.length,l=b;if(this.d=this.f=0,o<=n+1)throw Error("invalid uncompressed block header: LEN");if(r=t[n++]|t[n++]<<8,o<=n+1)throw Error("invalid uncompressed block header: NLEN");if(r===~(t[n++]|t[n++]<<8))throw Error("invalid uncompressed block header: length verify");if(n+r>t.length)throw Error("input buffer is broken");switch(this.i){case F:for(;i+r>a.length;){if(r-=l=s-i,T)a.set(t.subarray(n,n+l),i),i+=l,n+=l;else for(;l--;)a[i++]=t[n++];this.b=i,a=this.e(),i=this.b}break;case S:for(;i+r>a.length;)a=this.e({p:2});break;default:throw Error("invalid inflate mode")}if(T)a.set(t.subarray(n,n+r),i),i+=r,n+=r;else for(;r--;)a[i++]=t[n++];this.a=n,this.b=i,this.c=a;break;case 1:this.j(P,L);break;case 2:var d,u,c,f,h=R(this,5)+257,p=R(this,5)+1,m=R(this,4)+4,_=new(T?Uint8Array:Array)(w.length),E=b,v=b,g=b,A=b,y=b;for(y=0;y<m;++y)_[w[y]]=R(this,3);if(!T)for(y=m,m=_.length;y<m;++y)_[w[y]]=0;for(d=x(_),E=new(T?Uint8Array:Array)(h+p),y=0,f=h+p;y<f;)switch(v=N(this,d),v){case 16:for(A=3+R(this,2);A--;)E[y++]=g;break;case 17:for(A=3+R(this,3);A--;)E[y++]=0;g=0;break;case 18:for(A=11+R(this,7);A--;)E[y++]=0;g=0;break;default:g=E[y++]=v}u=x(T?E.subarray(0,h):E.slice(0,h)),c=x(T?E.subarray(h):E.slice(h)),this.j(u,c);break;default:throw Error("unknown BTYPE: "+e)}}return this.n()};var n,a,r=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],w=T?new Uint16Array(r):r,s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],d=T?new Uint16Array(s):s,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],u=T?new Uint8Array(l):l,c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],f=T?new Uint16Array(c):c,h=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],p=T?new Uint8Array(h):h,m=new(T?Uint8Array:Array)(288);for(n=0,a=m.length;n<a;++n)m[n]=n<=143?8:n<=255?9:n<=279?7:8;var _,E,P=x(m),v=new(T?Uint8Array:Array)(30);for(_=0,E=v.length;_<E;++_)v[_]=5;var L=x(v);function R(e,t){for(var n,a=e.f,i=e.d,o=e.input,r=e.a,s=o.length;i<t;){if(s<=r)throw Error("input buffer is broken");a|=o[r++]<<i,i+=8}return n=a&(1<<t)-1,e.f=a>>>t,e.d=i-t,e.a=r,n}function N(e,t){for(var n,a,i=e.f,o=e.d,r=e.input,s=e.a,l=r.length,d=t[0],u=t[1];o<u&&!(l<=s);)i|=r[s++]<<o,o+=8;if(o<(a=(n=d[i&(1<<u)-1])>>>16))throw Error("invalid code length: "+a);return e.f=i>>a,e.d=o-a,e.a=s,65535&n}function g(e,t){var n,a;switch(this.input=e,this.a=0,(t||(t={},0))&&(t.index&&(this.a=t.index),t.verify&&(this.A=t.verify)),n=e[this.a++],a=e[this.a++],15&n){case A:this.method=A;break;default:throw Error("unsupported compression method")}if(0!=((n<<8)+a)%31)throw Error("invalid fcheck flag:"+((n<<8)+a)%31);if(32&a)throw Error("fdict flag is not supported");this.q=new i(e,{index:this.a,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}i.prototype.j=function(e,t){var n=this.c,a=this.b;this.o=e;for(var i,o,r,s,l=n.length-258;256!==(i=N(this,e));)if(i<256)l<=a&&(this.b=a,n=this.e(),a=this.b),n[a++]=i;else for(s=d[o=i-257],0<u[o]&&(s+=R(this,u[o])),i=N(this,t),r=f[i],0<p[i]&&(r+=R(this,p[i])),l<=a&&(this.b=a,n=this.e(),a=this.b);s--;)n[a]=n[a++-r];for(;8<=this.d;)this.d-=8,this.a--;this.b=a},i.prototype.w=function(e,t){var n=this.c,a=this.b;this.o=e;for(var i,o,r,s,l=n.length;256!==(i=N(this,e));)if(i<256)l<=a&&(l=(n=this.e()).length),n[a++]=i;else for(s=d[o=i-257],0<u[o]&&(s+=R(this,u[o])),i=N(this,t),r=f[i],0<p[i]&&(r+=R(this,p[i])),l<a+s&&(l=(n=this.e()).length);s--;)n[a]=n[a++-r];for(;8<=this.d;)this.d-=8,this.a--;this.b=a},i.prototype.e=function(){var e,t,n=new(T?Uint8Array:Array)(this.b-32768),a=this.b-32768,i=this.c;if(T)n.set(i.subarray(32768,n.length));else for(e=0,t=n.length;e<t;++e)n[e]=i[e+32768];if(this.g.push(n),this.l+=n.length,T)i.set(i.subarray(a,a+32768));else for(e=0;e<32768;++e)i[e]=i[a+e];return this.b=32768,i},i.prototype.z=function(e){var t,n,a,i=this.input.length/this.a+1|0,o=this.input,r=this.c;return e&&("number"==typeof e.p&&(i=e.p),"number"==typeof e.u&&(i+=e.u)),i<2?n=(a=(o.length-this.a)/this.o[2]/2*258|0)<r.length?r.length+a:r.length<<1:n=r.length*i,T?(t=new Uint8Array(n)).set(r):t=r,this.c=t},i.prototype.n=function(){var e,t,n,a,i,o=0,r=this.c,s=this.g,l=new(T?Uint8Array:Array)(this.l+(this.b-32768));if(0===s.length)return T?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(t=0,n=s.length;t<n;++t)for(a=0,i=(e=s[t]).length;a<i;++a)l[o++]=e[a];for(t=32768,n=this.b;t<n;++t)l[o++]=r[t];return this.g=[],this.buffer=l},i.prototype.v=function(){var e,t=this.b;return T?this.r?(e=new Uint8Array(t)).set(this.c.subarray(0,t)):e=this.c.subarray(0,t):(this.c.length>t&&(this.c.length=t),e=this.c),this.buffer=e},g.prototype.k=function(){var e,t,n=this.input;if(e=this.q.k(),this.a=this.q.a,this.A){t=(n[this.a++]<<24|n[this.a++]<<16|n[this.a++]<<8|n[this.a++])>>>0;var a=e;if("string"==typeof a){var i,o,r=a.split("");for(i=0,o=r.length;i<o;i++)r[i]=(255&r[i].charCodeAt(0))>>>0;a=r}for(var s,l=1,d=0,u=a.length,c=0;0<u;){for(u-=s=1024<u?1024:u;d+=l+=a[c++],--s;);l%=65521,d%=65521}if(t!==(d<<16|l)>>>0)throw Error("invalid adler-32 checksum")}return e};var A=8;e("Zlib.Inflate",g),e("Zlib.Inflate.prototype.decompress",g.prototype.k);var y,I,C,O,H={ADAPTIVE:t.s,BLOCK:t.t};if(Object.keys)y=Object.keys(H);else for(I in y=[],C=0,H)y[C++]=I;for(C=0,O=y.length;C<O;++C)e("Zlib.Inflate.BufferType."+(I=y[C]),H[I])}).call(this),function(){function g(e){var t,n=e.Content,a=e.RelativeFilename||e.Filename,i=a.slice(a.lastIndexOf(".")+1).toLowerCase();switch(i){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if("function"!=typeof THREE.TGALoader)return void console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");null===THREE.Loader.Handlers.get(".tga")&&THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader),t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"==typeof n)return"data:"+t+";base64,"+n;var o=new Uint8Array(n);return window.URL.createObjectURL(new Blob([o],{type:t}))}function A(e,t,n,a){var i=function(e,t,n,a){var i,o,r=t.path,s=a.get(e.id).children;void 0!==s&&0<s.length&&void 0!==n[s[0].ID]&&(0!==(i=n[s[0].ID]).indexOf("blob:")&&0!==i.indexOf("data:")||t.setPath(void 0));o="tga"===e.FileName.slice(-3).toLowerCase()?THREE.Loader.Handlers.get(".tga").load(i):t.load(i);return t.setPath(r),o}(e,t,n,a);i.ID=e.id,i.name=e.attrName;var o=e.WrapModeU,r=e.WrapModeV,s=void 0!==o?o.value:0,l=void 0!==r?r.value:0;if(i.wrapS=0===s?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,i.wrapT=0===l?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in e){var d=e.Scaling.value;i.repeat.x=d[0],i.repeat.y=d[1]}return i}function y(e,t,n,a){var i=t.id,o=t.attrName,r=t.ShadingModel;if("object"==typeof r&&(r=r.value),!a.has(i))return null;var s,l=function(n,e,a,t,i){var o={};e.BumpFactor&&(o.bumpScale=e.BumpFactor.value);e.Diffuse?o.color=(new THREE.Color).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(o.color=(new THREE.Color).fromArray(e.DiffuseColor.value));e.DisplacementFactor&&(o.displacementScale=e.DisplacementFactor.value);e.Emissive?o.emissive=(new THREE.Color).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(o.emissive=(new THREE.Color).fromArray(e.EmissiveColor.value));e.EmissiveFactor&&(o.emissiveIntensity=parseFloat(e.EmissiveFactor.value));e.Opacity&&(o.opacity=parseFloat(e.Opacity.value));o.opacity<1&&(o.transparent=!0);e.ReflectionFactor&&(o.reflectivity=e.ReflectionFactor.value);e.Shininess&&(o.shininess=e.Shininess.value);e.Specular?o.specular=(new THREE.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(o.specular=(new THREE.Color).fromArray(e.SpecularColor.value));return i.get(t).children.forEach(function(e){var t=e.relationship;switch(t){case"Bump":o.bumpMap=a.get(e.ID);break;case"DiffuseColor":o.map=d(n,a,e.ID,i);break;case"DisplacementColor":o.displacementMap=d(n,a,e.ID,i);break;case"EmissiveColor":o.emissiveMap=d(n,a,e.ID,i);break;case"NormalMap":o.normalMap=d(n,a,e.ID,i);break;case"ReflectionColor":o.envMap=d(n,a,e.ID,i),o.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":o.specularMap=d(n,a,e.ID,i);break;case"TransparentColor":o.alphaMap=d(n,a,e.ID,i),o.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",t)}}),o}(e,t,n,i,a);switch(r.toLowerCase()){case"phong":s=new THREE.MeshPhongMaterial;break;case"lambert":s=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),s=new THREE.MeshPhongMaterial({color:3342591})}return s.setValues(l),s.name=o,s}function d(e,t,n,a){return"LayeredTexture"in e.Objects&&n in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=a.get(n).children[0].ID),t.get(n)}function b(e,a){var i=[];return e.children.forEach(function(e){var t=a[e.ID];if("Cluster"===t.attrType){var n={ID:e.ID,indices:[],weights:[],transform:(new THREE.Matrix4).fromArray(t.Transform.a),transformLink:(new THREE.Matrix4).fromArray(t.TransformLink.a),linkMode:t.Mode};"Indexes"in t&&(n.indices=t.Indexes.a,n.weights=t.Weights.a),i.push(n)}}),{rawBones:i,bones:[]}}function T(e,t,n,a){for(var i=[],o=0;o<e.children.length;o++){if(8===o){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var r=e.children[o],s=n[r.ID],l={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;a.get(parseInt(r.ID)).children.forEach(function(e){"DeformPercent"===e.relationship?l.weightCurveID=e.ID:l.geoID=e.ID}),i.push(l)}return i}function x(e,t,n,a){switch(n.attrType){case"Mesh":return function(t,e,n,a){var i=a.skeletons,o=a.morphTargets,r=e.parents.map(function(e){return t.Objects.Model[e.ID]});if(0===r.length)return;var s=e.children.reduce(function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e},null),l=e.children.reduce(function(e,t){return void 0!==o[t.ID]&&(e=o[t.ID]),e},null),d=new THREE.Matrix4,u=r[0];if("GeometricRotation"in u){var c=u.GeometricRotation.value.map(THREE.Math.degToRad);c[3]="ZYX",d.makeRotationFromEuler((new THREE.Euler).fromArray(c))}"GeometricTranslation"in u&&d.setPosition((new THREE.Vector3).fromArray(u.GeometricTranslation.value));"GeometricScaling"in u&&d.scale((new THREE.Vector3).fromArray(u.GeometricScaling.value));return function(e,t,n,a,i){var o=new THREE.BufferGeometry;t.attrName&&(o.name=t.attrName);var r=function(e,t){var i={};i.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],i.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,a=e.Colors.a,i=[];"IndexToDirect"===n&&(i=e.ColorIndex.a);return{dataSize:4,buffer:a,indices:i,mappingType:t,referenceType:n}}(e.LayerElementColor[0]));e.LayerElementMaterial&&(i.material=function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};for(var a=e.Materials.a,i=[],o=0;o<a.length;++o)i.push(o);return{dataSize:1,buffer:a,indices:i,mappingType:t,referenceType:n}}(e.LayerElementMaterial[0]));e.LayerElementNormal&&(i.normal=function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,a=e.Normals.a,i=[];"IndexToDirect"===n&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a));return{dataSize:3,buffer:a,indices:i,mappingType:t,referenceType:n}}(e.LayerElementNormal[0]));if(e.LayerElementUV){i.uv=[];for(var n=0;e.LayerElementUV[n];)i.uv.push(S(e.LayerElementUV[n])),n++}i.weightTable={},null!==t&&(i.skeleton=t).rawBones.forEach(function(n,a){n.indices.forEach(function(e,t){void 0===i.weightTable[e]&&(i.weightTable[e]=[]),i.weightTable[e].push({id:a,weight:n.weights[t]})})});return i}(t,n),s=F(r),l=new THREE.Float32BufferAttribute(s.vertex,3);i.applyToBufferAttribute(l),o.addAttribute("position",l),0<s.colors.length&&o.addAttribute("color",new THREE.Float32BufferAttribute(s.colors,3));n&&(o.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(s.weightsIndices,4)),o.addAttribute("skinWeight",new THREE.Float32BufferAttribute(s.vertexWeights,4)),o.FBX_Deformer=n);if(0<s.normal.length){var d=new THREE.Float32BufferAttribute(s.normal,3),u=(new THREE.Matrix3).getNormalMatrix(i);u.applyToBufferAttribute(d),o.addAttribute("normal",d)}if(s.uvs.forEach(function(e,t){var n="uv"+(t+1).toString();0===t&&(n="uv"),o.addAttribute(n,new THREE.Float32BufferAttribute(s.uvs[t],2))}),r.material&&"AllSame"!==r.material.mappingType){var c=s.materialIndex[0],f=0;if(s.materialIndex.forEach(function(e,t){e!==c&&(o.addGroup(f,t-f,c),c=e,f=t)}),0<o.groups.length){var h=o.groups[o.groups.length-1],p=h.start+h.count;p!==s.materialIndex.length&&o.addGroup(p,s.materialIndex.length-p,c)}0===o.groups.length&&o.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return m=e,_=o,E=t,v=a,g=i,null!==v&&(_.morphAttributes.position=[],_.morphAttributes.normal=[],v.rawTargets.forEach(function(e){var t=m.Objects.Geometry[e.geoID];void 0!==t&&function(e,t,n,a){var i=new THREE.BufferGeometry;n.attrName&&(i.name=n.attrName);for(var o=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],r=void 0!==t.Vertices?t.Vertices.a.slice():[],s=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],d=0;d<l.length;d++){var u=3*l[d];r[u]+=s[3*d],r[u+1]+=s[3*d+1],r[u+2]+=s[3*d+2]}var c=F({vertexIndices:o,vertexPositions:r}),f=new THREE.Float32BufferAttribute(c.vertex,3);f.name=n.attrName,a.applyToBufferAttribute(f),e.morphAttributes.position.push(f)}(_,E,t,g)})),o;var m,_,E,v,g}(t,n,s,l,d)}(e,t,n,a);case"NurbsCurve":return function(e){if(void 0===THREE.NURBSCurve)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new THREE.BufferGeometry;for(var n,a,i=t-1,o=e.KnotVector.a,r=[],s=e.Points.a,l=0,d=s.length;l<d;l+=4)r.push((new THREE.Vector4).fromArray(s,l));if("Closed"===e.Form)r.push(r[0]);else if("Periodic"===e.Form){n=i,a=o.length-1-n;for(var l=0;l<i;++l)r.push(r[l])}var u=new THREE.NURBSCurve(i,o,r,n,a).getPoints(7*r.length),c=new Float32Array(3*u.length);u.forEach(function(e,t){e.toArray(c,3*t)});var f=new THREE.BufferGeometry;return f.addAttribute("position",new THREE.BufferAttribute(c,3)),f}(n)}}function F(u){var c={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},f=0,h=0,p=!1,m=[],_=[],E=[],v=[],g=[],A=[];return u.vertexIndices.forEach(function(a,i){var e=!1;a<0&&(a^=-1,e=!0);var n=[],t=[];if(m.push(3*a,3*a+1,3*a+2),u.color){var o=w(i,f,a,u.color);E.push(o[0],o[1],o[2])}if(u.skeleton){if(void 0!==u.weightTable[a]&&u.weightTable[a].forEach(function(e){t.push(e.weight),n.push(e.id)}),4<t.length){p||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),p=!0);var r=[0,0,0,0],s=[0,0,0,0];t.forEach(function(e,t){var i=e,o=n[t];s.forEach(function(e,t,n){if(e<i){n[t]=i,i=e;var a=r[t];r[t]=o,o=a}})}),n=r,t=s}for(;t.length<4;)t.push(0),n.push(0);for(var l=0;l<4;++l)g.push(t[l]),A.push(n[l])}if(u.normal){o=w(i,f,a,u.normal);_.push(o[0],o[1],o[2])}if(u.material&&"AllSame"!==u.material.mappingType)var d=w(i,f,a,u.material)[0];u.uv&&u.uv.forEach(function(e,t){var n=w(i,f,a,e);void 0===v[t]&&(v[t]=[]),v[t].push(n[0]),v[t].push(n[1])}),h++,e&&(!function(n,e,t,a,i,o,r,s,l,d){for(var u=2;u<d;u++)n.vertex.push(e.vertexPositions[t[0]]),n.vertex.push(e.vertexPositions[t[1]]),n.vertex.push(e.vertexPositions[t[2]]),n.vertex.push(e.vertexPositions[t[3*(u-1)]]),n.vertex.push(e.vertexPositions[t[3*(u-1)+1]]),n.vertex.push(e.vertexPositions[t[3*(u-1)+2]]),n.vertex.push(e.vertexPositions[t[3*u]]),n.vertex.push(e.vertexPositions[t[3*u+1]]),n.vertex.push(e.vertexPositions[t[3*u+2]]),e.skeleton&&(n.vertexWeights.push(s[0]),n.vertexWeights.push(s[1]),n.vertexWeights.push(s[2]),n.vertexWeights.push(s[3]),n.vertexWeights.push(s[4*(u-1)]),n.vertexWeights.push(s[4*(u-1)+1]),n.vertexWeights.push(s[4*(u-1)+2]),n.vertexWeights.push(s[4*(u-1)+3]),n.vertexWeights.push(s[4*u]),n.vertexWeights.push(s[4*u+1]),n.vertexWeights.push(s[4*u+2]),n.vertexWeights.push(s[4*u+3]),n.weightsIndices.push(l[0]),n.weightsIndices.push(l[1]),n.weightsIndices.push(l[2]),n.weightsIndices.push(l[3]),n.weightsIndices.push(l[4*(u-1)]),n.weightsIndices.push(l[4*(u-1)+1]),n.weightsIndices.push(l[4*(u-1)+2]),n.weightsIndices.push(l[4*(u-1)+3]),n.weightsIndices.push(l[4*u]),n.weightsIndices.push(l[4*u+1]),n.weightsIndices.push(l[4*u+2]),n.weightsIndices.push(l[4*u+3])),e.color&&(n.colors.push(o[0]),n.colors.push(o[1]),n.colors.push(o[2]),n.colors.push(o[3*(u-1)]),n.colors.push(o[3*(u-1)+1]),n.colors.push(o[3*(u-1)+2]),n.colors.push(o[3*u]),n.colors.push(o[3*u+1]),n.colors.push(o[3*u+2])),e.material&&"AllSame"!==e.material.mappingType&&(n.materialIndex.push(a),n.materialIndex.push(a),n.materialIndex.push(a)),e.normal&&(n.normal.push(i[0]),n.normal.push(i[1]),n.normal.push(i[2]),n.normal.push(i[3*(u-1)]),n.normal.push(i[3*(u-1)+1]),n.normal.push(i[3*(u-1)+2]),n.normal.push(i[3*u]),n.normal.push(i[3*u+1]),n.normal.push(i[3*u+2])),e.uv&&e.uv.forEach(function(e,t){void 0===n.uvs[t]&&(n.uvs[t]=[]),n.uvs[t].push(r[t][0]),n.uvs[t].push(r[t][1]),n.uvs[t].push(r[t][2*(u-1)]),n.uvs[t].push(r[t][2*(u-1)+1]),n.uvs[t].push(r[t][2*u]),n.uvs[t].push(r[t][2*u+1])})}(c,u,m,d,_,E,v,g,A,h),f++,h=0,m=[],_=[],E=[],v=[],g=[],A=[])}),c}function S(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,a=e.UV.a,i=[];return"IndexToDirect"===n&&(i=e.UVIndex.a),{dataSize:2,buffer:a,indices:i,mappingType:t,referenceType:n}}THREE.FBXLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},Object.assign(THREE.FBXLoader.prototype,{load:function(n,a,e,i){var o=this,r=THREE.LoaderUtils.extractUrlBase(n),t=new THREE.FileLoader(this.manager);t.setResponseType("arraybuffer"),t.load(n,function(e){try{var t=o.parse(e,r);a(t)}catch(e){window.setTimeout(function(){i&&i(e),o.manager.itemError(n)},0)}},e,i)},parse:function(e,t){var n,a,i;if(i="Kaydara FBX Binary  \0",(a=e).byteLength>=i.length&&i===k(a,0,i.length))n=(new U).parse(e);else{var o=k(e);if(!function(n){var e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],a=0;function t(e){var t=n[e-1];return n=n.slice(a+e),a++,t}for(var i=0;i<e.length;++i){var o=t(1);if(o===e[i])return!1}return!0}(o))throw new Error("THREE.FBXLoader: Unknown format.");if(X(o)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+X(o));n=(new H).parse(o)}var r,s,l,d,u,c,f,h,p=function(e){var r=new Map;if("Connections"in e){var t=e.Connections.connections;t.forEach(function(e){var t=e[0],n=e[1],a=e[2];r.has(t)||r.set(t,{parents:[],children:[]});var i={ID:n,relationship:a};r.get(t).parents.push(i),r.has(n)||r.set(n,{parents:[],children:[]});var o={ID:t,relationship:a};r.get(n).children.push(o)})}return r}(n),m=function(e){var t={},n={};if("Video"in e.Objects){var a=e.Objects.Video;for(var i in a){var o=a[i],r=parseInt(i);if(t[r]=o.RelativeFilename||o.Filename,"Content"in o){var s=o.Content instanceof ArrayBuffer&&0<o.Content.byteLength,l="string"==typeof o.Content&&""!==o.Content;if(s||l){var d=g(a[i]);n[o.RelativeFilename||o.Filename]=d}}}}for(var r in t){var u=t[r];void 0!==n[u]?t[r]=n[u]:t[r]=t[r].split("\\").pop()}return t}(n),_=function(e,t,n){var a=new Map;if("Material"in e.Objects){var i=e.Objects.Material;for(var o in i){var r=y(e,i[o],t,n);null!==r&&a.set(parseInt(o),r)}}return a}(n,function(e,t,n,a){var i=new Map;if("Texture"in e.Objects){var o=e.Objects.Texture;for(var r in o){var s=A(o[r],t,n,a);i.set(parseInt(r),s)}}return i}(n,new THREE.TextureLoader(this.manager).setPath(t),m,p),p),E=function(e,t){var n={},a={};if("Deformer"in e.Objects){var i=e.Objects.Deformer;for(var o in i){var r=i[o],s=t.get(parseInt(o));if("Skin"===r.attrType){var l=b(s,i);l.ID=o,1<s.parents.length&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=s.parents[0].ID,n[o]=l}else if("BlendShape"===r.attrType){var d={id:o};d.rawTargets=T(s,r,i,t),d.id=o,1<s.parents.length&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),d.parentGeoID=s.parents[0].ID,a[o]=d}}}return{skeletons:n,morphTargets:a}}(n,p),v=function(e,t,n){var a=new Map;if("Geometry"in e.Objects){var i=e.Objects.Geometry;for(var o in i){var r=t.get(parseInt(o)),s=x(e,r,i[o],n);a.set(parseInt(o),s)}}return a}(n,p,E);return r=n,s=p,l=E.skeletons,d=v,u=_,c=new THREE.Group,f=function(e,t,n,a,i){var o=new Map,r=e.Objects.Model;for(var s in r){var l=parseInt(s),d=r[s],u=i.get(l),c=P(u,t,l,d.attrName);if(!c){switch(d.attrType){case"Camera":c=L(e,u);break;case"Light":c=R(e,u);break;case"Mesh":c=N(e,u,n,a);break;case"NurbsCurve":c=I(u,n);break;case"LimbNode":case"Null":default:c=new THREE.Group}c.name=THREE.PropertyBinding.sanitizeNodeName(d.attrName),c.ID=l}C(e,c,d),o.set(l,c)}return o}(r,l,d,u,s),h=r.Objects.Model,f.forEach(function(n){var e=h[n.ID];!function(a,i,e,t,o){if("LookAtProperty"in e){var n=t.get(i.ID).children;n.forEach(function(e){if("LookAtProperty"===e.relationship){var t=a.Objects.Model[e.ID];if("Lcl_Translation"in t){var n=t.Lcl_Translation.value;void 0!==i.target?(i.target.position.fromArray(n),o.add(i.target)):i.lookAt((new THREE.Vector3).fromArray(n))}}})}}(r,n,e,s,c),s.get(n.ID).parents.forEach(function(e){var t=f.get(e.ID);void 0!==t&&t.add(n)}),null===n.parent&&c.add(n)}),function(e,t,a,i,o){var r=function(e){var t={};if("Pose"in e.Objects){var n=e.Objects.Pose;for(var a in n)if("BindPose"===n[a].attrType){var i=n[a].PoseNode;Array.isArray(i)?i.forEach(function(e){t[e.Node]=(new THREE.Matrix4).fromArray(e.Matrix.a)}):t[i.Node]=(new THREE.Matrix4).fromArray(i.Matrix.a)}}return t}(e);for(var n in t){var s=t[n],l=o.get(parseInt(s.ID)).parents;l.forEach(function(e){if(a.has(e.ID)){var t=e.ID,n=o.get(t);n.parents.forEach(function(e){if(i.has(e.ID)){var t=i.get(e.ID);t.bind(new THREE.Skeleton(s.bones),r[e.ID])}})}})}}(r,l,d,f,s),function(e,t,n){n.animations=[];var a=function(e,t){if(void 0!==e.Objects.AnimationCurve){var n=function(e){var t=e.Objects.AnimationCurveNode,n=new Map;for(var a in t){var i=t[a];if(null!==i.attrName.match(/S|R|T/)){var o={id:i.id,attr:i.attrName,curves:{}};n.set(o.id,o)}}return n}(e);!function(e,t,n){var a=e.Objects.AnimationCurve;for(var i in a){var o={id:a[i].id,times:a[i].KeyTime.a.map(M),values:a[i].KeyValueFloat.a},r=t.get(o.id);if(void 0!==r){var s=r.parents[0].ID,l=r.parents[0].relationship;l.match(/X/)?n.get(s).curves.x=o:l.match(/Y/)?n.get(s).curves.y=o:l.match(/Z/)&&(n.get(s).curves.z=o)}}}(e,t,n);var a=function(r,s,l){var e=r.Objects.AnimationLayer,t=new Map;for(var n in e){var d=[],a=s.get(parseInt(n));if(void 0!==a){var i=a.children;i.forEach(function(e,t){if(l.has(e.ID)){var n=l.get(e.ID);if(void 0!==n.curves.x||void 0!==n.curves.y||void 0!==n.curves.z){if(void 0===d[t]){var a;s.get(e.ID).parents.forEach(function(e){void 0!==e.relationship&&(a=e.ID)});var i=r.Objects.Model[a.toString()],o={modelName:THREE.PropertyBinding.sanitizeNodeName(i.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};"Lcl_Translation"in i&&(o.initialPosition=i.Lcl_Translation.value),"Lcl_Rotation"in i&&(o.initialRotation=i.Lcl_Rotation.value),"Lcl_Scaling"in i&&(o.initialScale=i.Lcl_Scaling.value),"PreRotation"in i&&(o.preRotations=i.PreRotation.value),d[t]=o}d[t][n.attr]=n}}}),t.set(parseInt(n),d)}}return t}(e,t,n);return function(e,t,n){var a=e.Objects.AnimationStack,i={};for(var o in a){var r=t.get(parseInt(o)).children;1<r.length&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var s=n.get(r[0].ID);i[o]={name:a[o].attrName,layer:s}}return i}(e,t,a)}}(e,t);if(void 0!==a)for(var i in a){var o=a[i],r=O(o);n.animations.push(r)}}(r,s,c),function(e,t){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var n=e.GlobalSettings.AmbientColor.value,a=n[0],i=n[1],o=n[2];if(0!==a||0!==i||0!==o){var r=new THREE.Color(a,i,o);t.add(new THREE.AmbientLight(r,1))}}}(r,c),c}});var s=[];function w(e,t,n,a){var i;switch(a.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=n;break;case"AllSame":i=a.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+a.mappingType)}"IndexToDirect"===a.referenceType&&(i=a.indices[i]);var o=i*a.dataSize,r=o+a.dataSize;return function(e,t,n,a){for(var i=n,o=0;i<a;i++,o++)e[o]=t[i];return e}(s,a.buffer,o,r)}function P(e,t,o,r){var s=null;return e.parents.forEach(function(a){for(var e in t){var i=t[e];i.rawBones.forEach(function(e,t){if(e.ID===a.ID){var n=s;(s=new THREE.Bone).matrixWorld.copy(e.transformLink),s.name=THREE.PropertyBinding.sanitizeNodeName(r),s.ID=o,i.bones[t]=s,null!==n&&s.add(n)}})}}),s}function L(n,e){var t,a;if(e.children.forEach(function(e){var t=n.Objects.NodeAttribute[e.ID];void 0!==t&&(a=t)}),void 0===a)t=new THREE.Object3D;else{var i=0;void 0!==a.CameraProjectionType&&1===a.CameraProjectionType.value&&(i=1);var o=1;void 0!==a.NearPlane&&(o=a.NearPlane.value/1e3);var r=1e3;void 0!==a.FarPlane&&(r=a.FarPlane.value/1e3);var s=window.innerWidth,l=window.innerHeight;void 0!==a.AspectWidth&&void 0!==a.AspectHeight&&(s=a.AspectWidth.value,l=a.AspectHeight.value);var d=s/l,u=45;void 0!==a.FieldOfView&&(u=a.FieldOfView.value);var c=a.FocalLength?a.FocalLength.value:null;switch(i){case 0:t=new THREE.PerspectiveCamera(u,d,o,r),null!==c&&t.setFocalLength(c);break;case 1:t=new THREE.OrthographicCamera(-s/2,s/2,l/2,-l/2,o,r);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),t=new THREE.Object3D}}return t}function R(n,e){var t,a;if(e.children.forEach(function(e){var t=n.Objects.NodeAttribute[e.ID];void 0!==t&&(a=t)}),void 0===a)t=new THREE.Object3D;else{var i;i=void 0===a.LightType?0:a.LightType.value;var o=16777215;void 0!==a.Color&&(o=(new THREE.Color).fromArray(a.Color.value));var r=void 0===a.Intensity?1:a.Intensity.value/100;void 0!==a.CastLightOnObject&&0===a.CastLightOnObject.value&&(r=0);var s=0;void 0!==a.FarAttenuationEnd&&(s=void 0!==a.EnableFarAttenuation&&0===a.EnableFarAttenuation.value?0:a.FarAttenuationEnd.value);switch(i){case 0:t=new THREE.PointLight(o,r,s,1);break;case 1:t=new THREE.DirectionalLight(o,r);break;case 2:var l=Math.PI/3;void 0!==a.InnerAngle&&(l=THREE.Math.degToRad(a.InnerAngle.value));var d=0;void 0!==a.OuterAngle&&(d=THREE.Math.degToRad(a.OuterAngle.value),d=Math.max(d,1)),t=new THREE.SpotLight(o,r,s,l,d,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+a.LightType.value+", defaulting to a THREE.PointLight."),t=new THREE.PointLight(o,r)}void 0!==a.CastShadows&&1===a.CastShadows.value&&(t.castShadow=!0)}return t}function N(e,t,n,a){var i,o=null,r=null,s=[];return t.children.forEach(function(e){n.has(e.ID)&&(o=n.get(e.ID)),a.has(e.ID)&&s.push(a.get(e.ID))}),1<s.length?r=s:0<s.length?r=s[0]:(r=new THREE.MeshPhongMaterial({color:13421772}),s.push(r)),"color"in o.attributes&&s.forEach(function(e){e.vertexColors=THREE.VertexColors}),o.FBX_Deformer?(s.forEach(function(e){e.skinning=!0}),i=new THREE.SkinnedMesh(o,r)):i=new THREE.Mesh(o,r),i}function I(e,n){var t=e.children.reduce(function(e,t){return n.has(t.ID)&&(e=n.get(t.ID)),e},null),a=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(t,a)}function C(e,t,n){if("RotationOrder"in n){var a=parseInt(n.RotationOrder.value,10);0<a&&a<6?console.warn("THREE.FBXLoader: unsupported Euler Order: %s. Currently only XYZ order is supported. Animations and rotations may be incorrect.",["XYZ","XZY","YZX","ZXY","YXZ","ZYX","SphericXYZ"][a]):6===a&&console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect.")}if("Lcl_Translation"in n&&t.position.fromArray(n.Lcl_Translation.value),"Lcl_Rotation"in n){var i=n.Lcl_Rotation.value.map(THREE.Math.degToRad);i.push("ZYX"),t.quaternion.setFromEuler((new THREE.Euler).fromArray(i))}if("Lcl_Scaling"in n&&t.scale.fromArray(n.Lcl_Scaling.value),"PreRotation"in n){var o=n.PreRotation.value.map(THREE.Math.degToRad);o[3]="ZYX";var r=(new THREE.Euler).fromArray(o);r=(new THREE.Quaternion).setFromEuler(r),t.quaternion.premultiply(r)}}function O(e){var t=[];return e.layer.forEach(function(e){t=t.concat(function(e){var t=[];if(void 0!==e.T&&0<Object.keys(e.T.curves).length){var n=o(e.modelName,e.T.curves,e.initialPosition,"position");void 0!==n&&t.push(n)}if(void 0!==e.R&&0<Object.keys(e.R.curves).length){var a=function(e,t,n,a){void 0!==t.x&&(f(t.x),t.x.values=t.x.values.map(THREE.Math.degToRad));void 0!==t.y&&(f(t.y),t.y.values=t.y.values.map(THREE.Math.degToRad));void 0!==t.z&&(f(t.z),t.z.values=t.z.values.map(THREE.Math.degToRad));var i=c(t),o=u(i,t,n);void 0!==a&&((a=a.map(THREE.Math.degToRad)).push("ZYX"),a=(new THREE.Euler).fromArray(a),a=(new THREE.Quaternion).setFromEuler(a));for(var r=new THREE.Quaternion,s=new THREE.Euler,l=[],d=0;d<o.length;d+=3)s.set(o[d],o[d+1],o[d+2],"ZYX"),r.setFromEuler(s),void 0!==a&&r.premultiply(a),r.toArray(l,d/3*4);return new THREE.QuaternionKeyframeTrack(e+".quaternion",i,l)}(e.modelName,e.R.curves,e.initialRotation,e.preRotations);void 0!==a&&t.push(a)}if(void 0!==e.S&&0<Object.keys(e.S.curves).length){var i=o(e.modelName,e.S.curves,e.initialScale,"scale");void 0!==i&&t.push(i)}return t}(e))}),new THREE.AnimationClip(e.name,-1,t)}function o(e,t,n,a){var i=c(t),o=u(i,t,n);return new THREE.VectorKeyframeTrack(e+"."+a,i,o)}function u(e,i,t){var o=t,r=[],s=-1,l=-1,d=-1;return e.forEach(function(e){if(i.x&&(s=i.x.times.indexOf(e)),i.y&&(l=i.y.times.indexOf(e)),i.z&&(d=i.z.times.indexOf(e)),-1!==s){var t=i.x.values[s];r.push(t),o[0]=t}else r.push(o[0]);if(-1!==l){var n=i.y.values[l];r.push(n),o[1]=n}else r.push(o[1]);if(-1!==d){var a=i.z.values[d];r.push(a),o[2]=a}else r.push(o[2])}),r}function c(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}).filter(function(e,t,n){return n.indexOf(e)==t})}function f(e){for(var t=1;t<e.values.length;t++){var n=e.values[t-1],a=e.values[t]-n,i=Math.abs(a);if(180<=i){for(var o=i/180,r=a/o,s=n+r,l=e.times[t-1],d=(e.times[t]-l)/o,u=l+d,c=[],f=[];u<e.times[t];)c.push(u),u+=d,f.push(s),s+=r;e.times=p(e.times,t,c),e.values=p(e.values,t,f)}}}function H(){}function U(){}function l(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function r(){}function X(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function M(e){return e/46186158e3}function h(e){return e.split(",").map(function(e){return parseFloat(e)})}function k(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(e,t,n))}function p(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}Object.assign(H.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new r,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var s=this,l=e.split("\n");return l.forEach(function(e,t){var n=e.match(/^[\s\t]*;/),a=e.match(/^[\s\t]*$/);if(!n&&!a){var i=e.match("^\\t{"+s.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+s.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),r=e.match("^\\t{"+(s.currentIndent-1)+"}}");i?s.parseNodeBegin(e,i):o?s.parseNodeProperty(e,o,l[++t]):r?s.popStack():e.match(/^[^\s\t}]/)&&s.parseNodePropertyContinued(e)}}),this.allNodes},parseNodeBegin:function(e,t){var n=t[1].trim().replace(/^"/,"").replace(/"$/,""),a=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),i={name:n},o=this.parseNodeAttr(a),r=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,i):n in r?("PoseNode"===n?r.PoseNode.push(i):void 0!==r[n].id&&(r[n]={},r[n][r[n].id]=r[n]),""!==o.id&&(r[n][o.id]=i)):"number"==typeof o.id?(r[n]={},r[n][o.id]=i):"Properties70"!==n&&(r[n]="PoseNode"===n?[i]:i),"number"==typeof o.id&&(i.id=o.id),""!==o.name&&(i.attrName=o.name),""!==o.type&&(i.attrType=o.type),this.pushStack(i)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var n="",a="";return 1<e.length&&(n=e[1].replace(/^(\w+)::/,""),a=e[2]),{id:t,name:n,type:a}},parseNodeProperty:function(e,t,n){var a=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===a&&","===i&&(i=n.replace(/"/g,"").replace(/,$/,"").trim());var o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===a){var r=i.split(",").slice(1),s=parseInt(r[0]),l=parseInt(r[1]),d=i.split(",").slice(3);a="connections",function(e,t){for(var n=0,a=e.length,i=t.length;n<i;n++,a++)e[a]=t[n]}(i=[s,l],d=d.map(function(e){return e.trim().replace(/^"/,"")})),void 0===o[a]&&(o[a]=[])}"Node"===a&&(o.id=i),a in o&&Array.isArray(o[a])?o[a].push(i):"a"!==a?o[a]=i:o.a=i,this.setCurrentProp(o,a),"a"===a&&","!==i.slice(-1)&&(o.a=h(i))}else this.parseNodeSpecialProperty(e,a,i)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=h(t.a))},parseNodeSpecialProperty:function(e,t,n){var a=n.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),i=a[0],o=a[1],r=a[2],s=a[3],l=a[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=h(l)}this.getPrevNode()[i]={type:o,type2:r,flag:s,value:l},this.setCurrentProp(this.getPrevNode(),i)}}),Object.assign(U.prototype,{parse:function(e){var t=new l(e);t.skip(23);var n=t.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+n);for(var a=new r;!this.endOfContent(t);){var i=this.parseNode(t,n);null!==i&&a.add(i.name,i)}return a},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var n={},a=7500<=t?e.getUint64():e.getUint32(),i=7500<=t?e.getUint64():e.getUint32(),o=(7500<=t?e.getUint64():e.getUint32(),e.getUint8()),r=e.getString(o);if(0===a)return null;for(var s=[],l=0;l<i;l++)s.push(this.parseProperty(e));var d=0<s.length?s[0]:"",u=1<s.length?s[1]:"",c=2<s.length?s[2]:"";for(n.singleProperty=1===i&&e.getOffset()===a;a>e.getOffset();){var f=this.parseNode(e,t);null!==f&&this.parseSubNode(r,n,f)}return n.propertyList=s,"number"==typeof d&&(n.id=d),""!==u&&(n.attrName=u),""!==c&&(n.attrType=c),""!==r&&(n.name=r),n},parseSubNode:function(e,t,n){if(!0===n.singleProperty){var a=n.propertyList[0];Array.isArray(a)?(t[n.name]=n).a=a:t[n.name]=a}else if("Connections"===e&&"C"===n.name){var i=[];n.propertyList.forEach(function(e,t){0!==t&&i.push(e)}),void 0===t.connections&&(t.connections=[]),t.connections.push(i)}else if("Properties70"===n.name){Object.keys(n).forEach(function(e){t[e]=n[e]})}else if("Properties70"===e&&"P"===n.name){var o,r=n.propertyList[0],s=n.propertyList[1],l=n.propertyList[2],d=n.propertyList[3];0===r.indexOf("Lcl ")&&(r=r.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),o="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[r]={type:s,type2:l,flag:d,value:o}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var n=e.getUint32();return e.getArrayBuffer(n);case"S":n=e.getUint32();return e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var a=e.getUint32(),i=e.getUint32(),o=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(a);case"d":return e.getFloat64Array(a);case"f":return e.getFloat32Array(a);case"i":return e.getInt32Array(a);case"l":return e.getInt64Array(a)}void 0===window.Zlib&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var r=new l(new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(o))).decompress().buffer);switch(t){case"b":case"c":return r.getBooleanArray(a);case"d":return r.getFloat64Array(a);case"f":return r.getFloat32Array(a);case"i":return r.getInt32Array(a);case"l":return r.getInt64Array(a)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}),Object.assign(l.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=new Uint8Array(e),n=0;n<e;n++)t[n]=this.getUint8();var a=t.indexOf(0);return 0<=a&&(t=t.slice(0,a)),THREE.LoaderUtils.decodeText(t)}}),Object.assign(r.prototype,{add:function(e,t){this[e]=t}})}(),THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},a=e.getDrawingBufferSize();(t=new THREE.WebGLRenderTarget(a.width,a.height,n)).texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),void 0===THREE.ShaderPass&&console.error("THREE.EffectComposer relies on THREE.ShaderPass"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getDrawingBufferSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,n,a=!1,i=this.passes.length;for(n=0;n<i;n++)if(!1!==(t=this.passes[n]).enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,a),t.needsSwap){if(a){var o=this.renderer.context;o.stencilFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),o.stencilFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?a=!0:t instanceof THREE.ClearMaskPass&&(a=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getDrawingBufferSize();(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var n=0;n<this.passes.length;n++)this.passes[n].setSize(e,t)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(e,t){},render:function(e,t,n,a,i){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),THREE.RenderPass=function(e,t,n,a,i){THREE.Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=a,this.clearAlpha=void 0!==i?i:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(e,t,n,a,i){var o,r,s=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(o=e.getClearColor().getHex(),r=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:n,this.clear),this.clearColor&&e.setClearColor(o,r),this.scene.overrideMaterial=null,e.autoClear=s}}),THREE.MaskPass=function(e,t){THREE.Pass.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.MaskPass,render:function(e,t,n,a,i){var o,r,s=e.context,l=e.state;l.buffers.color.setMask(!1),l.buffers.depth.setMask(!1),l.buffers.color.setLocked(!0),l.buffers.depth.setLocked(!0),this.inverse?(o=0,r=1):(o=1,r=0),l.buffers.stencil.setTest(!0),l.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),l.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),l.buffers.stencil.setClear(r),e.render(this.scene,this.camera,n,this.clear),e.render(this.scene,this.camera,t,this.clear),l.buffers.color.setLocked(!1),l.buffers.depth.setLocked(!1),l.buffers.stencil.setFunc(s.EQUAL,1,4294967295),l.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP)}}),THREE.ClearMaskPass=function(){THREE.Pass.call(this),this.needsSwap=!1},THREE.ClearMaskPass.prototype=Object.create(THREE.Pass.prototype),Object.assign(THREE.ClearMaskPass.prototype,{render:function(e,t,n,a,i){e.state.buffers.stencil.setTest(!1)}}),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,n,a,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immedates.","    // Immedates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")},THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.Sky=function(){var e=THREE.Sky.SkyShader,t=new THREE.ShaderMaterial({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:THREE.UniformsUtils.clone(e.uniforms),side:THREE.BackSide});THREE.Mesh.call(this,new THREE.SphereBufferGeometry(1,12,8),t)},THREE.Sky.prototype=Object.create(THREE.Mesh.prototype),THREE.Sky.SkyShader={uniforms:{luminance:{value:1},turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.003},mieDirectionalG:{value:.95},sunPosition:{value:new THREE.Vector3}},vertexShader:["uniform vec3 sunPosition;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float v = 4.0;","const vec3 K = vec3( 0.686, 0.678, 0.666 );","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const float EE = 1000.0;","float sunIntensity( float zenithAngleCos ) {","\tzenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );","}","vec3 totalMie( float T ) {","\tfloat c = ( 0.2 * T ) * 10E-18;","\treturn 0.434 * c * MieConst;","}","void main() {","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvWorldPosition = worldPosition.xyz;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tvSunDirection = normalize( sunPosition );","\tvSunE = sunIntensity( dot( vSunDirection, up ) );","\tvSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );","\tfloat rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );","\tvBetaR = totalRayleigh * rayleighCoefficient;","\tvBetaM = totalMie( turbidity ) * mieCoefficient;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","uniform float luminance;","uniform float mieDirectionalG;","const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float THREE_OVER_SIXTEENPI = 0.05968310365946075;","const float ONE_OVER_FOURPI = 0.07957747154594767;","float rayleighPhase( float cosTheta ) {","\treturn THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );","}","float hgPhase( float cosTheta, float g ) {","\tfloat g2 = pow( g, 2.0 );","\tfloat inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );","\treturn ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );","}","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap( vec3 x ) {","\treturn ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","void main() {","\tfloat zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );","\tfloat inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );","\tfloat sR = rayleighZenithLength * inverse;","\tfloat sM = mieZenithLength * inverse;","\tvec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );","\tfloat cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );","\tfloat rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );","\tvec3 betaRTheta = vBetaR * rPhase;","\tfloat mPhase = hgPhase( cosTheta, mieDirectionalG );","\tvec3 betaMTheta = vBetaM * mPhase;","\tvec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );","\tLin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );","\tvec3 direction = normalize( vWorldPosition - cameraPos );","\tfloat theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]","\tfloat phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]","\tvec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );","\tvec3 L0 = vec3( 0.1 ) * Fex;","\tfloat sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );","\tL0 += ( vSunE * 19000.0 * Fex ) * sundisk;","\tvec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );","\tvec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( luminance, 4.0 ) ) ) * texColor );","\tvec3 color = curr * whiteScale;","\tvec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );","\tgl_FragColor = vec4( retColor, 1.0 );","}"].join("\n")},THREE.OrbitControls=function(e,t){var n,a,i,o,r;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return p.phi},this.getAzimuthalAngle=function(){return p.theta},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(l),s.update(),f=c.NONE},this.update=(n=new THREE.Vector3,a=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),i=a.clone().inverse(),o=new THREE.Vector3,r=new THREE.Quaternion,function(){var e=s.object.position;return n.copy(e).sub(s.target),n.applyQuaternion(a),p.setFromVector3(n),s.autoRotate&&f===c.NONE&&L(2*Math.PI/60/60*s.autoRotateSpeed),p.theta+=m.theta,p.phi+=m.phi,p.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,p.theta)),p.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,p.phi)),p.makeSafe(),p.radius*=_,p.radius=Math.max(s.minDistance,Math.min(s.maxDistance,p.radius)),s.target.add(E),n.setFromSpherical(p),n.applyQuaternion(i),e.copy(s.target).add(n),s.object.lookAt(s.target),!0===s.enableDamping?(m.theta*=1-s.dampingFactor,m.phi*=1-s.dampingFactor):m.set(0,0,0),_=.7,E.set(0,0,0),!(!(v||o.distanceToSquared(s.object.position)>h||8*(1-r.dot(s.object.quaternion))>h)||(s.dispatchEvent(l),o.copy(s.object.position),r.copy(s.object.quaternion),v=!1))}),this.dispose=function(){s.domElement.removeEventListener("contextmenu",z,!1),s.domElement.removeEventListener("mousedown",k,!1),s.domElement.removeEventListener("wheel",Y,!1),s.domElement.removeEventListener("touchstart",V,!1),s.domElement.removeEventListener("touchend",G,!1),s.domElement.removeEventListener("touchmove",j,!1),document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",B,!1),window.removeEventListener("keydown",Q,!1)};var s=this,l={type:"change"},d={type:"start"},u={type:"end"},c={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},f=c.NONE,h=1e-6,p=new THREE.Spherical,m=new THREE.Spherical,_=1,E=new THREE.Vector3,v=!1,g=new THREE.Vector2,A=new THREE.Vector2,y=new THREE.Vector2,b=new THREE.Vector2,T=new THREE.Vector2,x=new THREE.Vector2,F=new THREE.Vector2,S=new THREE.Vector2,w=new THREE.Vector2;function P(){return Math.pow(.95,s.zoomSpeed)}function L(e){m.theta-=e}function R(e){m.phi-=e}var N,I,C,O=(N=new THREE.Vector3,function(e,t){N.setFromMatrixColumn(t,0),N.multiplyScalar(-e),E.add(N)}),H=(I=new THREE.Vector3,function(e,t){I.setFromMatrixColumn(t,1),I.multiplyScalar(e),E.add(I)}),U=(C=new THREE.Vector3,function(e,t){var n=s.domElement===document?s.domElement.body:s.domElement;if(s.object.isPerspectiveCamera){var a=s.object.position;C.copy(a).sub(s.target);var i=C.length();i*=Math.tan(s.object.fov/2*Math.PI/180),O(2*e*i/n.clientHeight,s.object.matrix),H(2*t*i/n.clientHeight,s.object.matrix)}else s.object.isOrthographicCamera?(O(e*(s.object.right-s.object.left)/s.object.zoom/n.clientWidth,s.object.matrix),H(t*(s.object.top-s.object.bottom)/s.object.zoom/n.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)});function X(e){s.object.isPerspectiveCamera?_/=e:s.object.isOrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom*e)),s.object.updateProjectionMatrix(),v=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function M(e){s.object.isPerspectiveCamera?_*=e:s.object.isOrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/e)),s.object.updateProjectionMatrix(),v=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function k(e){if(!1!==s.enabled){switch(e.preventDefault(),e.button){case s.mouseButtons.ORBIT:if(!1===s.enableRotate)return;a=e,g.set(a.clientX,a.clientY),f=c.ROTATE;break;case s.mouseButtons.ZOOM:if(!1===s.enableZoom)return;n=e,F.set(n.clientX,n.clientY),f=c.DOLLY;break;case s.mouseButtons.PAN:if(!1===s.enablePan)return;t=e,b.set(t.clientX,t.clientY),f=c.PAN}var t,n,a;f!==c.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",B,!1),s.dispatchEvent(d))}}function D(e){var t,n;if(!1!==s.enabled)switch(e.preventDefault(),f){case c.ROTATE:if(!1===s.enableRotate)return;!function(e){A.set(e.clientX,e.clientY),y.subVectors(A,g);var t=s.domElement===document?s.domElement.body:s.domElement;L(2*Math.PI*y.x/t.clientWidth*s.rotateSpeed),R(2*Math.PI*y.y/t.clientHeight*s.rotateSpeed),g.copy(A),s.update()}(e);break;case c.DOLLY:if(!1===s.enableZoom)return;n=e,S.set(n.clientX,n.clientY),w.subVectors(S,F),0<w.y?X(P()):w.y<0&&M(P()),F.copy(S),s.update();break;case c.PAN:if(!1===s.enablePan)return;t=e,T.set(t.clientX,t.clientY),x.subVectors(T,b),U(x.x,x.y),b.copy(T),s.update()}}function B(e){!1!==s.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",B,!1),s.dispatchEvent(u),f=c.NONE)}function Y(e){var t;!1===s.enabled||!1===s.enableZoom||f!==c.NONE&&f!==c.ROTATE||(e.preventDefault(),s.dispatchEvent(d),(t=e).deltaY<0?M(P()):0<t.deltaY&&X(P()),s.update(),s.dispatchEvent(u))}function Q(e){!1!==s.enabled&&!1!==s.enableKeys&&!1!==s.enablePan&&function(e){switch(e.keyCode){case s.keys.UP:U(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:U(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:U(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:U(-s.keyPanSpeed,0),s.update()}}(e)}function V(e){if(!1!==s.enabled){switch(e.touches.length){case 1:if(!1===s.enableRotate)return;r=e,g.set(r.touches[0].pageX,r.touches[0].pageY),f=c.TOUCH_ROTATE;break;case 2:if(!1===s.enableZoom)return;a=(n=e).touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY,o=Math.sqrt(a*a+i*i),F.set(0,o),f=c.TOUCH_DOLLY;break;case 3:if(!1===s.enablePan)return;t=e,b.set(t.touches[0].pageX,t.touches[0].pageY),f=c.TOUCH_PAN;break;default:f=c.NONE}var t,n,a,i,o,r;f!==c.NONE&&s.dispatchEvent(d)}}function j(e){var t,n,a,i,o;if(!1!==s.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===s.enableRotate)return;if(f!==c.TOUCH_ROTATE)return;!function(e){A.set(e.touches[0].pageX,e.touches[0].pageY),y.subVectors(A,g);var t=s.domElement===document?s.domElement.body:s.domElement;L(2*Math.PI*y.x/t.clientWidth*s.rotateSpeed),R(2*Math.PI*y.y/t.clientHeight*s.rotateSpeed),g.copy(A),s.update()}(e);break;case 2:if(!1===s.enableZoom)return;if(f!==c.TOUCH_DOLLY)return;a=(n=e).touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY,o=Math.sqrt(a*a+i*i),S.set(0,o),w.subVectors(S,F),0<w.y?M(P()):w.y<0&&X(P()),F.copy(S),s.update();break;case 3:if(!1===s.enablePan)return;if(f!==c.TOUCH_PAN)return;t=e,T.set(t.touches[0].pageX,t.touches[0].pageY),x.subVectors(T,b),U(x.x,x.y),b.copy(T),s.update();break;default:f=c.NONE}}function G(e){!1!==s.enabled&&(s.dispatchEvent(u),f=c.NONE)}function z(e){!1!==s.enabled&&e.preventDefault()}s.domElement.addEventListener("contextmenu",z,!1),s.domElement.addEventListener("mousedown",k,!1),s.domElement.addEventListener("wheel",Y,!1),s.domElement.addEventListener("touchstart",V,!1),s.domElement.addEventListener("touchend",G,!1),s.domElement.addEventListener("touchmove",j,!1),window.addEventListener("keydown",Q,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,n,a;t=void 0!==(e=e||{}).parent?e.parent:document.body,n=void 0!==e.id?e.id:"oldie",(a=Detector.getWebGLErrorMessage()).id=n,t.appendChild(a)}};"object"==typeof module&&(module.exports=Detector);var Stats=function(){var n=0,a=document.createElement("div");function e(e){return a.appendChild(e.dom),e}function t(e){for(var t=0;t<a.children.length;t++)a.children[t].style.display=t===e?"block":"none";n=e}a.classList.add("statsBox"),a.addEventListener("click",function(e){e.preventDefault(),t(++n%a.children.length)},!1);var i=(performance||Date).now(),o=i,r=0,s=e(new Stats.Panel("FPS","#0ff","#002")),l=e(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var d=e(new Stats.Panel("MB","#f08","#201"));return t(0),{REVISION:16,dom:a,addPanel:e,showPanel:t,begin:function(){i=(performance||Date).now()},end:function(){r++;var e=(performance||Date).now();if(l.update(e-i,200),o+1e3<e&&(s.update(1e3*r/(e-o),100),o=e,r=0,d)){var t=performance.memory;d.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){i=this.end()},domElement:a,setMode:t}};function SimulatorBase(e){this.frameTime=1/e,this.offset=0,this.cache=[]}function BounceSimulator(e,t,n){SimulatorBase.call(this,e),this.position=0,this.velocity=0,this.target=0,this.mass=t,this.damping=n}function BounceVSimulator(e,t,n){SimulatorBase.call(this,e),this.position=new THREE.Vector3,this.velocity=new THREE.Vector3,this.target=new THREE.Vector3,this.mass=t,this.damping=n}function RotationSimulator(e,t,n){SimulatorBase.call(this,e),this.position=0,this.velocity=0,this.target=0,this.mass=t,this.damping=n,this.lastLerp=0}Stats.Panel=function(n,a,i){var o=1/0,r=0,s=Math.round,l=s(window.devicePixelRatio||1),d=80*l,e=48*l,u=3*l,c=2*l,f=3*l,h=15*l,p=74*l,m=30*l,_=document.createElement("canvas");_.width=d,_.height=e,_.style.cssText="width:80px;height:48px";var E=_.getContext("2d");return E.font="bold "+9*l+"px Helvetica,Arial,sans-serif",E.textBaseline="top",E.fillStyle=i,E.fillRect(0,0,d,e),E.fillStyle=a,E.fillText(n,u,c),E.fillRect(f,h,p,m),E.fillStyle=i,E.globalAlpha=.9,E.fillRect(f,h,p,m),{dom:_,update:function(e,t){o=Math.min(o,e),r=Math.max(r,e),E.fillStyle=i,E.globalAlpha=1,E.fillRect(0,0,d,h),E.fillStyle=a,E.fillText(s(e)+" "+n+" ("+s(o)+"-"+s(r)+")",u,c),E.drawImage(_,f+l,h,p-l,m,f,h,p-l,m),E.fillRect(f+p-l,h,l,m),E.fillStyle=i,E.globalAlpha=.9,E.fillRect(f+p-l,h,l,s((1-e/t)*m))}}},function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.dat=t()}(this,function(){"use strict";function t(e,t){var n=e.__state.conversionName.toString(),a=Math.round(e.r),i=Math.round(e.g),o=Math.round(e.b),r=e.a,s=Math.round(e.h),l=e.s.toFixed(1),d=e.v.toFixed(1);if(t||"THREE_CHAR_HEX"===n||"SIX_CHAR_HEX"===n){for(var u=e.hex.toString(16);u.length<6;)u="0"+u;return"#"+u}return"CSS_RGB"===n?"rgb("+a+","+i+","+o+")":"CSS_RGBA"===n?"rgba("+a+","+i+","+o+","+r+")":"HEX"===n?"0x"+e.hex.toString(16):"RGB_ARRAY"===n?"["+a+","+i+","+o+"]":"RGBA_ARRAY"===n?"["+a+","+i+","+o+","+r+"]":"RGB_OBJ"===n?"{r:"+a+",g:"+i+",b:"+o+"}":"RGBA_OBJ"===n?"{r:"+a+",g:"+i+",b:"+o+",a:"+r+"}":"HSV_OBJ"===n?"{h:"+s+",s:"+l+",v:"+d+"}":"HSVA_OBJ"===n?"{h:"+s+",s:"+l+",v:"+d+",a:"+r+"}":"unknown format"}var r=Array.prototype.forEach,a=Array.prototype.slice,m={BREAK:{},extend:function(n){return this.each(a.call(arguments,1),function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(e){this.isUndefined(t[e])||(n[e]=t[e])}.bind(this))},this),n},defaults:function(n){return this.each(a.call(arguments,1),function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(e){this.isUndefined(n[e])&&(n[e]=t[e])}.bind(this))},this),n},compose:function(){var n=a.call(arguments);return function(){for(var e=a.call(arguments),t=n.length-1;0<=t;t--)e=[n[t].apply(this,e)];return e[0]}},each:function(e,t,n){if(e)if(r&&e.forEach&&e.forEach===r)e.forEach(t,n);else if(e.length===e.length+0){var a,i=void 0;for(i=0,a=e.length;i<a;i++)if(i in e&&t.call(n,e[i],i)===this.BREAK)return}else for(var o in e)if(t.call(n,e[o],o)===this.BREAK)return},defer:function(e){setTimeout(e,0)},debounce:function(a,i,o){var r=void 0;return function(){var e=this,t=arguments;var n=o||!r;clearTimeout(r),r=setTimeout(function(){r=null,o||a.apply(e,t)},i),n&&a.apply(e,t)}},toArray:function(e){return e.toArray?e.toArray():a.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(e){return isNaN(e)}),isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)}},e=[{litmus:m.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:t},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:t},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:t},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:t}}},{litmus:m.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:m.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:m.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(m.isNumber(e.r)&&m.isNumber(e.g)&&m.isNumber(e.b)&&m.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(m.isNumber(e.r)&&m.isNumber(e.g)&&m.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(m.isNumber(e.h)&&m.isNumber(e.s)&&m.isNumber(e.v)&&m.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(m.isNumber(e.h)&&m.isNumber(e.s)&&m.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],i=void 0,o=void 0,_=function(){o=!1;var n=1<arguments.length?m.toArray(arguments):arguments[0];return m.each(e,function(e){if(e.litmus(n))return m.each(e.conversions,function(e,t){if(i=e.read(n),!1===o&&!1!==i)return(o=i).conversionName=t,i.conversion=e,m.BREAK}),m.BREAK}),o},s=void 0,l={hsv_to_rgb:function(e,t,n){var a=Math.floor(e/60)%6,i=e/60-Math.floor(e/60),o=n*(1-t),r=n*(1-i*t),s=n*(1-(1-i)*t),l=[[n,s,o],[r,n,o],[o,n,s],[o,r,n],[s,o,n],[n,o,r]][a];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(e,t,n){var a=Math.min(e,t,n),i=Math.max(e,t,n),o=i-a,r=void 0;return 0===i?{h:NaN,s:0,v:0}:(r=e===i?(t-n)/o:t===i?2+(n-e)/o:4+(e-t)/o,(r/=6)<0&&(r+=1),{h:360*r,s:o/i,v:i/255})},rgb_to_hex:function(e,t,n){var a=this.hex_with_component(0,2,e);return a=this.hex_with_component(a,1,t),a=this.hex_with_component(a,0,n)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(e,t,n){return n<<(s=8*t)|e&~(255<<s)}},d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},u=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),f=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,a)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(a):void 0},n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},v=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},g=function(){function e(){if(E(this,e),this.__state=_.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return u(e,[{key:"toString",value:function(){return t(this)}},{key:"toHexString",value:function(){return t(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),e}();function c(e,t,n){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space||g.recalculateRGB(this,t,n),this.__state[t]},set:function(e){"RGB"!==this.__state.space&&(g.recalculateRGB(this,t,n),this.__state.space="RGB"),this.__state[t]=e}})}function h(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space||g.recalculateHSV(this),this.__state[t]},set:function(e){"HSV"!==this.__state.space&&(g.recalculateHSV(this),this.__state.space="HSV"),this.__state[t]=e}})}g.recalculateRGB=function(e,t,n){if("HEX"===e.__state.space)e.__state[t]=l.component_from_hex(e.__state.hex,n);else{if("HSV"!==e.__state.space)throw new Error("Corrupted color state");m.extend(e.__state,l.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}},g.recalculateHSV=function(e){var t=l.rgb_to_hsv(e.r,e.g,e.b);m.extend(e.__state,{s:t.s,v:t.v}),m.isNaN(t.h)?m.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=t.h},g.COMPONENTS=["r","g","b","h","s","v","hex","a"],c(g.prototype,"r",2),c(g.prototype,"g",1),c(g.prototype,"b",0),h(g.prototype,"h"),h(g.prototype,"s"),h(g.prototype,"v"),Object.defineProperty(g.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(g.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=l.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var A=function(){function n(e,t){E(this,n),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return u(n,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),n}(),p={};m.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(e,t){m.each(e,function(e){p[e]=t})});var y=/(\d+(\.\d+)?)px/;function b(e){if("0"===e||m.isUndefined(e))return 0;var t=e.match(y);return m.isNull(t)?0:parseFloat(t[1])}var T={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,n){var a=n,i=t;m.isUndefined(i)&&(i=!0),m.isUndefined(a)&&(a=!0),e.style.position="absolute",i&&(e.style.left=0,e.style.right=0),a&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,n,a){var i=n||{},o=p[t];if(!o)throw new Error("Event type "+t+" not supported.");var r=document.createEvent(o);switch(o){case"MouseEvents":var s=i.x||i.clientX||0,l=i.y||i.clientY||0;r.initMouseEvent(t,i.bubbles||!1,i.cancelable||!0,window,i.clickCount||1,0,0,s,l,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var d=r.initKeyboardEvent||r.initKeyEvent;m.defaults(i,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),d(t,i.bubbles||!1,i.cancelable,window,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.keyCode,i.charCode);break;default:r.initEvent(t,i.bubbles||!1,i.cancelable||!0)}m.defaults(r,a),e.dispatchEvent(r)},bind:function(e,t,n,a){var i=a||!1;return e.addEventListener?e.addEventListener(t,n,i):e.attachEvent&&e.attachEvent("on"+t,n),T},unbind:function(e,t,n,a){var i=a||!1;return e.removeEventListener?e.removeEventListener(t,n,i):e.detachEvent&&e.detachEvent("on"+t,n),T},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var n=e.className.split(/ +/);-1===n.indexOf(t)&&(n.push(t),e.className=n.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return T},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var n=e.className.split(/ +/),a=n.indexOf(t);-1!==a&&(n.splice(a,1),e.className=n.join(" "))}else e.className=void 0;return T},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return b(t["border-left-width"])+b(t["border-right-width"])+b(t["padding-left"])+b(t["padding-right"])+b(t.width)},getHeight:function(e){var t=getComputedStyle(e);return b(t["border-top-width"])+b(t["border-bottom-width"])+b(t["padding-top"])+b(t["padding-bottom"])+b(t.height)},getOffset:function(e){var t=e,n={left:0,top:0};if(t.offsetParent)for(;n.left+=t.offsetLeft,n.top+=t.offsetTop,t=t.offsetParent;);return n},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},x=function(e){function i(e,t){E(this,i);var n=v(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t)),a=n;return n.__prev=n.getValue(),n.__checkbox=document.createElement("input"),n.__checkbox.setAttribute("type","checkbox"),T.bind(n.__checkbox,"change",function(){a.setValue(!a.__prev)},!1),n.domElement.appendChild(n.__checkbox),n.updateDisplay(),n}return n(i,A),u(i,[{key:"setValue",value:function(e){var t=f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),t}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"updateDisplay",this).call(this)}}]),i}(),F=function(e){function s(e,t,n){E(this,s);var a=v(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=n,o=a;if(a.__select=document.createElement("select"),m.isArray(i)){var r={};m.each(i,function(e){r[e]=e}),i=r}return m.each(i,function(e,t){var n=document.createElement("option");n.innerHTML=t,n.setAttribute("value",e),o.__select.appendChild(n)}),a.updateDisplay(),T.bind(a.__select,"change",function(){var e=this.options[this.selectedIndex].value;o.setValue(e)}),a.domElement.appendChild(a.__select),a}return n(s,A),u(s,[{key:"setValue",value:function(e){var t=f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),t}},{key:"updateDisplay",value:function(){return T.isActive(this.__select)?this:(this.__select.value=this.getValue(),f(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this))}}]),s}(),S=function(e){function o(e,t){E(this,o);var n=v(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,t)),a=n;function i(){a.setValue(a.__input.value)}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),T.bind(n.__input,"keyup",i),T.bind(n.__input,"change",i),T.bind(n.__input,"blur",function(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}),T.bind(n.__input,"keydown",function(e){13===e.keyCode&&this.blur()}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return n(o,A),u(o,[{key:"updateDisplay",value:function(){return T.isActive(this.__input)||(this.__input.value=this.getValue()),f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this)}}]),o}();function w(e){var t=e.toString();return-1<t.indexOf(".")?t.length-t.indexOf(".")-1:0}var P=function(e){function o(e,t,n){E(this,o);var a=v(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,t)),i=n||{};return a.__min=i.min,a.__max=i.max,a.__step=i.step,m.isUndefined(a.__step)?0===a.initialValue?a.__impliedStep=1:a.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(a.initialValue))/Math.LN10))/10:a.__impliedStep=a.__step,a.__precision=w(a.__impliedStep),a}return n(o,A),u(o,[{key:"setValue",value:function(e){var t=e;return void 0!==this.__min&&t<this.__min?t=this.__min:void 0!==this.__max&&t>this.__max&&(t=this.__max),void 0!==this.__step&&t%this.__step!=0&&(t=Math.round(t/this.__step)*this.__step),f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"setValue",this).call(this,t)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=w(e),this}}]),o}();var L=function(e){function d(e,t,n){E(this,d);var a=v(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,e,t,n));a.__truncationSuspended=!1;var i=a,o=void 0;function r(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}function s(e){var t=o-e.clientY;i.setValue(i.getValue()+t*i.__impliedStep),o=e.clientY}function l(){T.unbind(window,"mousemove",s),T.unbind(window,"mouseup",l),r()}return a.__input=document.createElement("input"),a.__input.setAttribute("type","text"),T.bind(a.__input,"change",function(){var e=parseFloat(i.__input.value);m.isNaN(e)||i.setValue(e)}),T.bind(a.__input,"blur",function(){r()}),T.bind(a.__input,"mousedown",function(e){T.bind(window,"mousemove",s),T.bind(window,"mouseup",l),o=e.clientY}),T.bind(a.__input,"keydown",function(e){13===e.keyCode&&(i.__truncationSuspended=!0,this.blur(),i.__truncationSuspended=!1,r())}),a.updateDisplay(),a.domElement.appendChild(a.__input),a}return n(d,P),u(d,[{key:"updateDisplay",value:function(){var e,t,n;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),t=this.__precision,n=Math.pow(10,t),Math.round(e*n)/n),f(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"updateDisplay",this).call(this)}}]),d}();function R(e,t,n,a,i){return a+(e-t)/(n-t)*(i-a)}var N=function(e){function c(e,t,n,a,i){E(this,c);var o=v(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e,t,{min:n,max:a,step:i})),r=o;function s(e){e.preventDefault();var t=r.__background.getBoundingClientRect();return r.setValue(R(e.clientX,t.left,t.right,r.__min,r.__max)),!1}function l(){T.unbind(window,"mousemove",s),T.unbind(window,"mouseup",l),r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}function d(e){var t=e.touches[0].clientX,n=r.__background.getBoundingClientRect();r.setValue(R(t,n.left,n.right,r.__min,r.__max))}function u(){T.unbind(window,"touchmove",d),T.unbind(window,"touchend",u),r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}return o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),T.bind(o.__background,"mousedown",function(e){document.activeElement.blur(),T.bind(window,"mousemove",s),T.bind(window,"mouseup",l),s(e)}),T.bind(o.__background,"touchstart",function(e){if(1!==e.touches.length)return;T.bind(window,"touchmove",d),T.bind(window,"touchend",u),d(e)}),T.addClass(o.__background,"slider"),T.addClass(o.__foreground,"slider-fg"),o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return n(c,P),u(c,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",f(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"updateDisplay",this).call(this)}}]),c}(),I=function(e){function o(e,t,n){E(this,o);var a=v(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,t)),i=a;return a.__button=document.createElement("div"),a.__button.innerHTML=void 0===n?"Fire":n,T.bind(a.__button,"click",function(e){return e.preventDefault(),i.fire(),!1}),T.addClass(a.__button,"button"),a.domElement.appendChild(a.__button),a}return n(o,A),u(o,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),o}(),C=function(e){function p(e,t){E(this,p);var n=v(this,(p.__proto__||Object.getPrototypeOf(p)).call(this,e,t));n.__color=new g(n.getValue()),n.__temp=new g(0);var s=n;n.domElement=document.createElement("div"),T.makeSelectable(n.domElement,!1),n.__selector=document.createElement("div"),n.__selector.className="selector",n.__saturation_field=document.createElement("div"),n.__saturation_field.className="saturation-field",n.__field_knob=document.createElement("div"),n.__field_knob.className="field-knob",n.__field_knob_border="2px solid ",n.__hue_knob=document.createElement("div"),n.__hue_knob.className="hue-knob",n.__hue_field=document.createElement("div"),n.__hue_field.className="hue-field",n.__input=document.createElement("input"),n.__input.type="text",n.__input_textShadow="0 1px 1px ",T.bind(n.__input,"keydown",function(e){13===e.keyCode&&u.call(this)}),T.bind(n.__input,"blur",u),T.bind(n.__selector,"mousedown",function(){T.addClass(this,"drag").bind(window,"mouseup",function(){T.removeClass(s.__selector,"drag")})}),T.bind(n.__selector,"touchstart",function(){T.addClass(this,"drag").bind(window,"touchend",function(){T.removeClass(s.__selector,"drag")})});var a,i=document.createElement("div");function o(e){f(e),T.bind(window,"mousemove",f),T.bind(window,"touchmove",f),T.bind(window,"mouseup",l),T.bind(window,"touchend",l)}function r(e){h(e),T.bind(window,"mousemove",h),T.bind(window,"touchmove",h),T.bind(window,"mouseup",d),T.bind(window,"touchend",d)}function l(){T.unbind(window,"mousemove",f),T.unbind(window,"touchmove",f),T.unbind(window,"mouseup",l),T.unbind(window,"touchend",l),c()}function d(){T.unbind(window,"mousemove",h),T.unbind(window,"touchmove",h),T.unbind(window,"mouseup",d),T.unbind(window,"touchend",d),c()}function u(){var e=_(this.value);!1!==e?(s.__color.__state=e,s.setValue(s.__color.toOriginal())):this.value=s.__color.toString()}function c(){s.__onFinishChange&&s.__onFinishChange.call(s,s.__color.toOriginal())}function f(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=s.__saturation_field.getBoundingClientRect(),n=e.touches&&e.touches[0]||e,a=n.clientX,i=n.clientY,o=(a-t.left)/(t.right-t.left),r=1-(i-t.top)/(t.bottom-t.top);return 1<r?r=1:r<0&&(r=0),1<o?o=1:o<0&&(o=0),s.__color.v=r,s.__color.s=o,s.setValue(s.__color.toOriginal()),!1}function h(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=s.__hue_field.getBoundingClientRect(),n=1-((e.touches&&e.touches[0]||e).clientY-t.top)/(t.bottom-t.top);return 1<n?n=1:n<0&&(n=0),s.__color.h=360*n,s.setValue(s.__color.toOriginal()),!1}return m.extend(n.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),m.extend(n.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:n.__field_knob_border+(n.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),m.extend(n.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),m.extend(n.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),m.extend(i.style,{width:"100%",height:"100%",background:"none"}),H(i,"top","rgba(0,0,0,0)","#000"),m.extend(n.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(a=n.__hue_field).style.background="",a.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",a.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",m.extend(n.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:n.__input_textShadow+"rgba(0,0,0,0.7)"}),T.bind(n.__saturation_field,"mousedown",o),T.bind(n.__saturation_field,"touchstart",o),T.bind(n.__field_knob,"mousedown",o),T.bind(n.__field_knob,"touchstart",o),T.bind(n.__hue_field,"mousedown",r),T.bind(n.__hue_field,"touchstart",r),n.__saturation_field.appendChild(i),n.__selector.appendChild(n.__field_knob),n.__selector.appendChild(n.__saturation_field),n.__selector.appendChild(n.__hue_field),n.__hue_field.appendChild(n.__hue_knob),n.domElement.appendChild(n.__input),n.domElement.appendChild(n.__selector),n.updateDisplay(),n}return n(p,A),u(p,[{key:"updateDisplay",value:function(){var t=_(this.getValue());if(!1!==t){var n=!1;m.each(g.COMPONENTS,function(e){if(!m.isUndefined(t[e])&&!m.isUndefined(this.__color.__state[e])&&t[e]!==this.__color.__state[e])return n=!0,{}},this),n&&m.extend(this.__color.__state,t)}m.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var e=this.__color.v<.5||.5<this.__color.s?255:0,a=255-e;m.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+e+","+e+","+e+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,H(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),m.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+e+","+e+","+e+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}}]),p}(),O=["-moz-","-o-","-webkit-","-ms-",""];function H(t,n,a,i){t.style.background="",m.each(O,function(e){t.style.cssText+="background: "+e+"linear-gradient("+n+", "+a+" 0%, "+i+" 100%); "})}var U=function(e,t){var n=e[t];return m.isArray(arguments[2])||m.isObject(arguments[2])?new F(e,t,arguments[2]):m.isNumber(n)?m.isNumber(arguments[2])&&m.isNumber(arguments[3])?m.isNumber(arguments[4])?new N(e,t,arguments[2],arguments[3],arguments[4]):new N(e,t,arguments[2],arguments[3]):m.isNumber(arguments[4])?new L(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new L(e,t,{min:arguments[2],max:arguments[3]}):m.isString(n)?new S(e,t):m.isFunction(n)?new I(e,t,""):m.isBoolean(n)?new x(e,t):null};var X=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},M=function(){function t(){E(this,t),this.backgroundElement=document.createElement("div"),m.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),T.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),m.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;T.bind(this.backgroundElement,"click",function(){e.hide()})}return u(t,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),m.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,e=function e(){t.domElement.style.display="none",t.backgroundElement.style.display="none",T.unbind(t.domElement,"webkitTransitionEnd",e),T.unbind(t.domElement,"transitionend",e),T.unbind(t.domElement,"oTransitionEnd",e)};T.bind(this.domElement,"webkitTransitionEnd",e),T.bind(this.domElement,"transitionend",e),T.bind(this.domElement,"oTransitionEnd",e),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-T.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-T.getHeight(this.domElement)/2+"px"}}]),t}(),k="Default",D=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}(),B=void 0,Y=!0,Q=void 0,V=!1,j=[],G=function t(e){var n=this,a=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),T.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],a=m.defaults(a,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),a=m.defaults(a,{resizable:a.autoPlace,hideable:a.autoPlace}),m.isUndefined(a.load)?a.load={preset:k}:a.preset&&(a.load.preset=a.preset),m.isUndefined(a.parent)&&a.hideable&&j.push(this),a.resizable=m.isUndefined(a.parent)&&a.resizable,a.autoPlace&&m.isUndefined(a.scrollable)&&(a.scrollable=!0);var i,o=D&&"true"===localStorage.getItem(J(this,"isLocal")),r=void 0;if(Object.defineProperties(this,{parent:{get:function(){return a.parent}},scrollable:{get:function(){return a.scrollable}},autoPlace:{get:function(){return a.autoPlace}},closeOnTop:{get:function(){return a.closeOnTop}},preset:{get:function(){return n.parent?n.getRoot().preset:a.load.preset},set:function(e){n.parent?n.getRoot().preset=e:a.load.preset=e,function(e){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].value===e.preset&&(e.__preset_select.selectedIndex=t)}(this),n.revert()}},width:{get:function(){return a.width},set:function(e){a.width=e,te(n,e)}},name:{get:function(){return a.name},set:function(e){a.name=e,titleRowName&&(titleRowName.innerHTML=a.name)}},closed:{get:function(){return a.closed},set:function(e){a.closed=e,a.closed?T.addClass(n.__ul,t.CLASS_CLOSED):T.removeClass(n.__ul,t.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=e?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return a.load}},useLocalStorage:{get:function(){return o},set:function(e){D&&((o=e)?T.bind(window,"unload",r):T.unbind(window,"unload",r),localStorage.setItem(J(n,"isLocal"),e))}}}),m.isUndefined(a.parent)){if(a.closed=!1,T.addClass(this.domElement,t.CLASS_MAIN),T.makeSelectable(this.domElement,!1),D&&o){n.useLocalStorage=!0;var s=localStorage.getItem(J(this,"gui"));s&&(a.load=JSON.parse(s))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,T.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),a.closeOnTop?(T.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(T.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),T.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{void 0===a.closed&&(a.closed=!0);var l=document.createTextNode(a.name);T.addClass(l,"controller-name");var d=z(n,l);T.addClass(this.__ul,t.CLASS_CLOSED),T.addClass(d,"title"),T.bind(d,"click",function(e){return e.preventDefault(),n.closed=!n.closed,!1}),a.closed||(this.closed=!1)}a.autoPlace&&(m.isUndefined(a.parent)&&(Y&&(Q=document.createElement("div"),T.addClass(Q,"dg"),T.addClass(Q,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(Q),Y=!1),Q.appendChild(this.domElement),T.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||te(n,a.width)),this.__resizeHandler=function(){n.onResizeDebounced()},T.bind(window,"resize",this.__resizeHandler),T.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),T.bind(this.__ul,"transitionend",this.__resizeHandler),T.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),a.resizable&&function(t){var n=void 0;function a(e){return e.preventDefault(),t.width+=n-e.clientX,t.onResize(),n=e.clientX,!1}function i(){T.removeClass(t.__closeButton,G.CLASS_DRAG),T.unbind(window,"mousemove",a),T.unbind(window,"mouseup",i)}function e(e){return e.preventDefault(),n=e.clientX,T.addClass(t.__closeButton,G.CLASS_DRAG),T.bind(window,"mousemove",a),T.bind(window,"mouseup",i),!1}t.__resize_handle=document.createElement("div"),m.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),T.bind(t.__resize_handle,"mousedown",e),T.bind(t.__closeButton,"mousedown",e),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}(this),r=function(){D&&"true"===localStorage.getItem(J(n,"isLocal"))&&localStorage.setItem(J(n,"gui"),JSON.stringify(n.getSaveObject()))},this.saveToLocalStorageIfPossible=r,a.parent||((i=n.getRoot()).width+=1,m.defer(function(){i.width-=1}))};function z(e,t,n){var a=document.createElement("li");return t&&a.appendChild(t),n?e.__ul.insertBefore(a,n):e.__ul.appendChild(a),e.onResize(),a}function W(e){T.unbind(window,"resize",e.__resizeHandler),e.saveToLocalStorageIfPossible&&T.unbind(window,"unload",e.saveToLocalStorageIfPossible)}function Z(e,t){var n=e.__preset_select[e.__preset_select.selectedIndex];n.innerHTML=t?n.value+"*":n.value}function K(e,t){var n=e.getRoot(),a=n.__rememberedObjects.indexOf(t.object);if(-1!==a){var i=n.__rememberedObjectIndecesToControllers[a];if(void 0===i&&(i={},n.__rememberedObjectIndecesToControllers[a]=i),i[t.property]=t,n.load&&n.load.remembered){var o=n.load.remembered,r=void 0;if(o[e.preset])r=o[e.preset];else{if(!o[k])return;r=o[k]}if(r[a]&&void 0!==r[a][t.property]){var s=r[a][t.property];t.initialValue=s,t.setValue(s)}}}}function q(e,t,n,a){if(void 0===t[n])throw new Error('Object "'+t+'" has no property "'+n+'"');var i=void 0;if(a.color)i=new C(t,n);else{var o=[t,n].concat(a.factoryArgs);i=U.apply(e,o)}a.before instanceof A&&(a.before=a.before.__li),K(e,i),T.addClass(i.domElement,"c");var r=document.createElement("span");T.addClass(r,"property-name"),r.innerHTML=i.property;var s=document.createElement("div");s.appendChild(r),s.appendChild(i.domElement);var l=z(e,s,a.before);return T.addClass(l,G.CLASS_CONTROLLER_ROW),i instanceof C?T.addClass(l,"color"):T.addClass(l,d(i.getValue())),function(i,t,o){if(o.__li=t,o.__gui=i,m.extend(o,{options:function(e){if(1<arguments.length){var t=o.__li.nextElementSibling;return o.remove(),q(i,o.object,o.property,{before:t,factoryArgs:[m.toArray(arguments)]})}if(m.isArray(e)||m.isObject(e)){var n=o.__li.nextElementSibling;return o.remove(),q(i,o.object,o.property,{before:n,factoryArgs:[e]})}},name:function(e){return o.__li.firstElementChild.firstElementChild.innerHTML=e,o},listen:function(){return o.__gui.listen(o),o},remove:function(){return o.__gui.remove(o),o}}),o instanceof N){var a=new L(o.object,o.property,{min:o.__min,max:o.__max,step:o.__step});m.each(["updateDisplay","onChange","onFinishChange","step"],function(e){var t=o[e],n=a[e];o[e]=a[e]=function(){var e=Array.prototype.slice.call(arguments);return n.apply(a,e),t.apply(o,e)}}),T.addClass(t,"has-slider"),o.domElement.insertBefore(a.domElement,o.domElement.firstElementChild)}else if(o instanceof L){var e=function(e){if(m.isNumber(o.__min)&&m.isNumber(o.__max)){var t=o.__li.firstElementChild.firstElementChild.innerHTML,n=-1<o.__gui.__listening.indexOf(o);o.remove();var a=q(i,o.object,o.property,{before:o.__li.nextElementSibling,factoryArgs:[o.__min,o.__max,o.__step]});return a.name(t),n&&a.listen(),a}return e};o.min=m.compose(e,o.min),o.max=m.compose(e,o.max)}else o instanceof x?(T.bind(t,"click",function(){T.fakeEvent(o.__checkbox,"click")}),T.bind(o.__checkbox,"click",function(e){e.stopPropagation()})):o instanceof I?(T.bind(t,"click",function(){T.fakeEvent(o.__button,"click")}),T.bind(t,"mouseover",function(){T.addClass(o.__button,"hover")}),T.bind(t,"mouseout",function(){T.removeClass(o.__button,"hover")})):o instanceof C&&(T.addClass(t,"color"),o.updateDisplay=m.compose(function(e){return t.style.borderLeftColor=o.__color.toString(),e},o.updateDisplay),o.updateDisplay());o.setValue=m.compose(function(e){return i.getRoot().__preset_select&&o.isModified()&&Z(i.getRoot(),!0),e},o.setValue)}(e,l,i),e.__controllers.push(i),i}function J(e,t){return document.location.href+"."+t}function $(e,t,n){var a=document.createElement("option");a.innerHTML=t,a.value=t,e.__preset_select.appendChild(a),n&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function ee(e,t){t.style.display=e.useLocalStorage?"block":"none"}function te(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function ne(i,o){var r={};return m.each(i.__rememberedObjects,function(e,t){var n={},a=i.__rememberedObjectIndecesToControllers[t];m.each(a,function(e,t){n[t]=o?e.initialValue:e.getValue()}),r[t]=n}),r}return G.toggleHide=function(){V=!V,m.each(j,function(e){e.domElement.style.display=V?"none":""})},G.CLASS_AUTO_PLACE="a",G.CLASS_AUTO_PLACE_CONTAINER="ac",G.CLASS_MAIN="main",G.CLASS_CONTROLLER_ROW="cr",G.CLASS_TOO_TALL="taller-than-window",G.CLASS_CLOSED="closed",G.CLASS_CLOSE_BUTTON="close-button",G.CLASS_CLOSE_TOP="close-top",G.CLASS_CLOSE_BOTTOM="close-bottom",G.CLASS_DRAG="drag",G.DEFAULT_WIDTH=245,G.TEXT_CLOSED="Close Controls",G.TEXT_OPEN="Open Controls",G._keydownHandler=function(e){"text"===document.activeElement.type||72!==e.which&&72!==e.keyCode||G.toggleHide()},T.bind(window,"keydown",G._keydownHandler,!1),m.extend(G.prototype,{add:function(e,t){return q(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return q(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;m.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&Q.removeChild(this.domElement);var t=this;m.each(this.__folders,function(e){t.removeFolder(e)}),T.unbind(window,"keydown",G._keydownHandler,!1),W(this)},addFolder:function(e){if(void 0!==this.__folders[e])throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var n=new G(t);this.__folders[e]=n;var a=z(this,n.domElement);return T.addClass(a,"folder"),n},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],W(t);var e=this;m.each(t.__folders,function(e){t.removeFolder(e)}),m.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=T.getOffset(t.__ul).top,n=0;m.each(t.__ul.childNodes,function(e){t.autoPlace&&e===t.__save_row||(n+=T.getHeight(e))}),window.innerHeight-e-20<n?(T.addClass(t.domElement,G.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-20+"px"):(T.removeClass(t.domElement,G.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&m.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:m.debounce(function(){this.onResize()},50),remember:function(){if(m.isUndefined(B)&&((B=new M).domElement.innerHTML='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>'),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;m.each(Array.prototype.slice.call(arguments),function(e){0===t.__rememberedObjects.length&&function(n){var e=n.__save_row=document.createElement("li");T.addClass(n.domElement,"has-save"),n.__ul.insertBefore(e,n.__ul.firstChild),T.addClass(e,"save-row");var t=document.createElement("span");t.innerHTML="&nbsp;",T.addClass(t,"button gears");var a=document.createElement("span");a.innerHTML="Save",T.addClass(a,"button"),T.addClass(a,"save");var i=document.createElement("span");i.innerHTML="New",T.addClass(i,"button"),T.addClass(i,"save-as");var o=document.createElement("span");o.innerHTML="Revert",T.addClass(o,"button"),T.addClass(o,"revert");var r=n.__preset_select=document.createElement("select");n.load&&n.load.remembered?m.each(n.load.remembered,function(e,t){$(n,t,t===n.preset)}):$(n,k,!1);if(T.bind(r,"change",function(){for(var e=0;e<n.__preset_select.length;e++)n.__preset_select[e].innerHTML=n.__preset_select[e].value;n.preset=this.value}),e.appendChild(r),e.appendChild(t),e.appendChild(a),e.appendChild(i),e.appendChild(o),D){var s=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage"),d=document.getElementById("dg-save-locally");d.style.display="block","true"===localStorage.getItem(J(n,"isLocal"))&&l.setAttribute("checked","checked"),ee(n,s),T.bind(l,"change",function(){n.useLocalStorage=!n.useLocalStorage,ee(n,s)})}var u=document.getElementById("dg-new-constructor");T.bind(u,"keydown",function(e){!e.metaKey||67!==e.which&&67!==e.keyCode||B.hide()}),T.bind(t,"click",function(){u.innerHTML=JSON.stringify(n.getSaveObject(),void 0,2),B.show(),u.focus(),u.select()}),T.bind(a,"click",function(){n.save()}),T.bind(i,"click",function(){var e=prompt("Enter a new preset name.");e&&n.saveAs(e)}),T.bind(o,"click",function(){n.revert()})}(t),-1===t.__rememberedObjects.indexOf(e)&&t.__rememberedObjects.push(e)}),this.autoPlace&&te(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var n=this.load;return n.closed=this.closed,0<this.__rememberedObjects.length&&(n.preset=this.preset,n.remembered||(n.remembered={}),n.remembered[this.preset]=ne(this)),n.folders={},m.each(this.__folders,function(e,t){n.folders[t]=e.getSaveObject()}),n},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=ne(this),Z(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[k]=ne(this,!0)),this.load.remembered[e]=ne(this),this.preset=e,$(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(t){m.each(this.__controllers,function(e){this.getRoot().load.remembered?K(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),m.each(this.__folders,function(e){e.revert(e)}),t||Z(this.getRoot(),!1)},listen:function(e){var t=0===this.__listening.length;this.__listening.push(e),t&&function e(t){0!==t.length&&X.call(window,function(){e(t)});m.each(t,function(e){e.updateDisplay()})}(this.__listening)},updateDisplay:function(){m.each(this.__controllers,function(e){e.updateDisplay()}),m.each(this.__folders,function(e){e.updateDisplay()})}}),{color:{Color:g,math:l,interpret:_},controllers:{Controller:A,BooleanController:x,OptionController:F,StringController:S,NumberController:P,NumberControllerBox:L,NumberControllerSlider:N,FunctionController:I,ColorController:C},dom:{dom:T},gui:{GUI:G},GUI:G}}),SimulatorBase.prototype.setFPS=function(e){this.frameTime=1/e},SimulatorBase.prototype.lastFrame=function(){return this.cache[this.cache.length-1]},BounceSimulator.prototype=Object.create(SimulatorBase.prototype),BounceSimulator.prototype.simulate=function(e){null==e&&console.log("Pass the timeStep!"),this.generateFrames(e),this.position=THREE.Math.lerp(this.cache[0].position,this.cache[1].position,this.offset/this.frameTime),this.velocity=THREE.Math.lerp(this.cache[0].velocity,this.cache[1].velocity,this.offset/this.frameTime)},BounceSimulator.prototype.generateFrames=function(e){if(0==this.cache.length)for(var t=0;t<2;t++)this.cache.push({position:0,velocity:0});var n=this.offset+e,a=Math.floor(n/this.frameTime);if(this.offset=n%this.frameTime,0<a){for(t=0;t<a;t++)this.cache.push(this.getFrame());this.cache=this.cache.slice(-2)}},BounceSimulator.prototype.getFrame=function(){return bounce(this.lastFrame().position,this.target,this.lastFrame().velocity,this.mass,this.damping)},BounceVSimulator.prototype=Object.create(SimulatorBase.prototype),BounceVSimulator.prototype.simulate=function(e){null==e&&console.log("Pass the timeStep!"),this.generateFrames(e),this.position.lerpVectors(this.cache[0].position,this.cache[1].position,this.offset/this.frameTime),this.velocity.lerpVectors(this.cache[0].velocity,this.cache[1].velocity,this.offset/this.frameTime)},BounceVSimulator.prototype.generateFrames=function(e){if(0==this.cache.length)for(var t=0;t<2;t++)this.cache.push({position:new THREE.Vector3,velocity:new THREE.Vector3});var n=this.offset+e,a=Math.floor(n/this.frameTime);if(this.offset=n%this.frameTime,0<a){for(t=0;t<a;t++)this.cache.push(this.getFrame());this.cache=this.cache.slice(-2)}},BounceVSimulator.prototype.getFrame=function(){var e={position:this.lastFrame().position.clone(),velocity:this.lastFrame().velocity.clone()};return bounceV(e.position,this.target,e.velocity,this.mass,this.damping),e},RotationSimulator.prototype=Object.create(SimulatorBase.prototype),RotationSimulator.prototype.simulate=function(e){null==e&&console.log("Pass the timeStep!"),this.generateFrames(e);var t=THREE.Math.lerp(0,this.cache[1].position,this.offset/this.frameTime);this.position=t-this.lastLerp,this.lastLerp=t,this.velocity=THREE.Math.lerp(this.cache[0].velocity,this.cache[1].velocity,this.offset/this.frameTime)},RotationSimulator.prototype.generateFrames=function(e){if(0==this.cache.length)for(var t=0;t<2;t++)this.cache.push({position:0,velocity:0});var n=this.offset+e,a=Math.floor(n/this.frameTime);if(this.offset=n%this.frameTime,0<a){for(t=0;t<a;t++)this.cache.push(this.getFrame(t+1==a));this.cache=this.cache.slice(-2)}},RotationSimulator.prototype.getFrame=function(e){var t=Object.assign({},this.lastFrame());return e&&(t.position=0,this.lastLerp=this.lastLerp-this.lastFrame().position),bounce(t.position,this.target,t.velocity,this.mass,this.damping)};var CharStates={};function getMoveDirections(){var e=controls.right.value?-1:0,t=controls.left.value?1:0,n=controls.up.value?1:0,a=controls.down.value?-1:0,i=new THREE.Vector3(e+t,0,n+a),o=new THREE.Vector3(camera.position.x,0,camera.position.z),r=new THREE.Vector3(player.position.x,0,player.position.z),s=(new THREE.Vector3).subVectors(r,o).normalize(),l=new THREE.Vector3(s.z,0,-s.x).normalize();return s.multiplyScalar(i.z),l.multiplyScalar(i.x),(new THREE.Vector3).addVectors(s,l).normalize()}function noDirection(){return!(controls.up.value||controls.down.value||controls.left.value||controls.right.value)}function anyDirection(){return controls.up.value||controls.down.value||controls.left.value||controls.right.value}function getDefaultState(){return Object.assign({},CharStates.defaultState)}function getMoveSpeed(e){return 3*e}function Character(){THREE.Object3D.call(this);var e=new THREE.Mesh(new THREE.BoxGeometry(.5,1,.5),new THREE.MeshLambertMaterial({color:16777215}));e.position.set(0,.5,0),e.castShadow=!0,this.visuals=new THREE.Group,this.add(this.visuals),this.visuals.conteiner=new THREE.Group,this.visuals.conteiner.position.set(0,-.5,0),this.visuals.add(this.visuals.conteiner),this.visuals.model=e,this.visuals.conteiner.add(e),this.mixer=new THREE.AnimationMixer(this.visuals),this.acceleration=0,this.velocity=0,this.velocityTarget=0,this.velocitySimulator=new BounceSimulator(60,80,.8),this.angularVelocity=0,this.orientation=new THREE.Vector3(0,0,1),this.orientationTarget=new THREE.Vector3(0,0,1),this.rotationSimulator=new RotationSimulator(60,100,.9),this.charState=CharStates.defaultState}function bounce(e,t,n,a,i){var o=t-e;return n+=o/=a,{position:e+=n*=i,velocity:n}}function bounceV(e,t,n,a,i){var o=(new THREE.Vector3).subVectors(t,e);o.divideScalar(a),n.add(o),n.multiplyScalar(i),e.add(n)}CharStates.defaultState={init:function(e){},update:function(e,t){},changeState:function(e){}},CharStates.Idle=getDefaultState(),CharStates.Idle.init=function(e){e.setAnimation("idle",.3),e.orientationTarget=e.orientation},CharStates.Idle.update=function(e,t){e.velocityTarget=0,e.update(t)},CharStates.Idle.changeState=function(e){controls.lastControl.isDirection()&&e.setState(CharStates.Start)},CharStates.Walk=getDefaultState(),CharStates.Walk.init=function(e){e.setAnimation("run",.1),e.velocitySimulator.mass=100,noDirection()&&e.setState(CharStates.End)},CharStates.Walk.update=function(e,t){e.orientationTarget=getMoveDirections(),e.velocityTarget=.8,e.update(t)},CharStates.Walk.changeState=function(e){noDirection()&&e.setState(CharStates.End)},CharStates.Start=getDefaultState(),CharStates.Start.init=function(e){var t=e.setAnimation("start_forward",.1);CharStates.Start.time=t,CharStates.Start.timer=0,e.velocitySimulator.mass=60},CharStates.Start.update=function(e,t){CharStates.Start.timer+=t,CharStates.Start.timer>CharStates.Start.time-t&&e.setState(CharStates.Walk),e.setOrientationTarget(getMoveDirections()),e.velocityTarget=.8,e.update(t)},CharStates.Start.changeState=function(e){noDirection()&&e.setState(CharStates.End)},CharStates.End=getDefaultState(),CharStates.End.init=function(e){var t=e.setAnimation("stop",.1);CharStates.End.time=t,CharStates.End.timer=0,e.orientationTarget=e.orientation,e.velocitySimulator.mass=120},CharStates.End.update=function(e,t){CharStates.End.timer+=t,CharStates.End.timer>CharStates.End.time-t&&e.setState(CharStates.Idle),e.velocityTarget=0,e.update(t)},CharStates.End.changeState=function(e){anyDirection()&&e.setState(CharStates.Start)},Character.prototype=Object.create(THREE.Object3D.prototype),Character.prototype.setModel=function(e){this.visuals.conteiner.remove(this.visuals.model),this.visuals.model=e,this.visuals.conteiner.add(e),this.mixer=new THREE.AnimationMixer(e)},Character.prototype.setState=function(e){(this.charState=e).init(this)},Character.prototype.setOrientationTarget=function(e){0==e.x&&0==e.y&&0==e.z||(this.orientationTarget=e)},Character.prototype.update=function(e,t){null==t&&(t={}),null==t.bounceRotation&&(t.bounceRotation=!0),null==t.bounceVelocity&&(t.bounceVelocity=!0),null==t.rotateModel&&(t.rotateModel=!0),null==t.updateAnimation&&(t.updateAnimation=!0),t.bounceRotation&&this.bounceMovement(e),t.bounceVelocity&&this.bounceRotation(e),t.rotateModel&&this.rotateModel(),t.updateAnimation&&this.mixer.update(e)},Character.prototype.setAnimation=function(e,t){var n=this.visuals.model.animations,a=THREE.AnimationClip.findByName(n,e),i=this.mixer.clipAction(a);return this.mixer.stopAllAction(),i.fadeIn(t),i.play(),i._clip.duration},Character.prototype.bounceMovement=function(e){this.velocitySimulator.target=this.velocityTarget,this.velocitySimulator.simulate(e),this.velocity=this.velocitySimulator.position,this.position.add((new THREE.Vector3).copy(this.orientation).multiplyScalar(this.velocity*getMoveSpeed(e))),this.acceleration=this.velocitySimulator.velocity},Character.prototype.bounceRotation=function(e){var t=new THREE.Vector3(0,1,0),n=this.orientation.normalize().dot(this.orientationTarget.normalize());if(.9995<n)angle=0;else if(n<-.9995)angle=Math.PI/2;else{angle=Math.acos(n);var a=(new THREE.Vector3).crossVectors(this.orientation,this.orientationTarget);t.dot(a)<0&&(angle=-angle)}this.rotationSimulator.target=angle,this.rotationSimulator.simulate(e);var i=this.rotationSimulator.position;this.orientation.applyAxisAngle(t,i),this.angularVelocity=this.rotationSimulator.velocity,sphere3.position.copy((new THREE.Vector3).copy(this.orientation).add(player.position).multiplyScalar(1))},Character.prototype.rotateModel=function(){this.visuals.lookAt(this.orientation.x,this.visuals.position.y,this.orientation.z),this.visuals.rotateX(3*this.acceleration),this.visuals.rotateZ(2.3*-this.angularVelocity),this.visuals.position.setY(Math.cos(Math.abs(2.3*this.angularVelocity))/2)};var keymap={w:{action:"up"},s:{action:"down"},a:{action:"left"},d:{action:"right"}," ":{action:"jump"},e:{action:"use"},mouse0:{action:"primary"},mouse2:{action:"secondary"},mouse1:{action:"tertiary"}};function Control(){this.value=!1,this.justPressed=!1,this.justReleased=!1}Control.prototype.isDirection=function(){return this==controls.up||this==controls.down||this==controls.left||this==controls.right};var controls={up:new Control,down:new Control,left:new Control,right:new Control,run:new Control,jump:new Control,use:new Control,primary:new Control,secondary:new Control,tertiary:new Control,lastControl:new Control};function keyDown(e){"c"==e.key?cameraCycle():"r"==e.key?controls.run.value=!controls.run.value:handleKey(e,e.key,!0)}function keyUp(e){handleKey(e,e.key,!1)}function mouseDown(e){handleKey(e,"mouse"+e.button,!0)}function mouseUp(e){handleKey(e,"mouse"+e.button,!1)}function handleKey(e,t,n){if((t=t.toLowerCase())in keymap){var a=controls[keymap[t].action];(a.value=n)?a.justPressed=!0:a.justReleased=!0,controls.lastControl=a,player.charState.changeState(player),a.justPressed=!1,a.justReleased=!1,e.preventDefault()}}document.addEventListener("keydown",keyDown,!1),document.addEventListener("keyup",keyUp,!1),document.addEventListener("mousedown",mouseDown,!1),document.addEventListener("mouseup",mouseUp,!1),document.addEventListener("wheel",mouseWheel,!1);var timeScaleBottomLimit=.003,timeScaleChangeSpeed=1.3,timeScaleTarget=1;function mouseWheel(e){0<e.deltaY?(timeScaleTarget/=timeScaleChangeSpeed)<timeScaleBottomLimit&&(timeScaleTarget=0):((timeScaleTarget*=timeScaleChangeSpeed)<timeScaleBottomLimit&&(timeScaleTarget=timeScaleBottomLimit),timeScaleTarget=Math.min(timeScaleTarget,9999999999),.9<params.Time_Scale&&(params.Time_Scale*=timeScaleChangeSpeed))}function cameraCycle(){}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),effectFXAA.uniforms.resolution.value.set(1/(window.innerWidth*dpr),1/(window.innerHeight*dpr)),composer.setSize(window.innerWidth*dpr,window.innerHeight*dpr)}Detector.webgl||Detector.addGetWebGLMessage(),renderer=new THREE.WebGLRenderer,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize,!1);var stats=new Stats;function ParamGUI(e){var t=new dat.GUI;t.add(e,"FPS_Limit",0,60);var n=t.add(e,"Time_Scale",0,1).listen(),a=t.add(e,"Shadows");t.add(e,"FXAA"),t.add(e,"Auto_Rotate");var i=t.add(e,"Bounce_Debug");t.open(),n.onChange(function(e){timeScaleTarget=e}),i.onChange(function(e){e?(sphere.visible=!0,sphere2.visible=!0,sphere3.visible=!0):(sphere.visible=!1,sphere2.visible=!1,sphere3.visible=!1)}),a.onChange(function(e){dirLight.castShadow=!!e})}document.body.appendChild(stats.dom);var scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(80,window.innerWidth/window.innerHeight,.1,120),renderScene=new THREE.RenderPass(scene,camera),dpr=1;void 0!==window.devicePixelRatio&&(dpr=window.devicePixelRatio);var effectFXAA=new THREE.ShaderPass(THREE.FXAAShader);effectFXAA.uniforms.resolution.value.set(1/(window.innerWidth*dpr),1/(window.innerHeight*dpr)),effectFXAA.renderToScreen=!0;var composer=new THREE.EffectComposer(renderer);composer.setSize(window.innerWidth*dpr,window.innerHeight*dpr),composer.addPass(renderScene),composer.addPass(effectFXAA);var sky=new THREE.Sky;sky.scale.setScalar(100),scene.add(sky);var sun=new THREE.Vector3,theta=-.3*Math.PI,phi=2*Math.PI*-.25;sun.x=Math.cos(phi),sun.y=Math.sin(phi)*Math.sin(theta),sun.z=Math.sin(phi)*Math.cos(theta),sky.material.uniforms.sunPosition.value.copy(sun);var ambientLight=new THREE.AmbientLight(8947848);scene.add(ambientLight);var player=new Character;scene.add(player);var dirLight=new THREE.DirectionalLight(16777215,.6);dirLight.target=player,dirLight.castShadow=!0,dirLight.shadow.mapSize.width=1024,dirLight.shadow.mapSize.height=1024,dirLight.shadow.camera.near=.5,dirLight.shadow.camera.far=8,dirLight.shadow.camera.top=3,dirLight.shadow.camera.right=3,dirLight.shadow.camera.bottom=-3,dirLight.shadow.camera.left=-3,dirLight.shadow.camera,scene.add(dirLight);var orbitControls=new THREE.OrbitControls(camera,renderer.domElement);orbitControls.scale=.5,orbitControls.enableZoom=!1,orbitControls.enablePan=!1,orbitControls.update();var helper=new THREE.GridHelper(10,10,0,0);helper.position.set(0,.01,0),helper.material.opacity=.2,helper.material.transparent=!0,scene.add(helper),helper=new THREE.AxesHelper(2),helper=new THREE.DirectionalLightHelper(dirLight,3),helper=new THREE.CameraHelper(dirLight.shadow.camera);var sphereGeo=new THREE.SphereGeometry(.3,32,32),sphereMat=new THREE.MeshLambertMaterial({color:16711680}),sphere=new THREE.Mesh(sphereGeo,sphereMat);sphere.castShadow=!0,sphere.receiveShadow=!0,sphere.visible=!1,scene.add(sphere);var sphereGeo2=new THREE.SphereGeometry(.3,32,32),sphereMat2=new THREE.MeshLambertMaterial({color:65280}),sphere2=new THREE.Mesh(sphereGeo2,sphereMat2);sphere2.castShadow=!0,sphere2.receiveShadow=!0,sphere2.visible=!1,scene.add(sphere2);var sphereGeo3=new THREE.SphereGeometry(.3,32,32),sphereMat3=new THREE.MeshLambertMaterial({color:255}),sphere3=new THREE.Mesh(sphereGeo3,sphereMat3);sphere3.castShadow=!0,sphere3.receiveShadow=!0,sphere3.visible=!1,scene.add(sphere3);var physicsWorld,hinge,transformAux1,cloth,sbConfig,playerCol,updatePhysics,gravityConstant=-9.8,rigidBodies=[],margin=.05,time=0,armMovement=0;Ammo().then(function(_){transformAux1=new _.btTransform;var e=new _.btSoftBodyRigidBodyCollisionConfiguration,n=new _.btCollisionDispatcher(e),a=new _.btDbvtBroadphase,i=new _.btSequentialImpulseConstraintSolver,o=new _.btDefaultSoftBodySolver;function r(e,t,n,a,i,o,r){var s=new THREE.Mesh(new THREE.BoxGeometry(e,t,n,1,1,1),r),l=new _.btBoxShape(new _.btVector3(.5*e,.5*t,.5*n));return l.setMargin(margin),function(e,t,n,a,i){e.position.copy(a),e.quaternion.copy(i);var o=new _.btTransform;o.setIdentity(),o.setOrigin(new _.btVector3(a.x,a.y,a.z)),o.setRotation(new _.btQuaternion(i.x,i.y,i.z,i.w));var r=new _.btDefaultMotionState(o),s=new _.btVector3(0,0,0);t.calculateLocalInertia(n,s);var l=new _.btRigidBodyConstructionInfo(n,r,t,s),d=new _.btRigidBody(l);e.userData.physicsBody=d,scene.add(e),0<n&&(rigidBodies.push(e),d.setActivationState(4)),physicsWorld.addRigidBody(d)}(s,l,a,i,o),s}(physicsWorld=new _.btSoftRigidDynamicsWorld(n,a,i,e,o)).setGravity(new _.btVector3(0,gravityConstant,0)),physicsWorld.getWorldInfo().set_m_gravity(new _.btVector3(0,gravityConstant,0)),pos=new THREE.Vector3(0,-.5,0),quat=new THREE.Quaternion(0,0,0,1);var s=r(10,1,10,0,pos,quat,new THREE.MeshLambertMaterial({color:13421772}));s.castShadow=!0,s.receiveShadow=!0;var l=r(.6,.6,1.2,.5,new THREE.Vector3(2,1,0),new THREE.Quaternion(0,0,0,1),new THREE.MeshPhongMaterial({color:16777215}));l.castShadow=!0,l.receiveShadow=!0;new THREE.Vector3(2,3,2);var d=new THREE.PlaneBufferGeometry(4,3,20,15);d.rotateZ(90);var u=new THREE.MeshLambertMaterial({color:16777215,side:THREE.DoubleSide});(cloth=new THREE.Mesh(d,u)).castShadow=!0,scene.add(cloth);var c=new _.btSoftBodyHelpers,f=new _.btVector3(3,2,1),h=new _.btVector3(3,2,-1),p=new _.btVector3(1,2,-1),m=new _.btVector3(1,2,1),E=c.CreatePatch(physicsWorld.getWorldInfo(),h,p,f,m,21,16,3,!0);(sbConfig=E.get_m_cfg()).set_viterations(10),sbConfig.set_piterations(10),E.setTotalMass(.9,!1),_.castObject(E,_.btCollisionObject).getCollisionShape().setMargin(2*margin),physicsWorld.addSoftBody(E,1,-1),cloth.userData.physicsBody=E,(playerCol=r(.5,1,.5,1,new THREE.Vector3(0,.5,0),new THREE.Quaternion(0,0,0,1),new THREE.MeshPhongMaterial({color:16777215,wireframe:!0}))).visible=!1;var v=0;updatePhysics=function(e){physicsWorld.stepSimulation(e),1/60<(v+=e)&&(v%=1/60),phys=playerCol.userData.physicsBody,t=phys.getWorldTransform(),t.setOrigin(new _.btVector3(player.position.x+.3*(new THREE.Vector3).copy(player.orientation).multiplyScalar(player.velocity).x,player.position.y+.5,player.position.z+.3*(new THREE.Vector3).copy(player.orientation).multiplyScalar(player.velocity).z)),t.setRotation(new _.btQuaternion(0,0,0,1)),phys.setWorldTransform(t);for(var n=cloth.userData.physicsBody,a=cloth.geometry.attributes.position.array,i=a.length/3,o=n.get_m_nodes(),r=0,s=0;s<i;s++){var l=o.at(s),d=l.get_m_x(),u=l.get_m_q();a[r++]=THREE.Math.lerp(u.x(),d.x(),v/(1/60)),a[r++]=THREE.Math.lerp(u.y(),d.y(),v/(1/60)),a[r++]=THREE.Math.lerp(u.z(),d.z(),v/(1/60))}cloth.geometry.computeVertexNormals(),cloth.geometry.attributes.position.needsUpdate=!0,cloth.geometry.attributes.normal.needsUpdate=!0;s=0;for(var c=rigidBodies.length;s<c;s++){var f=rigidBodies[s],h=f.userData.physicsBody.getMotionState();if(h){h.getWorldTransform(transformAux1);var p=transformAux1.getOrigin(),m=transformAux1.getRotation();f.position.set(p.x(),p.y(),p.z()),f.quaternion.set(m.x(),m.y(),m.z(),m.w())}}}});var loader=new THREE.FBXLoader;loader.load(AP_MODELS+"game_man/game_man.fbx",function(e){e.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0),"game_man"==e.name&&(e.material=new THREE.MeshLambertMaterial({map:(new THREE.TextureLoader).load(AP_MODELS+"game_man/game_man.png"),skinning:!0}))}),player.setModel(e),player.setState(CharStates.Idle)}),loader.load(AP_MODELS+"credits_sign/sign.fbx",function(e){e.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0),"grass"==e.name&&(e.material=new THREE.MeshLambertMaterial({map:(new THREE.TextureLoader).load(AP_MODELS+"credits_sign/grass.png"),transparent:!0,depthWrite:!1,side:THREE.DoubleSide}),e.castShadow=!1),"sign"==e.name&&(e.material=new THREE.MeshLambertMaterial({map:(new THREE.TextureLoader).load(AP_MODELS+"credits_sign/sign.png")})),"sign_shadow"==e.name&&(e.material=new THREE.MeshLambertMaterial({map:(new THREE.TextureLoader).load(AP_MODELS+"credits_sign/sign_shadow.png"),transparent:!0}),e.renderOrder=-1),"credits"==e.name&&(e.material=new THREE.MeshLambertMaterial({map:(new THREE.TextureLoader).load(AP_MODELS+"credits_sign/credits.png"),transparent:!0}))}),e.translateZ(4),e.rotateY(Math.PI/2),scene.add(e)});var params={FPS_Limit:60,Time_Scale:1,Shadows:!0,FXAA:!0,Auto_Rotate:!1,Bounce_Debug:!1};function Update(e){bV.simulate(e),sphere2.position.copy(bV.position),bvx.target=player.position.x,bvz.target=player.position.z,bvx.simulate(e),bvz.simulate(e),sphere.position.set(bvx.position,0,bvz.position),updatePhysics(e),params.Time_Scale=THREE.Math.lerp(params.Time_Scale,timeScaleTarget,.2),player.charState.update(player,e),player.updateMatrixWorld(),dirLight.position.set(player.position.x+5*sun.x,player.position.y+5*sun.y,player.position.z+5*sun.z),orbitControls.target.set(player.position.x,player.position.y+.5,player.position.z),params.Auto_Rotate&&camera.lookAt(player.position),camera.position.set(player.position.x,player.position.y+.5,player.position.z),camera.translateZ(2),params.Auto_Rotate&&camera.position.setComponent(1,1),orbitControls.update()}ParamGUI(params),bV=new BounceVSimulator(60,20,.98),bV.target=player.position,bvx=new BounceSimulator(60,30,.98),bvz=new BounceSimulator(60,30,.98);var delta,clock=new THREE.Clock,sinceLastFrame=0,justRendered=!1,Render=function(){justRendered&&(justRendered=!1,stats.begin()),requestAnimationFrame(Render),Update((delta=clock.getDelta())*params.Time_Scale),sinceLastFrame+=delta+clock.getDelta();var e=1/params.FPS_Limit;e<sinceLastFrame&&(sinceLastFrame%=e,params.FXAA?composer.render():renderer.render(scene,camera),stats.end(),justRendered=!0)};Render();