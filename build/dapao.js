!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.DaPao=e():t.DaPao=e()}(this,function(){return function(t){var e={};function o(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=t,o.c=e,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e,o){"use strict";o.r(e);var i=function(){function t(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}return t.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},t.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},t.prototype.getTrace=function(t){t=t||new n;var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},t.prototype.vmult=function(t,e){e=e||new n;var o=this.elements,i=t.x,r=t.y,s=t.z;return e.x=o[0]*i+o[1]*r+o[2]*s,e.y=o[3]*i+o[4]*r+o[5]*s,e.z=o[6]*i+o[7]*r+o[8]*s,e},t.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},t.prototype.mmult=function(e,o){for(var i=o||new t,n=0;n<3;n++)for(var r=0;r<3;r++){for(var s=0,a=0;a<3;a++)s+=e.elements[n+3*a]*this.elements[a+3*r];i.elements[n+3*r]=s}return i},t.prototype.scale=function(e,o){o=o||new t;for(var i=this.elements,n=o.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return o},t.prototype.solve=function(t,e){e=e||new n;for(var o,i=[],r=0;r<12;r++)i.push(0);for(r=0;r<3;r++)for(o=0;o<3;o++)i[r+4*o]=this.elements[r+3*o];i[3]=t.x,i[7]=t.y,i[11]=t.z;var s,a,h=3,p=h;do{if(0===i[(r=p-h)+4*r])for(o=r+1;o<p;o++)if(0!==i[r+4*o]){s=4;do{i[(a=4-s)+4*r]+=i[a+4*o]}while(--s);break}if(0!==i[r+4*r])for(o=r+1;o<p;o++){var l=i[r+4*o]/i[r+4*r];s=4;do{i[(a=4-s)+4*o]=a<=r?0:i[a+4*o]-i[a+4*r]*l}while(--s)}}while(--h);if(e.z=i[11]/i[10],e.y=(i[7]-i[6]*e.z)/i[5],e.x=(i[3]-i[2]*e.z-i[1]*e.y)/i[0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw new Error("Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]");return e},t.prototype.e=function(t,e,o){return void 0===o?this.elements[e+3*t]:this.elements[e+3*t]=o},t.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},t.prototype.toString=function(){for(var t="",e=0;e<9;e++)t+=this.elements[e]+",";return t},t.prototype.reverse=function(e){e=e||new t;var o,i=[],n=0;for(n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(o=0;o<3;o++)i[n+6*o]=this.elements[n+3*o];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,s,a=3,h=a;do{if(0===i[(n=h-a)+6*n])for(o=n+1;o<h;o++)if(0!==i[n+6*o]){r=6;do{i[(s=6-r)+6*n]+=i[s+6*o]}while(--r);break}if(0!==i[n+6*n])for(o=n+1;o<h;o++){var p=i[n+6*o]/i[n+6*n];r=6;do{i[(s=6-r)+6*o]=s<=n?0:i[s+6*o]-i[s+6*n]*p}while(--r)}}while(--a);n=2;do{o=n-1;do{p=i[n+6*o]/i[n+6*n],r=6;do{i[(s=6-r)+6*o]=i[s+6*o]-i[s+6*n]*p}while(--r)}while(o--)}while(--n);n=2;do{p=1/i[n+6*n],r=6;do{i[(s=6-r)+6*n]=i[s+6*n]*p}while(--r)}while(n--);n=2;do{o=2;do{if(s=i[3+o+6*n],isNaN(s)||s===1/0)throw new Error("Could not reverse! A=["+this.toString()+"]");e.e(n,o,s)}while(o--)}while(n--);return e},t.prototype.setRotationFromQuaternion=function(t){var e=t.x,o=t.y,i=t.z,n=t.w,r=e+e,s=o+o,a=i+i,h=e*r,p=e*s,l=e*a,c=o*s,u=o*a,d=i*a,v=n*r,y=n*s,f=n*a,m=this.elements;return m[0]=1-(c+d),m[1]=p-f,m[2]=l+y,m[3]=p+f,m[4]=1-(h+d),m[5]=u-v,m[6]=l-y,m[7]=u+v,m[8]=1-(h+c),this},t.prototype.transpose=function(e){for(var o=(e=e||new t).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)o[3*n+r]=i[3*r+n];return e},t}(),n=function(){function t(t,e,o){this.x=t||0,this.y=e||0,this.z=o||0}return t.prototype.cross=function(e,o){var i=e.x,n=e.y,r=e.z,s=this.x,a=this.y,h=this.z;return(o=o||new t).x=a*r-h*n,o.y=h*i-s*r,o.z=s*n-a*i,o},t.prototype.set=function(t,e,o){return this.x=t,this.y=e,this.z=o,this},t.prototype.setZero=function(){this.x=this.y=this.z=0},t.prototype.vadd=function(e,o){return o?(o.x=e.x+this.x,o.y=e.y+this.y,o.z=e.z+this.z,o):new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.vsub=function(e,o){return o?(o.x=this.x-e.x,o.y=this.y-e.y,o.z=this.z-e.z,o):new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.prototype.normalize=function(){var t=this.x,e=this.y,o=this.z,i=Math.sqrt(t*t+e*e+o*o);if(i>0){var n=1/i;this.x*=n,this.y*=n,this.z*=n}else this.x=0,this.y=0,this.z=0;return i},t.prototype.unit=function(e){e=e||new t;var o=this.x,i=this.y,n=this.z,r=Math.sqrt(o*o+i*i+n*n);return r>0?(r=1/r,e.x=o*r,e.y=i*r,e.z=n*r):(e.x=1,e.y=0,e.z=0),e},t.prototype.norm=function(){var t=this.x,e=this.y,o=this.z;return Math.sqrt(t*t+e*e+o*o)},t.prototype.length=function(){return this.norm()},t.prototype.norm2=function(){return this.dot(this)},t.prototype.lengthSquared=function(){return this.norm2()},t.prototype.distanceTo=function(t){var e=this.x,o=this.y,i=this.z,n=t.x,r=t.y,s=t.z;return Math.sqrt((n-e)*(n-e)+(r-o)*(r-o)+(s-i)*(s-i))},t.prototype.distanceSquared=function(t){var e=this.x,o=this.y,i=this.z,n=t.x,r=t.y,s=t.z;return(n-e)*(n-e)+(r-o)*(r-o)+(s-i)*(s-i)},t.prototype.mult=function(e,o){o=o||new t;var i=this.x,n=this.y,r=this.z;return o.x=e*i,o.y=e*n,o.z=e*r,o},t.prototype.vmul=function(e,o){return(o=o||new t).x=e.x*this.x,o.y=e.y*this.y,o.z=e.z*this.z,o},t.prototype.scale=function(t,e){return this.mult(t,e)},t.prototype.addScaledVector=function(e,o,i){return(i=i||new t).x=this.x+e*o.x,i.y=this.y+e*o.y,i.z=this.z+e*o.z,i},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.prototype.negate=function(e){return(e=e||new t).x=-this.x,e.y=-this.y,e.z=-this.z,e},t.prototype.tangents=function(e,o){var i=new t,n=new t,r=this.norm();if(r>0){var s=i,a=1/r;s.set(this.x*a,this.y*a,this.z*a);var h=n;Math.abs(s.x)<.9?(h.set(1,0,0),s.cross(h,e)):(h.set(0,1,0),s.cross(h,e)),s.cross(e,o)}else e.set(1,0,0),o.set(0,1,0)},t.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.prototype.toArray=function(){return[this.x,this.y,this.z]},t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.prototype.lerp=function(t,e,o){var i=this.x,n=this.y,r=this.z;o.x=i+(t.x-i)*e,o.y=n+(t.y-n)*e,o.z=r+(t.z-r)*e},t.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},t.prototype.almostZero=function(t){return void 0===t&&(t=0),void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)},t.prototype.isAntiparallelTo=function(e,o){void 0===o&&(o=0);var i=new t;return this.negate(i),i.almostEquals(e,o)},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t}(),r=function(){function t(){}return t.ZERO=new n(0,0,0),t.UNIT_X=new n(1,0,0),t.UNIT_Y=new n(0,1,0),t.UNIT_Z=new n(0,0,1),t}(),s=function(){function t(t){this.tmp=new n,this.transformIntoFrame_corners=[new n,new n,new n,new n,new n,new n,new n,new n],t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}return t.prototype.setFromPoints=function(t,e,o,i){var n=this.lowerBound,r=this.upperBound,s=o;n.copy(t[0]),s&&s.vmult(n,n),r.copy(n);for(var a=1;a<t.length;a++){var h=t[a];s&&(s.vmult(h,this.tmp),h=this.tmp),h.x>r.x&&(r.x=h.x),h.x<n.x&&(n.x=h.x),h.y>r.y&&(r.y=h.y),h.y<n.y&&(n.y=h.y),h.z>r.z&&(r.z=h.z),h.z<n.z&&(n.z=h.z)}return e&&(e.vadd(n,n),e.vadd(r,r)),i&&(n.x-=i,n.y-=i,n.z-=i,r.x+=i,r.y+=i,r.z+=i),this},t.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},t.prototype.clone=function(){return(new t).copy(this)},t.prototype.extend=function(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)},t.prototype.overlaps=function(t){var e=this.lowerBound,o=this.upperBound,i=t.lowerBound,n=t.upperBound,r=i.x<=o.x&&o.x<=n.x||e.x<=n.x&&n.x<=o.x,s=i.y<=o.y&&o.y<=n.y||e.y<=n.y&&n.y<=o.y,a=i.z<=o.z&&o.z<=n.z||e.z<=n.z&&n.z<=o.z;return r&&s&&a},t.prototype.volume=function(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)},t.prototype.contains=function(t){var e=this.lowerBound,o=this.upperBound,i=t.lowerBound,n=t.upperBound;return e.x<=i.x&&o.x>=n.x&&e.y<=i.y&&o.y>=n.y&&e.z<=i.z&&o.z>=n.z},t.prototype.getCorners=function(t,e,o,i,n,r,s,a){var h=this.lowerBound,p=this.upperBound;t.copy(h),e.set(p.x,h.y,h.z),o.set(p.x,p.y,h.z),i.set(h.x,p.y,p.z),n.set(p.x,h.y,h.z),r.set(h.x,p.y,h.z),s.set(h.x,h.y,p.z),a.copy(p)},t.prototype.toLocalFrame=function(t,e){var o=this.transformIntoFrame_corners,i=o[0],n=o[1],r=o[2],s=o[3],a=o[4],h=o[5],p=o[6],l=o[7];this.getCorners(i,n,r,s,a,h,p,l);for(var c=0;8!==c;c++){var u=o[c];t.pointToLocal(u,u)}return e.setFromPoints(o)},t.prototype.toWorldFrame=function(t,e){var o=this.transformIntoFrame_corners,i=o[0],n=o[1],r=o[2],s=o[3],a=o[4],h=o[5],p=o[6],l=o[7];this.getCorners(i,n,r,s,a,h,p,l);for(var c=0;8!==c;c++){var u=o[c];t.pointToWorld(u,u)}return e.setFromPoints(o)},t.prototype.overlapsRay=function(t){var e=1/t._direction.x,o=1/t._direction.y,i=1/t._direction.z,n=(this.lowerBound.x-t.from.x)*e,r=(this.upperBound.x-t.from.x)*e,s=(this.lowerBound.y-t.from.y)*o,a=(this.upperBound.y-t.from.y)*o,h=(this.lowerBound.z-t.from.z)*i,p=(this.upperBound.z-t.from.z)*i,l=Math.max(Math.max(Math.min(n,r),Math.min(s,a)),Math.min(h,p)),c=Math.min(Math.min(Math.max(n,r),Math.max(s,a)),Math.max(h,p));return!(c<0||l>c)},t.prototype.halfExtents=function(){return this.upperBound&&this.lowerBound?this.upperBound.vsub(this.lowerBound).mult(.5):new n},t}(),a=function(){function t(){this.matrix=[]}return t.prototype.get=function(t,e){var o=t.index,i=e.index;if(i>o){var n=i;i=o,o=n}return this.matrix[(o*(o+1)>>1)+i-1]},t.prototype.set=function(t,e,o){var i=t.index,n=e.index;if(n>i){var r=n;n=i,i=r}this.matrix[(i*(i+1)>>1)+n-1]=o?1:0},t.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},t.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1},t}(),h=function(){function t(){}return t.prototype.addEventListener=function(t,e){void 0===this._listeners&&(this._listeners={});var o=this._listeners;return void 0===o[t]&&(o[t]=[]),-1===o[t].indexOf(e)&&o[t].push(e),this},t.prototype.hasEventListener=function(t,e){if(void 0===this._listeners)return!1;var o=this._listeners;return void 0!==o[t]&&-1!==o[t].indexOf(e)},t.prototype.hasAnyEventListener=function(t){return void 0!==this._listeners&&void 0!==this._listeners[t]},t.prototype.removeEventListener=function(t,e){if(void 0===this._listeners)return this;var o=this._listeners;if(void 0===o[t])return this;var i=o[t].indexOf(e);return-1!==i&&o[t].splice(i,1),this},t.prototype.dispatchEvent=function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var o=0,i=e.length;o<i;o++)e[o].call(this,t)}return this},t}(),p=function(){function t(t,e,o,i){this.sfv_t1=new n,this.sfv_t2=new n,this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==o?o:0,this.w=void 0!==i?i:1}return t.prototype.set=function(t,e,o,i){return this.x=t,this.y=e,this.z=o,this.w=i,this},t.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.setFromAxisAngle=function(t,e){var o=Math.sin(.5*e);return this.x=t.x*o,this.y=t.y*o,this.z=t.z*o,this.w=Math.cos(.5*e),this},t.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),o=Math.sqrt(1-this.w*this.w);return o<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/o,t.y=this.y/o,t.z=this.z/o),[t,e]},t.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var o=this.sfv_t1,i=this.sfv_t2;t.tangents(o,i),this.setFromAxisAngle(o,Math.PI)}else{var n=t.cross(e);this.x=n.x,this.y=n.y,this.z=n.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}return this},t.prototype.mult=function(e,o){o=o||new t;var i=this.x,n=this.y,r=this.z,s=this.w,a=e.x,h=e.y,p=e.z,l=e.w;return o.x=i*l+s*a+n*p-r*h,o.y=n*l+s*h+r*a-i*p,o.z=r*l+s*p+i*h-n*a,o.w=s*l-i*a-n*h-r*p,o},t.prototype.inverse=function(e){var o=this.x,i=this.y,n=this.z,r=this.w;e=e||new t,this.conjugate(e);var s=1/(o*o+i*i+n*n+r*r);return e.x*=s,e.y*=s,e.z*=s,e.w*=s,e},t.prototype.conjugate=function(e){return(e=e||new t).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},t.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},t.prototype.vmult=function(t,e){e=e||new n;var o=t.x,i=t.y,r=t.z,s=this.x,a=this.y,h=this.z,p=this.w,l=p*o+a*r-h*i,c=p*i+h*o-s*r,u=p*r+s*i-a*o,d=-s*o-a*i-h*r;return e.x=l*p+d*-s+c*-h-u*-a,e.y=c*p+d*-a+u*-s-l*-h,e.z=u*p+d*-h+l*-a-c*-s,e},t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.toEuler=function(t,e){var o,i,n;void 0===e&&(e="YZX");var r=this.x,s=this.y,a=this.z,h=this.w;switch(e){case"YZX":var p=r*s+a*h;if(p>.499&&(o=2*Math.atan2(r,h),i=Math.PI/2,n=0),p<-.499&&(o=-2*Math.atan2(r,h),i=-Math.PI/2,n=0),isNaN(o)){var l=r*r,c=s*s,u=a*a;o=Math.atan2(2*s*h-2*r*a,1-2*c-2*u),i=Math.asin(2*p),n=Math.atan2(2*r*h-2*s*a,1-2*l-2*u)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=o,t.z=i,t.x=n},t.prototype.setFromEuler=function(t,e,o,i){void 0===i&&(i="XYZ");var n=Math.cos(t/2),r=Math.cos(e/2),s=Math.cos(o/2),a=Math.sin(t/2),h=Math.sin(e/2),p=Math.sin(o/2);return"XYZ"===i?(this.x=a*r*s+n*h*p,this.y=n*h*s-a*r*p,this.z=n*r*p+a*h*s,this.w=n*r*s-a*h*p):"YXZ"===i?(this.x=a*r*s+n*h*p,this.y=n*h*s-a*r*p,this.z=n*r*p-a*h*s,this.w=n*r*s+a*h*p):"ZXY"===i?(this.x=a*r*s-n*h*p,this.y=n*h*s+a*r*p,this.z=n*r*p+a*h*s,this.w=n*r*s-a*h*p):"ZYX"===i?(this.x=a*r*s-n*h*p,this.y=n*h*s+a*r*p,this.z=n*r*p-a*h*s,this.w=n*r*s+a*h*p):"YZX"===i?(this.x=a*r*s+n*h*p,this.y=n*h*s+a*r*p,this.z=n*r*p-a*h*s,this.w=n*r*s-a*h*p):"XZY"===i&&(this.x=a*r*s-n*h*p,this.y=n*h*s-a*r*p,this.z=n*r*p+a*h*s,this.w=n*r*s+a*h*p),this},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.slerp=function(e,o,i){i=i||new t;var n,r,s,a,h,p=this.x,l=this.y,c=this.z,u=this.w,d=e.x,v=e.y,y=e.z,f=e.w;return(r=p*d+l*v+c*y+u*f)<0&&(r=-r,d=-d,v=-v,y=-y,f=-f),1-r>1e-6?(n=Math.acos(r),s=Math.sin(n),a=Math.sin((1-o)*n)/s,h=Math.sin(o*n)/s):(a=1-o,h=o),i.x=a*p+h*d,i.y=a*l+h*v,i.z=a*c+h*y,i.w=a*u+h*f,i},t.prototype.integrate=function(e,o,i,n){n=n||new t;var r=e.x*i.x,s=e.y*i.y,a=e.z*i.z,h=this.x,p=this.y,l=this.z,c=this.w,u=.5*o;return n.x+=u*(r*c+s*l-a*p),n.y+=u*(s*c+a*h-r*l),n.z+=u*(a*c+r*p-s*h),n.w+=u*(-r*h-s*p-a*l),n},t}(),l=function(){function t(e){e=e||{},this.id=t.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}return t.prototype.updateBoundingSphereRadius=function(){throw new Error("computeBoundingSphereRadius() not implemented for shape type "+this.type)},t.prototype.volume=function(){throw new Error("volume() not implemented for shape type "+this.type)},t.prototype.calculateLocalInertia=function(t,e){throw new Error("calculateLocalInertia() not implemented for shape type "+this.type)},t.prototype.calculateWorldAABB=function(t,e,o,i){throw new Error("calculateLocalInertia() not implemented for shape type "+this.type)},t.idCounter=0,t.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256},t}(),c=function(){function t(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new p,t.quaternion&&this.quaternion.copy(t.quaternion)}return t.pointToLocalFrame=function(t,e,o,i){var r=new p;return i=i||new n,o.vsub(t,i),e.conjugate(r),r.vmult(i,i),i},t.pointToWorldFrame=function(t,e,o,i){return i=i||new n,e.vmult(o,i),i.vadd(t,i),i},t.vectorToWorldFrame=function(t,e,o){return o=o||new n,t.vmult(e,o),o},t.vectorToLocalFrame=function(t,e,o,i){return i=i||new n,e.w*=-1,e.vmult(o,i),e.w*=-1,i},t.prototype.pointToLocal=function(e,o){return t.pointToLocalFrame(this.position,this.quaternion,e,o)},t.prototype.pointToWorld=function(e,o){return t.pointToWorldFrame(this.position,this.quaternion,e,o)},t}(),u=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),d=function(){},v=function(t){function e(e,o,i,r){var s=t.call(this,{type:l.types.CONVEXPOLYHEDRON})||this;return s.cah_WorldNormal=new n,s.fsa_faceANormalWS3=new n,s.fsa_Worldnormal1=new n,s.fsa_deltaC=new n,s.fsa_worldEdge0=new n,s.fsa_worldEdge1=new n,s.fsa_Cross=new n,s.cli_aabbmin=new n,s.cli_aabbmax=new n,s.cfah_faceANormalWS=new n,s.cfah_edge0=new n,s.cfah_WorldEdge0=new n,s.cfah_worldPlaneAnormal1=new n,s.cfah_planeNormalWS1=new n,s.cfah_worldA1=new n,s.cfah_localPlaneNormal=new n,s.cfah_planeNormalWS=new n,s.ConvexPolyhedron_pointIsInside=new n,s.ConvexPolyhedron_vToP=new n,s.ConvexPolyhedron_vToPointInside=new n,s.vertices=e||[],s.worldVertices=[],s.worldVerticesNeedsUpdate=!0,s.faces=o||[],s.faceNormals=r||[],s.computeNormals(),s.worldFaceNormalsNeedsUpdate=!0,s.worldFaceNormals=[],s.uniqueEdges=[],s.uniqueAxes=i?i.slice():null,s.computeEdges(),s.updateBoundingSphereRadius(),s}return u(e,t),e.prototype.computeEdges=function(){var t=new n,e=this.faces,o=this.vertices,i=(o.length,this.uniqueEdges);i.length=0;for(var r=t,s=0;s!==e.length;s++)for(var a=e[s],h=a.length,p=0;p!==h;p++){var l=(p+1)%h;o[a[p]].vsub(o[a[l]],r),r.normalize();for(var c=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(r)||i[u].almostEquals(r)){c=!0;break}c||i.push(r.clone())}},e.prototype.computeNormals=function(){if(!this.faceNormals.length){this.faceNormals=new Array(this.faces.length);for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var o=this.faceNormals[t]||new n;this.getFaceNormal(t,o),this.faceNormals[t]=o}}},e.computeNormal=function(t,e,o,i){var r=new n,s=new n;e.vsub(t,s),o.vsub(e,r),r.cross(s,i),i.isZero()||i.normalize(),i.negate(i)},e.prototype.getFaceNormal=function(t,o){var i=o||new n,r=this.faces[t],s=this.vertices[r[0]],a=this.vertices[r[1]],h=this.vertices[r[2]];return e.computeNormal(s,a,h,i),i},e.prototype.clipAgainstHull=function(t,e,o,i,r,s,a,h,p){for(var l=this,c=this.cah_WorldNormal,u=[],d=-Number.MAX_VALUE,v=0;v<o.faces.length;v++){c.copy(o.faceNormals[v]),r.vmult(c,c);var y=c.dot(s);y>d?(d=y,u=[v]):y===d&&u.push(v)}u.forEach(function(c){for(var u=[],d=o.faces[c],v=d.length,y=0;y<v;y++){var f=o.vertices[d[y]],m=new n;m.copy(f),r.vmult(m,m),i.vadd(m,m),u.push(m)}l.clipFaceAgainstHull(s,t,e,u,a,h,p)})},e.prototype.findSeparatingAxis=function(t,e,o,i,n,r,s,a){var h=this.fsa_faceANormalWS3,p=this.fsa_Worldnormal1,l=this.fsa_deltaC,c=this.fsa_worldEdge0,u=this.fsa_worldEdge1,d=this.fsa_Cross,v=Number.MAX_VALUE;if(this.uniqueAxes)for(m=0;m!==this.uniqueAxes.length;m++){o.vmult(this.uniqueAxes[m],h);var y=this.testSepAxis(h,t,e,o,i,n);if(b=y[0],x=y[1],!1===b)return!1;x<v&&(v=x,r.copy(h))}else for(var f=s?s.length:this.faces.length,m=0;m<f;m++){var w=s?s[m]:m;h.copy(this.faceNormals[w]),o.vmult(h,h);var _=this.testSepAxis(h,t,e,o,i,n),b=_[0],x=_[1];if(!1===b)return!1;x<v&&(v=x,r.copy(h))}if(t.uniqueAxes)for(m=0;m!==t.uniqueAxes.length;m++){n.vmult(t.uniqueAxes[m],p);var g=this.testSepAxis(p,t,e,o,i,n);if(b=g[0],x=g[1],!1===b)return!1;x<v&&(v=x,r.copy(p))}else{var B=a?a.length:t.faces.length;for(m=0;m<B;m++){w=a?a[m]:m,p.copy(t.faceNormals[w]),n.vmult(p,p);var A=this.testSepAxis(p,t,e,o,i,n);b=A[0],x=A[1];if(!1===b)return!1;x<v&&(v=x,r.copy(p))}}for(var E=0;E!==this.uniqueEdges.length;E++){o.vmult(this.uniqueEdges[E],c);for(var P=0;P!==t.uniqueEdges.length;P++)if(n.vmult(t.uniqueEdges[P],u),c.cross(u,d),!d.almostZero()){d.normalize();var z=this.testSepAxis(d,t,e,o,i,n),C=(b=z[0],z[1]);if(!1===b)return!1;C<v&&(v=C,r.copy(d))}}return i.vsub(e,l),l.dot(r)>0&&r.negate(r),!0},e.prototype.testSepAxis=function(t,o,i,n,r,s){var a=[],h=[];e.project(this,t,i,n,a),e.project(o,t,r,s,h);var p=a[0],l=a[1],c=h[0],u=h[1];if(p<u||c<l)return[!1,0];var d=p-u,v=c-l;return[!0,d<v?d:v]},e.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(this.cli_aabbmin,this.cli_aabbmax);var o=this.cli_aabbmax.x-this.cli_aabbmin.x,i=this.cli_aabbmax.y-this.cli_aabbmin.y,n=this.cli_aabbmax.z-this.cli_aabbmin.z;e.x=1/12*t*(2*i*2*i+2*n*2*n),e.y=1/12*t*(2*o*2*o+2*n*2*n),e.z=1/12*t*(2*i*2*i+2*o*2*o)},e.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],o=this.faceNormals[t],i=this.vertices[e[0]];return-o.dot(i)},e.prototype.clipFaceAgainstHull=function(t,e,o,i,n,r,s){for(var a=this.cfah_faceANormalWS,h=this.cfah_edge0,p=this.cfah_WorldEdge0,l=this.cfah_worldPlaneAnormal1,c=this.cfah_planeNormalWS1,u=this.cfah_worldA1,d=this.cfah_localPlaneNormal,v=this.cfah_planeNormalWS,y=i,f=[],m=-1,w=Number.MAX_VALUE,_=0;_<this.faces.length;_++){a.copy(this.faceNormals[_]),o.vmult(a,a);var b=a.dot(t);b<w&&(w=b,m=_)}if(!(m<0)){for(var x=this.faces[m],g=[],B=0;B<this.faces.length;B++)for(var A=0;A<this.faces[B].length;A++)-1!==x.indexOf(this.faces[B][A])&&B!==m&&-1===g.indexOf(B)&&g.push(B);y.length;for(var E,P=x.length,z=0;z<P;z++){var C=this.vertices[x[z]],S=this.vertices[x[(z+1)%P]];C.vsub(S,h),p.copy(h),o.vmult(p,p),e.vadd(p,p),l.copy(this.faceNormals[m]),o.vmult(l,l),e.vadd(l,l),p.cross(l,c),c.negate(c),u.copy(C),o.vmult(u,u),e.vadd(u,u);var q=-u.dot(c),F=g[z];if(void 0!=F){d.copy(this.faceNormals[F]);var N=this.getPlaneConstantOfFace(F);v.copy(d),o.vmult(v,v),E=N-v.dot(e)}else v.copy(c),E=q;for(this.clipFaceAgainstPlane(y,f,v,E);y.length;)y.shift();for(;f.length;)y.push(f.shift())}d.copy(this.faceNormals[m]);var M=this.getPlaneConstantOfFace(m);for(v.copy(d),o.vmult(v,v),E=M-v.dot(e),B=0;B<y.length;B++){var j=v.dot(y[B])+E;if(j<=n&&(j=n),j<=r){var O=y[B];if(j<=0){var I={point:O,normal:v,depth:j};s.push(I)}}}}},e.prototype.clipFaceAgainstPlane=function(t,e,o,i){var r,s,a=t.length;if(a<2)return e;var h=t[t.length-1],p=t[0];r=o.dot(h)+i;for(var l=0;l<a;l++){if(p=t[l],s=o.dot(p)+i,r<0)if(s<0)(c=new n).copy(p),e.push(c);else{var c=new n;h.lerp(p,r/(r-s),c),e.push(c)}else s<0&&(c=new n,h.lerp(p,r/(r-s),c),e.push(c),e.push(p));h=p,r=s}return e},e.prototype.computeWorldVertices=function(t,e){for(var o=this.vertices.length;this.worldVertices.length<o;)this.worldVertices.push(new n);for(var i=this.vertices,r=this.worldVertices,s=0;s!==o;s++)e.vmult(i[s],r[s]),t.vadd(r[s],r[s]);this.worldVerticesNeedsUpdate=!1},e.prototype.computeLocalAABB=function(t,e){new n;var o=this.vertices.length,i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<o;r++){var s=i[r];s.x<t.x?t.x=s.x:s.x>e.x&&(e.x=s.x),s.y<t.y?t.y=s.y:s.y>e.y&&(e.y=s.y),s.z<t.z?t.z=s.z:s.z>e.z&&(e.z=s.z)}},e.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new n);for(var o=this.faceNormals,i=this.worldFaceNormals,r=0;r!==e;r++)t.vmult(o[r],i[r]);this.worldFaceNormalsNeedsUpdate=!1},e.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,o=0,i=e.length;o!==i;o++){var n=e[o].norm2();n>t&&(t=n)}this.boundingSphereRadius=Math.sqrt(t)},e.prototype.calculateWorldAABB=function(t,e,o,i){for(var r,s,a,h,p,l,c=new n,u=this.vertices.length,d=this.vertices,v=0;v<u;v++){c.copy(d[v]),e.vmult(c,c),t.vadd(c,c);var y=c;(y.x<r||void 0===r)&&(r=y.x),(y.x>h||void 0===h)&&(h=y.x),(y.y<s||void 0===s)&&(s=y.y),(y.y>p||void 0===p)&&(p=y.y),(y.z<a||void 0===a)&&(a=y.z),(y.z>l||void 0===l)&&(l=y.z)}o.set(r,s,a),i.set(h,p,l)},e.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},e.prototype.getAveragePointLocal=function(t){t=t||new n;for(var e=this.vertices.length,o=this.vertices,i=0;i<e;i++)t.vadd(o[i],t);return t.scale(1/e,t),t},e.prototype.transformAllPoints=function(t,e){var o=this.vertices.length,i=this.vertices;if(e){for(var n=0;n<o;n++){var r=i[n];e.vmult(r,r)}for(n=0;n<this.faceNormals.length;n++)r=this.faceNormals[n],e.vmult(r,r)}if(t)for(n=0;n<o;n++)(r=i[n]).vadd(t,r)},e.prototype.pointIsInside=function(t){var e=this.vertices,o=this.faces,i=this.faceNormals,n=this.faces.length,r=this.ConvexPolyhedron_pointIsInside;this.getAveragePointLocal(r);for(var s=0,a=0;a<n;a++){var h=i[a],p=e[o[a][0]],l=this.ConvexPolyhedron_vToP;t.vsub(p,l);var c=h.dot(l),u=this.ConvexPolyhedron_vToPointInside;r.vsub(p,u);var d=h.dot(u);if(Math.sign(c)!==Math.sign(d)&&0!==c&&s++,0!==s&&s%3==0)return!1}return!0},e.project=function(t,e,o,i,r){new n;var s=new n,a=new n,h=t.vertices.length,p=s,l=a,u=t.vertices,d=0,v=0;l.setZero(),c.vectorToLocalFrame(o,i,e,p),c.pointToLocalFrame(o,i,l,l);var y=l.dot(p);v=d=u[0].dot(p);for(var f=1;f<h;f++){var m=u[f].dot(p);m>d&&(d=m),m<v&&(v=m)}if((v-=y)>(d-=y)){var w=v;v=d,d=w}r[0]=d,r[1]=v},e}(l),y=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),f=function(t){function e(e){var o=t.call(this,{type:l.types.BOX})||this;return o.worldCornerTempPos=new n,o.worldCornerTempNeg=new n,o.worldCornersTemp=[new n,new n,new n,new n,new n,new n,new n,new n],o.halfExtents=e,o.convexPolyhedronRepresentation=null,o.updateConvexPolyhedronRepresentation(),o.updateBoundingSphereRadius(),o}return y(e,t),e.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,o=this.halfExtents.z,i=n,r=[new i(-t,-e,-o),new i(t,-e,-o),new i(t,e,-o),new i(-t,e,-o),new i(-t,-e,o),new i(t,-e,o),new i(t,e,o),new i(-t,e,o)],s=new v(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]);this.convexPolyhedronRepresentation=s,s.material=this.material},e.prototype.calculateLocalInertia=function(t,o){return o=o||new n,e.calculateInertia(this.halfExtents,t,o),o},e.calculateInertia=function(t,e,o){var i=t;o.x=1/12*e*(2*i.y*2*i.y+2*i.z*2*i.z),o.y=1/12*e*(2*i.x*2*i.x+2*i.z*2*i.z),o.z=1/12*e*(2*i.y*2*i.y+2*i.x*2*i.x)},e.prototype.getSideNormals=function(t,e){var o=t,i=this.halfExtents;if(o[0].set(i.x,0,0),o[1].set(0,i.y,0),o[2].set(0,0,i.z),o[3].set(-i.x,0,0),o[4].set(0,-i.y,0),o[5].set(0,0,-i.z),void 0!==e)for(var n=0;n!==o.length;n++)e.vmult(o[n],o[n]);return o},e.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},e.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()},e.prototype.forEachWorldCorner=function(t,e,o){for(var i=this.halfExtents,n=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],r=0;r<n.length;r++)this.worldCornerTempPos.set(n[r][0],n[r][1],n[r][2]),e.vmult(this.worldCornerTempPos,this.worldCornerTempPos),t.vadd(this.worldCornerTempPos,this.worldCornerTempPos),o(this.worldCornerTempPos.x,this.worldCornerTempPos.y,this.worldCornerTempPos.z)},e.prototype.calculateWorldAABB=function(t,e,o,i){var n=this.halfExtents;this.worldCornersTemp[0].set(n.x,n.y,n.z),this.worldCornersTemp[1].set(-n.x,n.y,n.z),this.worldCornersTemp[2].set(-n.x,-n.y,n.z),this.worldCornersTemp[3].set(-n.x,-n.y,-n.z),this.worldCornersTemp[4].set(n.x,-n.y,-n.z),this.worldCornersTemp[5].set(n.x,n.y,-n.z),this.worldCornersTemp[6].set(-n.x,n.y,-n.z),this.worldCornersTemp[7].set(n.x,-n.y,n.z);var r=this.worldCornersTemp[0];e.vmult(r,r),t.vadd(r,r),i.copy(r),o.copy(r);for(var s=1;s<8;s++){var a=this.worldCornersTemp[s];e.vmult(a,a),t.vadd(a,a);var h=a.x,p=a.y,l=a.z;h>i.x&&(i.x=h),p>i.y&&(i.y=p),l>i.z&&(i.z=l),h<o.x&&(o.x=h),p<o.y&&(o.y=p),l<o.z&&(o.z=l)}},e}(l),m=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),w=function(){},_=function(t){function e(o){var r=t.call(this)||this;r.tmpVec=new n,r.tmpQuat=new p,r.computeAABB_shapeAABB=new s,r.uiw_m1=new i,r.uiw_m2=new i,r.uiw_m3=new i,r.Body_applyForce_r=new n,r.Body_applyForce_rotForce=new n,r.Body_applyLocalForce_worldForce=new n,r.Body_applyLocalForce_relativePointWorld=new n,r.Body_applyImpulse_r=new n,r.Body_applyImpulse_velo=new n,r.Body_applyImpulse_rotVelo=new n,r.Body_applyLocalImpulse_worldImpulse=new n,r.Body_applyLocalImpulse_relativePoint=new n,r.Body_updateMassProperties_halfExtents=new n,r.invI_tau_dt=new n,r.w=new p,r.wq=new p,o=o||{},r.goid="",r.id=e.idCounter++,r.world=null,r.preStep=null,r.postStep=null,r.vlambda=new n,r.collisionFilterGroup="number"==typeof o.collisionFilterGroup?o.collisionFilterGroup:1,r.collisionFilterMask="number"==typeof o.collisionFilterMask?o.collisionFilterMask:-1,r.collisionResponse=!0,r.position=new n,r.previousPosition=new n,r.interpolatedPosition=new n,r.initPosition=new n,o.position&&(r.position.copy(o.position),r.previousPosition.copy(o.position),r.interpolatedPosition.copy(o.position),r.initPosition.copy(o.position)),r.velocity=new n,o.velocity&&r.velocity.copy(o.velocity),r.initVelocity=new n,r.force=new n;var a=o.mass?o.mass:0;return r.mass=a,r.invMass=a>0?1/a:0,r.material=o.material||null,r.linearDamping="number"==typeof o.linearDamping?o.linearDamping:.01,r.type=a<=0?e.STATIC:e.DYNAMIC,typeof o.type==typeof e.STATIC&&(r.type=o.type),r.allowSleep="undefined"===o.allowSleep||o.allowSleep,r.sleepState=0,r.sleepSpeedLimit=o.sleepSpeedLimit?o.sleepSpeedLimit:.1,r.sleepTimeLimit=o.sleepTimeLimit?o.sleepTimeLimit:1,r.timeLastSleepy=0,r._wakeUpAfterNarrowphase=!1,r.torque=new n,r.quaternion=new p,r.initQuaternion=new p,r.previousQuaternion=new p,r.interpolatedQuaternion=new p,o.quaternion&&(r.quaternion.copy(o.quaternion),r.initQuaternion.copy(o.quaternion),r.previousQuaternion.copy(o.quaternion),r.interpolatedQuaternion.copy(o.quaternion)),r.angularVelocity=new n,o.angularVelocity&&r.angularVelocity.copy(o.angularVelocity),r.initAngularVelocity=new n,r.shapes=[],r.shapeOffsets=[],r.shapeOrientations=[],r.inertia=new n,r.invInertia=new n,r.invInertiaWorld=new i,r.invMassSolve=0,r.invInertiaSolve=new n,r.invInertiaWorldSolve=new i,r.fixedRotation=void 0!==o.fixedRotation&&o.fixedRotation,r.angularDamping=void 0!==o.angularDamping?o.angularDamping:.01,r.linearFactor=new n(1,1,1),o.linearFactor&&r.linearFactor.copy(o.linearFactor),r.angularFactor=new n(1,1,1),o.angularFactor&&r.angularFactor.copy(o.angularFactor),r.aabb=new s,r.aabbNeedsUpdate=!0,r.boundingRadius=0,r.wlambda=new n,o.shape&&r.addShape(o.shape),r.updateMassProperties(),r}return m(e,t),e.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,t===e.SLEEPING&&this.dispatchEvent(e.wakeupEvent)},e.prototype.sleep=function(){this.sleepState=e.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},e.prototype.sleepTick=function(t){if(this.allowSleep){var o=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);o===e.AWAKE&&i<n?(this.sleepState=e.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(e.sleepyEvent)):o===e.SLEEPY&&i>n?this.wakeUp():o===e.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(e.sleepEvent))}},e.prototype.updateSolveMassProperties=function(){this.sleepState===e.SLEEPING||this.type===e.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},e.prototype.pointToLocalFrame=function(t,e){return e=e||new n,t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},e.prototype.vectorToLocalFrame=function(t,e){return e=e||new n,this.quaternion.conjugate().vmult(t,e),e},e.prototype.pointToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e.vadd(this.position,e),e},e.prototype.vectorToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e},e.prototype.addShape=function(t,e,o){return this.shapes.push(t),this.shapeOffsets.push(e||new n),this.shapeOrientations.push(o||new p),this.recalculateShapes(),t.body=this,this},e.prototype.recalculateShapes=function(){this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0},e.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,o=t.length,i=0,n=0;n!==o;n++){var r=t[n];r.updateBoundingSphereRadius();var s=e[n].norm(),a=r.boundingSphereRadius;s+a>i&&(i=s+a)}this.boundingRadius=i},e.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,o=this.shapeOrientations,i=t.length,n=this.tmpVec,r=this.tmpQuat,s=this.quaternion,a=this.aabb,h=this.computeAABB_shapeAABB,p=0;p!==i;p++){var l=t[p];s.vmult(e[p],n),n.vadd(this.position,n),o[p].mult(s,r),l.calculateWorldAABB(n,r,h.lowerBound,h.upperBound),0===p?a.copy(h):a.extend(h)}this.aabbNeedsUpdate=!1},e.prototype.updateInertiaWorld=function(t){void 0===t&&(t=!1);var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var o=this.uiw_m1,i=this.uiw_m2;this.uiw_m3,o.setRotationFromQuaternion(this.quaternion),o.transpose(i),o.scale(e,o),o.mmult(i,this.invInertiaWorld)}},e.prototype.applyForce=function(t,o){if(this.type===e.DYNAMIC){var i=this.Body_applyForce_rotForce;o.cross(t,i),this.force.vadd(t,this.force),this.torque.vadd(i,this.torque)}},e.prototype.applyLocalForce=function(t,o){if(this.type===e.DYNAMIC){var i=this.Body_applyLocalForce_worldForce,n=this.Body_applyLocalForce_relativePointWorld;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(o,n),this.applyForce(i,n)}},e.prototype.applyImpulse=function(t,o){if(this.type===e.DYNAMIC){var i=o,n=this.Body_applyImpulse_velo;n.copy(t),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=this.Body_applyImpulse_rotVelo;i.cross(t,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}},e.prototype.applyLocalImpulse=function(t,o){if(this.type===e.DYNAMIC){var i=this.Body_applyLocalImpulse_worldImpulse,n=this.Body_applyLocalImpulse_relativePoint;this.vectorToWorldFrame(t,i),this.vectorToWorldFrame(o,n),this.applyImpulse(i,n)}},e.prototype.updateMassProperties=function(){var t=this.Body_updateMassProperties_halfExtents;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,o=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),f.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!o?1/e.x:0,e.y>0&&!o?1/e.y:0,e.z>0&&!o?1/e.z:0),this.updateInertiaWorld(!0)},e.prototype.getVelocityAtWorldPoint=function(t,e){var o=new n;return t.vsub(this.position,o),this.angularVelocity.cross(o,e),this.velocity.vadd(e,e),e},e.prototype.integrate=function(t,o,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===e.DYNAMIC||this.type===e.KINEMATIC)&&this.sleepState!==e.SLEEPING){var n=this.velocity,r=this.angularVelocity,s=this.position,a=this.force,h=this.torque,p=this.quaternion,l=this.invMass,c=this.invInertiaWorld,u=this.linearFactor,d=l*t;n.x+=a.x*d*u.x,n.y+=a.y*d*u.y,n.z+=a.z*d*u.z;var v=c.elements,y=this.angularFactor,f=h.x*y.x,m=h.y*y.y,w=h.z*y.z;r.x+=t*(v[0]*f+v[1]*m+v[2]*w),r.y+=t*(v[3]*f+v[4]*m+v[5]*w),r.z+=t*(v[6]*f+v[7]*m+v[8]*w),s.x+=n.x*t,s.y+=n.y*t,s.z+=n.z*t,p.integrate(this.angularVelocity,t,this.angularFactor,p),o&&(i?p.normalizeFast():p.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},e.idCounter=0,e.COLLIDE_EVENT_NAME="collide",e.DYNAMIC=1,e.STATIC=2,e.KINEMATIC=4,e.AWAKE=0,e.SLEEPY=1,e.SLEEPING=2,e.wakeupEvent={type:"wakeup"},e.sleepyEvent={type:"sleepy"},e.sleepEvent={type:"sleep"},e}(h),b=function(){function t(t){this.Broadphase_collisionPairs_r=new n,this.Broadphase_collisionPairs_normal=new n,this.Broadphase_collisionPairs_quat=new p,this.Broadphase_collisionPairs_relpos=new n,this.Broadphase_makePairsUnique_p1=[],this.Broadphase_makePairsUnique_p2=[],this.bsc_dist=new n,this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}return t.prototype.collisionPairs=function(t,e,o){throw new Error("collisionPairs not implemented for this BroadPhase class!")},t.prototype.needBroadphaseCollision=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&_.STATIC)&&t.sleepState!==_.SLEEPING||0==(e.type&_.STATIC)&&e.sleepState!==_.SLEEPING)},t.prototype.intersectionTest=function(t,e,o,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,o,i):this.doBoundingSphereBroadphase(t,e,o,i)},t.prototype.doBoundingSphereBroadphase=function(t,e,o,i){var n=this.Broadphase_collisionPairs_r;e.position.vsub(t.position,n);var r=Math.pow(t.boundingRadius+e.boundingRadius,2);n.norm2()<r&&(o.push(t),i.push(e))},t.prototype.doBoundingBoxBroadphase=function(t,e,o,i){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(o.push(t),i.push(e))},t.prototype.makePairsUnique=function(t,e){for(var o=this.Broadphase_makePairsUnique_temp,i=this.Broadphase_makePairsUnique_p1,n=this.Broadphase_makePairsUnique_p2,r=t.length,s=0;s!==r;s++)i[s]=t[s],n[s]=e[s];for(t.length=0,e.length=0,s=0;s!==r;s++){var a=i[s].id,h=n[s].id;o[p=a<h?a+","+h:h+","+a]=s,o.keys.push(p)}for(s=0;s!==o.keys.length;s++){var p,l=o[p=o.keys.pop()];t.push(i[l]),e.push(n[l]),delete o[p]}},t.prototype.setWorld=function(t){},t.boundingSphereCheck=function(t,e){var o=new n;t.position.vsub(e.position,o);var i=t.shapes[0],r=e.shapes[0];return Math.pow(i.boundingSphereRadius+r.boundingSphereRadius,2)>o.norm2()},t.prototype.aabbQuery=function(t,e,o){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]},t}(),x=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),g=function(t){function e(e,o,i,r,s){void 0===i&&(i=10),void 0===r&&(r=10),void 0===s&&(s=10);var a=t.call(this)||this;a.GridBroadphase_collisionPairs_d=new n,a.GridBroadphase_collisionPairs_binPos=new n,a.aabbMin=e||new n(100,100,100),a.aabbMax=o||new n(-100,-100,-100);var h=a.nx*a.ny*a.nz;if(h<=0)throw new Error("GridBroadphase: Each dimensions n must be >0");a.bins=[],a.binLengths=[],a.bins.length=h,a.binLengths.length=h;for(var p=0;p<h;p++)a.bins[p]=[],a.binLengths[p]=0;return a}return x(e,t),e.prototype.collisionPairs=function(t,e,o){for(var i=t.numObjects(),n=t.bodies,r=this.aabbMax,s=this.aabbMin,a=this.nx,h=this.ny,p=this.nz,c=h*p,u=p,d=r.x,v=r.y,y=r.z,f=s.x,m=s.y,w=s.z,_=a/(d-f),b=h/(v-m),x=p/(y-w),g=(d-f)/a,B=(v-m)/h,A=(y-w)/p,E=.5*Math.sqrt(g*g+B*B+A*A),P=l.types,z=P.SPHERE,C=P.PLANE,S=(P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON,this.bins),q=this.binLengths,F=this.bins.length,N=0;N!==F;N++)q[N]=0;var M=Math.ceil,j=function(t,e,o,i,n,r,s){var l=(t-f)*_|0,d=(e-m)*b|0,v=(o-w)*x|0,y=M((i-f)*_),g=M((n-m)*b),B=M((r-w)*x);l<0?l=0:l>=a&&(l=a-1),d<0?d=0:d>=h&&(d=h-1),v<0?v=0:v>=p&&(v=p-1),y<0?y=0:y>=a&&(y=a-1),g<0?g=0:g>=h&&(g=h-1),B<0?B=0:B>=p&&(B=p-1),d*=u,v*=1,y*=c,g*=u,B*=1;for(var A=l*=c;A<=y;A+=c)for(var E=d;E<=g;E+=u)for(var P=v;P<=B;P+=1){var z=A+E+P;S[z][q[z]++]=s}};for(N=0;N!==i;N++){var O=(ot=n[N]).shapes[0];switch(O.type){case z:var I=O,T=ot.position.x,R=ot.position.y,L=ot.position.z,W=I.radius;j(T-W,R-W,L-W,T+W,R+W,L+W,ot);break;case C:var V=O;V.worldNormalNeedsUpdate&&V.computeWorldNormal(ot.quaternion);var k=V.worldNormal,U=f+.5*g-ot.position.x,G=m+.5*B-ot.position.y,H=w+.5*A-ot.position.z,D=this.GridBroadphase_collisionPairs_d;D.set(U,G,H);for(var X=0,Y=0;X!==a;X++,Y+=c,D.y=G,D.x+=g)for(var Z=0,Q=0;Z!==h;Z++,Q+=u,D.z=H,D.y+=B)for(var K=0,J=0;K!==p;K++,J+=1,D.z+=A)if(D.dot(k)<E){var $=Y+Q+J;S[$][q[$]++]=ot}break;default:ot.aabbNeedsUpdate&&ot.computeAABB(),j(ot.aabb.lowerBound.x,ot.aabb.lowerBound.y,ot.aabb.lowerBound.z,ot.aabb.upperBound.x,ot.aabb.upperBound.y,ot.aabb.upperBound.z,ot)}}for(N=0;N!==F;N++){var tt=q[N];if(tt>1){var et=S[N];for(X=0;X!==tt;X++){var ot=et[X];for(Z=0;Z!==X;Z++){var it=et[Z];this.needBroadphaseCollision(ot,it)&&this.intersectionTest(ot,it,e,o)}}}}this.makePairsUnique(e,o)},e}(b),B=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),A=function(t){function e(){return t.call(this)||this}return B(e,t),e.prototype.collisionPairs=function(t,e,o){var i,n,r,s,a=t.bodies,h=a.length;for(i=0;i!==h;i++)for(n=0;n!==i;n++)r=a[i],s=a[n],this.needBroadphaseCollision(r,s)&&this.intersectionTest(r,s,e,o)},e.prototype.aabbQuery=function(t,e,o){o=o||[];for(var i=0;i<t.bodies.length;i++){var n=t.bodies[i];n.aabbNeedsUpdate&&n.computeAABB(),n.aabb.overlaps(e)&&o.push(n)}return o},e}(b),E=function(){function t(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}return t.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},t.prototype.abort=function(){this._shouldStop=!0},t.prototype.set=function(t,e,o,i,n,r,s){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(o),this.hitPointWorld.copy(i),this.shape=n,this.body=r,this.distance=s},t}(),P=function(){function t(e,o){this.tmpAABB=new s,this.tmpArray=[],this.v1=new n,this.v2=new n,this.intersectBody_xi=new n,this.intersectBody_qi=new p,this.vector=new n,this.normal=new n,this.intersectPoint=new n,this.a=new n,this.b=new n,this.c=new n,this.d=new n,this.tmpRaycastResult=new E,this.Ray_intersectSphere_intersectionPoint=new n,this.Ray_intersectSphere_normal=new n,this.intersectConvex_normal=new n,this.intersectConvex_minDistNormal=new n,this.intersectConvex_minDistIntersect=new n,this.intersectConvex_vector=new n,this.v0=new n,this.intersect=new n,this.from=e?e.clone():new n,this.to=o?o.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new E,this.hasHit=!1,this.callback=function(t){}}return t.prototype.intersectWorld=function(e,o){return this.mode=o.mode||t.ANY,this.result=o.result||new E,this.skipBackfaces=!!o.skipBackfaces,this.collisionFilterMask=void 0!==o.collisionFilterMask?o.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==o.collisionFilterGroup?o.collisionFilterGroup:-1,o.from&&this.from.copy(o.from),o.to&&this.to.copy(o.to),this.callback=o.callback||function(){},this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(this.tmpAABB),this.tmpArray.length=0,e.broadphase.aabbQuery(e,this.tmpAABB,this.tmpArray),this.intersectBodies(this.tmpArray),this.hasHit},t.pointInTriangle=function(t,e,o,i){var r=new n,s=new n,a=new n;i.vsub(e,r),o.vsub(e,s),t.vsub(e,a);var h,p,l=r.dot(r),c=r.dot(s),u=r.dot(a),d=s.dot(s),v=s.dot(a);return(h=d*u-c*v)>=0&&(p=l*v-c*u)>=0&&h+p<l*d-c*c},t.prototype.intersectBody=function(t,e){e&&(this.result=e,this.updateDirection());var o=this.checkCollisionResponse;if((!o||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var i=this.intersectBody_xi,n=this.intersectBody_qi,r=0,s=t.shapes.length;r<s;r++){var a=t.shapes[r];if((!o||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[r],n),t.quaternion.vmult(t.shapeOffsets[r],i),i.vadd(t.position,i),this.intersectShape(a,n,i,t),this.result._shouldStop))break}},t.prototype.intersectBodies=function(t,e){e&&(this.result=e,this.updateDirection());for(var o=0,i=t.length;!this.result._shouldStop&&o<i;o++)this.intersectBody(t[o])},t.prototype.updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(t,e,o,i){var n=this.from;if(!(this.distanceFromIntersection(n,this._direction,o)>t.boundingSphereRadius))switch(t.type){case l.types.CONVEXPOLYHEDRON:this.intersectConvex(t,e,o,i,t);break;case l.types.BOX:this.intersectBox(t,e,o,i,t);break;case l.types.SPHERE:this.intersectSphere(t,e,o,i,t);break;case l.types.PLANE:this.intersectPlane(t,e,o,i,t)}},t.prototype.intersectBox=function(t,e,o,i,n){return this.intersectConvex(t.convexPolyhedronRepresentation,e,o,i,n)},t.prototype.intersectPlane=function(t,e,o,i,r){var s=this.from,a=this.to,h=this._direction,p=new n(0,0,1);e.vmult(p,p);var l=new n;s.vsub(o,l);var c=l.dot(p);if(a.vsub(o,l),!(c*l.dot(p)>0||s.distanceTo(a)<c)){var u=p.dot(h);if(!(Math.abs(u)<this.precision)){var d=new n,v=new n,y=new n;s.vsub(o,d);var f=-p.dot(d)/u;h.scale(f,v),s.vadd(v,y),this.reportIntersection(p,y,r,i,-1)}}},t.prototype.getAABB=function(t){var e=this.to,o=this.from;t.lowerBound.x=Math.min(e.x,o.x),t.lowerBound.y=Math.min(e.y,o.y),t.lowerBound.z=Math.min(e.z,o.z),t.upperBound.x=Math.max(e.x,o.x),t.upperBound.y=Math.max(e.y,o.y),t.upperBound.z=Math.max(e.z,o.z)},t.prototype.intersectSphere=function(t,e,o,i,n){var r=this.from,s=this.to,a=t.radius,h=Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2)+Math.pow(s.z-r.z,2),p=2*((s.x-r.x)*(r.x-o.x)+(s.y-r.y)*(r.y-o.y)+(s.z-r.z)*(r.z-o.z)),l=Math.pow(r.x-o.x,2)+Math.pow(r.y-o.y,2)+Math.pow(r.z-o.z,2)-Math.pow(a,2),c=Math.pow(p,2)-4*h*l,u=this.Ray_intersectSphere_intersectionPoint,d=this.Ray_intersectSphere_normal;if(!(c<0))if(0===c)r.lerp(s,c,u),u.vsub(o,d),d.normalize(),this.reportIntersection(d,u,n,i,-1);else{var v=(-p-Math.sqrt(c))/(2*h),y=(-p+Math.sqrt(c))/(2*h);if(v>=0&&v<=1&&(r.lerp(s,v,u),u.vsub(o,d),d.normalize(),this.reportIntersection(d,u,n,i,-1)),this.result._shouldStop)return;y>=0&&y<=1&&(r.lerp(s,y,u),u.vsub(o,d),d.normalize(),this.reportIntersection(d,u,n,i,-1))}},t.prototype.intersectConvex=function(e,o,i,n,r,s){this.intersectConvex_minDistNormal;for(var a=this.intersectConvex_normal,h=this.intersectConvex_vector,p=(this.intersectConvex_minDistIntersect,s&&s.faceList||null),l=e.faces,c=e.vertices,u=e.faceNormals,d=this._direction,v=this.from,y=this.to,f=v.distanceTo(y),m=p?p.length:l.length,w=this.result,_=0;!w._shouldStop&&_<m;_++){var b=p?p[_]:_,x=l[b],g=u[b],B=o,A=i;h.copy(c[x[0]]),B.vmult(h,h),h.vadd(A,h),h.vsub(v,h),B.vmult(g,a);var E=d.dot(a);if(!(Math.abs(E)<this.precision)){var P=a.dot(h)/E;if(!(P<0)){d.mult(P,this.intersectPoint),this.intersectPoint.vadd(v,this.intersectPoint),this.a.copy(c[x[0]]),B.vmult(this.a,this.a),A.vadd(this.a,this.a);for(var z=1;!w._shouldStop&&z<x.length-1;z++){this.b.copy(c[x[z]]),this.c.copy(c[x[z+1]]),B.vmult(this.b,this.b),B.vmult(this.c,this.c),A.vadd(this.b,this.b),A.vadd(this.c,this.c);var C=this.intersectPoint.distanceTo(v);!t.pointInTriangle(this.intersectPoint,this.a,this.b,this.c)&&!t.pointInTriangle(this.intersectPoint,this.b,this.a,this.c)||C>f||this.reportIntersection(a,this.intersectPoint,r,n,b)}}}}},t.prototype.reportIntersection=function(e,o,i,n,r){var s=this.from,a=this.to,h=s.distanceTo(o),p=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(p.hitFaceIndex=void 0!==r?r:-1,this.mode){case t.ALL:this.hasHit=!0,p.set(s,a,e,o,i,n,h),p.hasHit=!0,this.callback(p);break;case t.CLOSEST:(h<p.distance||!p.hasHit)&&(this.hasHit=!0,p.hasHit=!0,p.set(s,a,e,o,i,n,h));break;case t.ANY:this.hasHit=!0,p.hasHit=!0,p.set(s,a,e,o,i,n,h),p._shouldStop=!0}},t.prototype.distanceFromIntersection=function(t,e,o){o.vsub(t,this.v0);var i=this.v0.dot(e);return e.mult(i,this.intersect),this.intersect.vadd(t,this.intersect),o.distanceTo(this.intersect)},t.CLOSEST=1,t.ANY=2,t.ALL=4,t}(),z=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),C=function(t){function e(e){var o=t.call(this,e)||this;b.apply(o),o.axisList=[],o.axisIndex=0;var i=o.axisList;return o._addBodyHandler=function(t){i.push(t.body)},o._removeBodyHandler=function(t){var e=i.indexOf(t.body);-1!==e&&i.splice(e,1)},e&&o.setWorld(e),o}return z(e,t),e.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},e.prototype.insertionSortX=function(t){var e,o,i;for(e=1,i=t.length;e<i;e++){var n=t[e];for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.x<=n.aabb.lowerBound.x);o--)t[o+1]=t[o];t[o+1]=n}return t},e.prototype.insertionSortY=function(t){var e,o,i;for(e=1,i=t.length;e<i;e++){var n=t[e];for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.y<=n.aabb.lowerBound.y);o--)t[o+1]=t[o];t[o+1]=n}return t},e.prototype.insertionSortZ=function(t){var e,o,i;for(e=1,i=t.length;e<i;e++){var n=t[e];for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.z<=n.aabb.lowerBound.z);o--)t[o+1]=t[o];t[o+1]=n}return t},e.prototype.collisionPairs=function(t,e,o){var i,n,r=this.axisList,s=r.length,a=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),i=0;i!==s;i++){var h=r[i];for(n=i+1;n<s;n++){var p=r[n];if(this.needBroadphaseCollision(h,p)){if(!this.checkBounds(h,p,a))break;this.intersectionTest(h,p,e,o)}}}},e.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,o=t.length,i=0;i!==o;i++){var n=t[i];n.aabbNeedsUpdate&&n.computeAABB()}0===e?this.insertionSortX(t):1===e?this.insertionSortY(t):2===e&&this.insertionSortZ(t)},e.prototype.checkBounds=function(t,e,o){var i,n;0===o?(i=t.position.x,n=e.position.x):1===o?(i=t.position.y,n=e.position.y):2===o&&(i=t.position.z,n=e.position.z);var r=t.boundingRadius;return n-e.boundingRadius<i+r},e.prototype.autoDetectAxis=function(){for(var t=0,e=0,o=0,i=0,n=0,r=0,s=this.axisList,a=s.length,h=1/a,p=0;p!==a;p++){var l=s[p],c=l.position.x;t+=c,e+=c*c;var u=l.position.y;o+=u,i+=u*u;var d=l.position.z;n+=d,r+=d*d}var v=e-t*t*h,y=i-o*o*h,f=r-n*n*h;this.axisIndex=v>y?v>f?0:2:y>f?1:2},e.prototype.aabbQuery=function(t,e,o){o=o||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,n="x";1===i&&(n="y"),2===i&&(n="z");for(var r=this.axisList,s=(e.lowerBound[n],e.upperBound[n],0);s<r.length;s++){var a=r[s];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&o.push(a)}return o},e}(b),S=function(){function t(e,o,i){void 0===i&&(i={}),i=Object.assign({collideConnected:!0,wakeUpBodies:!0},i),this.equations=[],this.bodyA=e,this.bodyB=o,this.id=t.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),o&&o.wakeUp())}return t.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},t.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},t.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},t.idCounter=0,t}(),q=function(){function t(){this.spatial=new n,this.rotational=new n}return t.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},t.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)},t}(),F=function(){function t(e,o,i,r){this.id=0,this.zero=new n,this.iMfi=new n,this.iMfj=new n,this.invIi_vmult_taui=new n,this.invIj_vmult_tauj=new n,this.tmp=new n,this.addToWlambda_temp=new n,this.id=t.EquationId++,this.minForce=i||-1e6,this.maxForce=r||1e6,this.bi=e,this.bj=o,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new q,this.jacobianElementB=new q,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}return t.prototype.setSpookParams=function(t,e,o){var i=e,n=t,r=o;this.a=4/(r*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(r*r*n*(1+4*i))},t.prototype.computeB=function(t,e,o){var i=this.computeGW();return-this.computeGq()*t-i*e-this.computeGiMf()*o},t.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.position,r=i.position;return t.spatial.dot(n)+e.spatial.dot(r)},t.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.velocity,r=i.velocity,s=o.angularVelocity,a=i.angularVelocity;return t.multiplyVectors(n,s)+e.multiplyVectors(r,a)},t.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.vlambda,r=i.vlambda,s=o.wlambda,a=i.wlambda;return t.multiplyVectors(n,s)+e.multiplyVectors(r,a)},t.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.force,r=o.torque,s=i.force,a=i.torque,h=o.invMassSolve,p=i.invMassSolve;return n.scale(h,this.iMfi),s.scale(p,this.iMfj),o.invInertiaWorldSolve.vmult(r,this.invIi_vmult_taui),i.invInertiaWorldSolve.vmult(a,this.invIj_vmult_tauj),t.multiplyVectors(this.iMfi,this.invIi_vmult_taui)+e.multiplyVectors(this.iMfj,this.invIj_vmult_tauj)},t.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,i=this.bj,n=o.invMassSolve,r=i.invMassSolve,s=o.invInertiaWorldSolve,a=i.invInertiaWorldSolve,h=n+r;return s.vmult(t.rotational,this.tmp),h+=this.tmp.dot(t.rotational),a.vmult(e.rotational,this.tmp),h+this.tmp.dot(e.rotational)},t.prototype.addToWlambda=function(t){var e=this.jacobianElementA,o=this.jacobianElementB,i=this.bi,n=this.bj,r=this.addToWlambda_temp;i.vlambda.addScaledVector(i.invMassSolve*t,e.spatial,i.vlambda),n.vlambda.addScaledVector(n.invMassSolve*t,o.spatial,n.vlambda),i.invInertiaWorldSolve.vmult(e.rotational,r),i.wlambda.addScaledVector(t,r,i.wlambda),n.invInertiaWorldSolve.vmult(o.rotational,r),n.wlambda.addScaledVector(t,r,n.wlambda)},t.prototype.computeC=function(){return this.computeGiMGt()+this.eps},t.EquationId=0,t}(),N=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),M=function(t){function e(e,o,i){void 0===i&&(i=1e6);var r=t.call(this,e,o,0,i)||this;return r.ContactEquation_computeB_temp1=new n,r.ContactEquation_computeB_temp2=new n,r.ContactEquation_computeB_temp3=new n,r.ContactEquation_getImpactVelocityAlongNormal_vi=new n,r.ContactEquation_getImpactVelocityAlongNormal_vj=new n,r.ContactEquation_getImpactVelocityAlongNormal_xi=new n,r.ContactEquation_getImpactVelocityAlongNormal_xj=new n,r.ContactEquation_getImpactVelocityAlongNormal_relVel=new n,r.restitution=0,r.ri=new n,r.rj=new n,r.ni=new n,r}return N(e,t),e.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.bi,n=this.bj,r=this.ri,s=this.rj,a=this.ContactEquation_computeB_temp1,h=this.ContactEquation_computeB_temp2,p=i.velocity,l=i.angularVelocity,c=(i.force,i.torque,n.velocity),u=n.angularVelocity,d=(n.force,n.torque,this.ContactEquation_computeB_temp3),v=this.jacobianElementA,y=this.jacobianElementB,f=this.ni;r.cross(f,a),s.cross(f,h),f.negate(v.spatial),a.negate(v.rotational),y.spatial.copy(f),y.rotational.copy(h),d.copy(n.position),d.vadd(s,d),d.vsub(i.position,d),d.vsub(r,d);var m=f.dot(d),w=this.restitution+1;return-m*e-(w*c.dot(f)-w*p.dot(f)+u.dot(h)-l.dot(a))*o-t*this.computeGiMf()},e.prototype.getImpactVelocityAlongNormal=function(){var t=this.ContactEquation_getImpactVelocityAlongNormal_vi,e=this.ContactEquation_getImpactVelocityAlongNormal_vj,o=this.ContactEquation_getImpactVelocityAlongNormal_xi,i=this.ContactEquation_getImpactVelocityAlongNormal_xj,n=this.ContactEquation_getImpactVelocityAlongNormal_relVel;return this.bi.position.vadd(this.ri,o),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(o,t),this.bj.getVelocityAtWorldPoint(i,e),t.vsub(e,n),this.ni.dot(n)},e}(F),j=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),O=function(t){function e(e,o,i,n){void 0===n&&(n=1e6);var r=t.call(this,e,o)||this;void 0==i&&(i=e.position.distanceTo(o.position)),r.distance=i;var s=r.distanceEquation=new M(e,o);return r.equations.push(s),s.minForce=-n,s.maxForce=n,r}return j(e,t),e.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.distanceEquation,i=.5*this.distance,n=o.ni;e.position.vsub(t.position,n),n.normalize(),n.mult(i,o.ri),n.mult(-i,o.rj)},e}(S),I=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),T=function(t){function e(e,o,i,r,s){void 0===s&&(s=1e6);var a=t.call(this,e,i)||this;a.pivotA=o?o.clone():new n,a.pivotB=r?r.clone():new n;var h=a.equationX=new M(e,i),p=a.equationY=new M(e,i),l=a.equationZ=new M(e,i);return a.equations.push(h,p,l),h.minForce=p.minForce=l.minForce=-s,h.maxForce=p.maxForce=l.maxForce=s,h.ni.set(1,0,0),p.ni.set(0,1,0),l.ni.set(0,0,1),a}return I(e,t),e.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.equationX,i=this.equationY,n=this.equationZ;t.quaternion.vmult(this.pivotA,o.ri),e.quaternion.vmult(this.pivotB,o.rj),i.ri.copy(o.ri),i.rj.copy(o.rj),n.ri.copy(o.ri),n.rj.copy(o.rj)},e}(S),R=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),L=function(t){function e(e,o,i){void 0===i&&(i={});var r=t.call(this,e,o,-(i.maxForce?i.maxForce:1e6),i.maxForce?i.maxForce:1e6)||this;return r.tmpVec1=new n,r.tmpVec2=new n,r.axisA=i.axisA?i.axisA.clone():new n(1,0,0),r.axisB=i.axisB?i.axisB.clone():new n(0,1,0),r.maxAngle=Math.PI/2,r}return R(e,t),e.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.axisA,n=this.axisB,r=this.tmpVec1,s=this.tmpVec2,a=this.jacobianElementA,h=this.jacobianElementB;return i.cross(n,r),n.cross(i,s),a.rotational.copy(s),h.rotational.copy(r),-(Math.cos(this.maxAngle)-i.dot(n))*e-this.computeGW()*o-t*this.computeGiMf()},e}(F),W=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),V=function(t){function e(e,o,i){void 0===i&&(i={});var s=t.call(this,e,new n,o,new n,i.maxForce?i.maxForce:1e6)||this;s.LockConstraint_update_tmpVec1=new n,s.LockConstraint_update_tmpVec2=new n;var a=new n;e.position.vadd(o.position,a),a.scale(.5,a),o.pointToLocalFrame(a,s.pivotB),e.pointToLocalFrame(a,s.pivotA),s.xA=e.vectorToLocalFrame(r.UNIT_X),s.xB=o.vectorToLocalFrame(r.UNIT_X),s.yA=e.vectorToLocalFrame(r.UNIT_Y),s.yB=o.vectorToLocalFrame(r.UNIT_Y),s.zA=e.vectorToLocalFrame(r.UNIT_Z),s.zB=o.vectorToLocalFrame(r.UNIT_Z);var h=s.rotationalEquation1=new L(e,o,i),p=s.rotationalEquation2=new L(e,o,i),l=s.rotationalEquation3=new L(e,o,i);return s.equations.push(h,p,l),s}return W(e,t),e.prototype.update=function(){var e=this.bodyA,o=this.bodyB,i=this.rotationalEquation1,n=this.rotationalEquation2,r=this.rotationalEquation3;this.LockConstraint_update_tmpVec1,this.LockConstraint_update_tmpVec2,t.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),o.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),o.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),o.vectorToWorldFrame(this.xB,r.axisB)},e}(T),k=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),U=function(t){function e(e,o,i){void 0===i&&(i=1e6);var r=t.call(this,e,o,i)||this;return r.axisA=new n,r.axisB=new n,r.targetVelocity=0,r.maxForce=i,r.minForce=-i,r}return k(e,t),e.prototype.computeB=function(t){this.a;var e=this.b,o=this.axisA,i=this.axisB,n=this.jacobianElementA,r=this.jacobianElementB;return n.rotational.copy(o),i.negate(r.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()},e}(F),G=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),H=function(t){function e(e,o,i){void 0===i&&(i={});var r=t.call(this,e,i.pivotA?i.pivotA.clone():new n,o,i.pivotB?i.pivotB.clone():new n,i.maxForce||1e6)||this;r.HingeConstraint_update_tmpVec1=new n,r.HingeConstraint_update_tmpVec2=new n;var s=i.maxForce||1e6;return r.axisA=i.axisA?i.axisA.clone():new n(1,0,0),r.axisA.normalize(),r.axisB=i.axisB?i.axisB.clone():new n(1,0,0),r.axisB.normalize(),r.rotationalEquation1=new L(e,o,i),r.rotationalEquation2=new L(e,o,i),r.motorEquation=new U(e,o,s),r.motorEquation.enabled=!1,r.equations.push(r.rotationalEquation1,r.rotationalEquation2,r.motorEquation),r}return G(e,t),e.prototype.enableMotor=function(){this.motorEquation.enabled=!0},e.prototype.disableMotor=function(){this.motorEquation.enabled=!1},e.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},e.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t},e.prototype.update=function(){var e=this.bodyA,o=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,s=this.HingeConstraint_update_tmpVec1,a=this.HingeConstraint_update_tmpVec2,h=this.axisA,p=this.axisB;t.prototype.update.call(this),e.quaternion.vmult(h,s),o.quaternion.vmult(p,a),s.tangents(n.axisA,r.axisA),n.axisB.copy(a),r.axisB.copy(a),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),o.quaternion.vmult(this.axisB,i.axisB))},e}(T),D=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),X=function(t){function e(e,o,i){var r=t.call(this,e,o,i)||this;return r.FrictionEquation_computeB_temp1=new n,r.FrictionEquation_computeB_temp2=new n,r.ri=new n,r.rj=new n,r.t=new n,r}return D(e,t),e.prototype.computeB=function(t){this.a;var e=this.b,o=(this.bi,this.bj,this.ri),i=this.rj,n=this.FrictionEquation_computeB_temp1,r=this.FrictionEquation_computeB_temp2,s=this.t;o.cross(s,n),i.cross(s,r);var a=this.jacobianElementA,h=this.jacobianElementB;return s.negate(a.spatial),n.negate(a.rotational),h.spatial.copy(s),h.rotational.copy(r),-this.computeGW()*e-t*this.computeGiMf()},e}(M),Y=function(){function t(e){void 0===e&&(e={}),e=Object.assign({name:"default",friction:.3,restitution:.3},e),this.name=e.name,this.id=t.idCounter++,this.friction=e.friction,this.restitution=e.restitution}return t.idCounter=0,t}(),Z=function(){function t(e,o,i){void 0===i&&(i={});var n=Object.assign({friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3},i);this.id=t.idCounter++,this.materials=[e||new Y,o||new Y],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}return t.idCounter=0,t}(),Q=function(){function t(t,e,o){void 0===o&&(o={}),this.applyForce_r=new n,this.applyForce_r_unit=new n,this.applyForce_u=new n,this.applyForce_f=new n,this.applyForce_worldAnchorA=new n,this.applyForce_worldAnchorB=new n,this.applyForce_ri=new n,this.applyForce_rj=new n,this.applyForce_ri_x_f=new n,this.applyForce_rj_x_f=new n,this.applyForce_tmp=new n,o=o||{},this.restLength=void 0!=o.restLength?o.restLength:1,this.stiffness=o.stiffness||100,this.damping=o.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,o.localAnchorA&&this.localAnchorA.copy(o.localAnchorA),o.localAnchorB&&this.localAnchorB.copy(o.localAnchorB),o.worldAnchorA&&this.setWorldAnchorA(o.worldAnchorA),o.worldAnchorB&&this.setWorldAnchorB(o.worldAnchorB)}return t.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},t.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},t.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},t.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)},t.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,o=this.restLength,i=this.bodyA,n=this.bodyB,r=this.applyForce_r,s=this.applyForce_r_unit,a=this.applyForce_u,h=this.applyForce_f,p=this.applyForce_tmp,l=this.applyForce_worldAnchorA,c=this.applyForce_worldAnchorB,u=this.applyForce_ri,d=this.applyForce_rj,v=this.applyForce_ri_x_f,y=this.applyForce_rj_x_f;this.getWorldAnchorA(l),this.getWorldAnchorB(c),l.vsub(i.position,u),c.vsub(n.position,d),c.vsub(l,r);var f=r.norm();s.copy(r),s.normalize(),n.velocity.vsub(i.velocity,a),n.angularVelocity.cross(d,p),a.vadd(p,a),i.angularVelocity.cross(u,p),a.vsub(p,a),s.mult(-t*(f-o)-e*a.dot(s),h),i.force.vsub(h,i.force),n.force.vadd(h,n.force),u.cross(h,v),d.cross(h,y),i.torque.vsub(v,i.torque),n.torque.vadd(y,n.torque)},t}(),K=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),J=function(t){function e(e,o,i,r){var s=r,a=[],h=[],p=[],l=[],c=[],u=Math.cos,d=Math.sin;a.push(new n(o*u(0),o*d(0),.5*-i)),l.push(0),a.push(new n(e*u(0),e*d(0),.5*i)),c.push(1);for(var v=0;v<s;v++){var y=2*Math.PI/s*(v+1),f=2*Math.PI/s*(v+.5);v<s-1?(a.push(new n(o*u(y),o*d(y),.5*-i)),l.push(2*v+2),a.push(new n(e*u(y),e*d(y),.5*i)),c.push(2*v+3),p.push([2*v+2,2*v+3,2*v+1,2*v])):p.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&h.push(new n(u(f),d(f),0))}p.push(c),h.push(new n(0,0,1));var m=[];for(v=0;v<l.length;v++)m.push(l[l.length-v-1]);return p.push(m),t.call(this,a,p,h)||this}return K(e,t),e}(v),$=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),tt=function(t){function e(){return t.call(this,{type:l.types.PARTICLE})||this}return $(e,t),e.prototype.calculateLocalInertia=function(t,e){return(e=e||new n).set(0,0,0),e},e.prototype.volume=function(){return 0},e.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},e.prototype.calculateWorldAABB=function(t,e,o,i){o.copy(t),i.copy(t)},e}(l),et=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),ot=function(t){function e(){var e=t.call(this,{type:l.types.PLANE})||this;return e.tempNormal=new n,e.worldNormal=new n,e.worldNormalNeedsUpdate=!0,e.boundingSphereRadius=Number.MAX_VALUE,e}return et(e,t),e.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},e.prototype.calculateLocalInertia=function(t,e){return e||new n},e.prototype.volume=function(){return Number.MAX_VALUE},e.prototype.calculateWorldAABB=function(t,e,o,i){this.tempNormal.set(0,0,1),e.vmult(this.tempNormal,this.tempNormal);var n=Number.MAX_VALUE;o.set(-n,-n,-n),i.set(n,n,n),1===this.tempNormal.x&&(i.x=t.x),1===this.tempNormal.y&&(i.y=t.y),1===this.tempNormal.z&&(i.z=t.z),-1===this.tempNormal.x&&(o.x=t.x),-1===this.tempNormal.y&&(o.y=t.y),-1===this.tempNormal.z&&(o.z=t.z)},e.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE},e}(l),it=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),nt=function(t){function e(e){var o=t.call(this,{type:l.types.SPHERE})||this;if(o.radius=void 0!==e?e:1,o.radius<0)throw new Error("The sphere radius cannot be negative.");return o.updateBoundingSphereRadius(),o}return it(e,t),e.prototype.calculateLocalInertia=function(t,e){e=e||new n;var o=2*t*this.radius*this.radius/5;return e.x=o,e.y=o,e.z=o,e},e.prototype.volume=function(){return 4*Math.PI*this.radius/3},e.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},e.prototype.calculateWorldAABB=function(t,e,o,i){var n=this.radius;o.x=t.x-n,i.x=t.x+n,o.y=t.y-n,i.y=t.y+n,o.z=t.z-n,i.z=t.z+n},e}(l),rt=function(){function t(){this.equations=[]}return t.prototype.solve=function(t,e){return 0},t.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},t.prototype.removeEquation=function(t){var e=this.equations,o=e.indexOf(t);-1!==o&&e.splice(o,1)},t.prototype.removeAllEquations=function(){this.equations.length=0},t}(),st=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),at=function(t){function e(e,o){void 0===e&&(e=10),void 0===o&&(o=1e-7);var i=t.call(this)||this;return i.GSSolver_solve_lambda=[],i.GSSolver_solve_invCs=[],i.GSSolver_solve_Bs=[],i.iterations=e,i.tolerance=o,i}return st(e,t),e.prototype.solve=function(t,e){var o,i,n,r,s,a=this.iterations,h=this.tolerance*this.tolerance,p=this.equations,l=p.length,c=e.bodies,u=c.length,d=t,v=0;if(0!==l)for(var y=0;y!==u;y++)c[y].updateSolveMassProperties();var f=this.GSSolver_solve_invCs,m=this.GSSolver_solve_Bs,w=this.GSSolver_solve_lambda;f.length=l,m.length=l,w.length=l;for(var _=0;_!==l;_++){var b=p[_];w[_]=0,m[_]=b.computeB(d);var x=1/b.computeC();f[_]=isNaN(x)||!isFinite(x)?1:x}if(0!==l){for(_=0;_!==u;_++){var g=(E=c[_]).vlambda,B=E.wlambda;g.set(0,0,0),B.set(0,0,0)}for(v=0;v!==a;v++){r=0;for(var A=0;A!==l;A++)b=p[A],o=m[A],i=f[A],(s=w[A])+(n=i*(o-b.computeGWlambda()-b.eps*s))<b.minForce?n=b.minForce-s:s+n>b.maxForce&&(n=b.maxForce-s),w[A]+=n,r+=n>0?n:-n,b.addToWlambda(n);if(r*r<h)break}for(_=0;_!==u;_++){var E,P=(E=c[_]).velocity,z=E.angularVelocity;E.vlambda.vmul(E.linearFactor,E.vlambda),P.vadd(E.vlambda,P),E.wlambda.vmul(E.angularFactor,E.wlambda),z.vadd(E.wlambda,z)}var C=p.length,S=1/d;for(S=isNaN(S)||!isFinite(S)?1:S;C--;)p[C].multiplier=w[C]*S}return v},e}(rt),ht=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),pt=function(t){function e(e){var o=t.call(this)||this;for(o.SplitSolver_solve_nodes=[],o.SplitSolver_solve_nodePool=[],o.SplitSolver_solve_eqs=[],o.SplitSolver_solve_dummyWorld={bodies:[]},o.iterations=10,o.tolerance=1e-7,o.subsolver=e,o.nodes=[],o.nodePool=[];o.nodePool.length<128;)o.nodePool.push(o.createNode());return o}return ht(e,t),e.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},e.prototype.solve=function(t,e){for(var o=this.SplitSolver_solve_nodes,i=this.nodePool,n=e.bodies,r=this.equations,s=r.length,a=n.length,h=this.subsolver;i.length<a;)i.push(this.createNode());o.length=a;for(var p=0;p<a;p++)o[p]=i[p];for(p=0;p!==a;p++){var l=o[p];l.body=n[p],l.children.length=0,l.eqs.length=0,l.visited=!1}for(var c=0;c!==s;c++){var u=r[c],d=n.indexOf(u.bi),v=n.indexOf(u.bj),y=o[d],f=o[v];y.children.push(f),y.eqs.push(u),f.children.push(y),f.eqs.push(u)}var m,w=0,_=this.SplitSolver_solve_eqs;h.tolerance=this.tolerance,h.iterations=this.iterations;for(var b=this.SplitSolver_solve_dummyWorld;m=lt(o);){_.length=0,b.bodies.length=0,ut(m,dt,b.bodies,_);var x=_.length;for(_=_.sort(vt),p=0;p!==x;p++)h.addEquation(_[p]);h.solve(t,b),h.removeAllEquations(),w++}return w},e}(rt);function lt(t){for(var e=t.length,o=0;o!==e;o++){var i=t[o];if(!(i.visited||i.body.type&_.STATIC))return i}}var ct=[];function ut(t,e,o,i){for(ct.push(t),t.visited=!0,e(t,o,i);ct.length;)for(var n=ct.pop(),r=void 0;r=lt(n.children);)r.visited=!0,e(r,o,i),ct.push(r)}function dt(t,e,o){e.push(t.body);for(var i=t.eqs.length,n=0;n!==i;n++){var r=t.eqs[n];-1===o.indexOf(r)&&o.push(r)}}function vt(t,e){return e.id-t.id}var yt=function(){function t(){this.objects=[],this.type=Object}return t.prototype.release=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=t.length,i=0;i!==o;i++)this.objects.push(t[i]);return this},t.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},t.prototype.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this},t}(),ft=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),mt=function(t){function e(){var e=t.call(this)||this;return e.type=n,e}return ft(e,t),e.prototype.constructObject=function(){return new n},e}(yt),wt=function(){function t(t){this.averageNormal=new n,this.averageContactPointA=new n,this.averageContactPointB=new n,this.tmpVec1=new n,this.tmpVec2=new n,this.tmpQuat1=new p,this.tmpQuat2=new p,this.point_on_plane_to_sphere=new n,this.plane_to_sphere_ortho=new n,this.pointInPolygon_edge=new n,this.pointInPolygon_edge_x_normal=new n,this.pointInPolygon_vtp=new n,this.box_to_sphere=new n,this.sphereBox_ns=new n,this.sphereBox_ns1=new n,this.sphereBox_ns2=new n,this.sphereBox_sides=[new n,new n,new n,new n,new n,new n],this.sphereBox_sphere_to_corner=new n,this.sphereBox_side_ns=new n,this.sphereBox_side_ns1=new n,this.sphereBox_side_ns2=new n,this.convex_to_sphere=new n,this.sphereConvex_edge=new n,this.sphereConvex_edgeUnit=new n,this.sphereConvex_sphereToCorner=new n,this.sphereConvex_worldCorner=new n,this.sphereConvex_worldNormal=new n,this.sphereConvex_worldPoint=new n,this.sphereConvex_worldSpherePointClosestToPlane=new n,this.sphereConvex_penetrationVec=new n,this.sphereConvex_sphereToWorldPoint=new n,this.planeConvex_v=new n,this.planeConvex_normal=new n,this.planeConvex_relpos=new n,this.planeConvex_projected=new n,this.convexConvex_sepAxis=new n,this.convexConvex_q=new n,this.particlePlane_normal=new n,this.particlePlane_relpos=new n,this.particlePlane_projected=new n,this.particleSphere_normal=new n,this.cqj=new p,this.convexParticle_local=new n,this.convexParticle_normal=new n,this.convexParticle_penetratedFaceNormal=new n,this.convexParticle_vertexToParticle=new n,this.convexParticle_worldPenetrationVec=new n,this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new mt,this.world=t,this.currentContactMaterial=t.defaultContactMaterial,this.enableFrictionReduction=!1}return t.prototype.createContactEquation=function(t,e,o,i,n,r){var s;this.contactPointPool.length?((s=this.contactPointPool.pop()).bi=t,s.bj=e):s=new M(t,e),s.enabled=t.collisionResponse&&e.collisionResponse&&o.collisionResponse&&i.collisionResponse;var a=this.currentContactMaterial;s.restitution=a.restitution,s.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var h=o.material||t.material,p=i.material||e.material;return h&&p&&h.restitution>=0&&p.restitution>=0&&(s.restitution=h.restitution*p.restitution),s.si=n||o,s.sj=r||i,s},t.prototype.createFrictionEquationsFromContact=function(t,e){var o=t.bi,i=t.bj,n=t.si,r=t.sj,s=this.world,a=this.currentContactMaterial,h=a.friction,p=n.material||o.material,l=r.material||i.material;if(p&&l&&p.friction>=0&&l.friction>=0&&(h=p.friction*l.friction),h>0){var c=h*s.gravity.length(),u=o.invMass+i.invMass;u>0&&(u=1/u);var d=this.frictionEquationPool,v=d.length?d.pop():new X(o,i,c*u),y=d.length?d.pop():new X(o,i,c*u);return v.bi=y.bi=o,v.bj=y.bj=i,v.minForce=y.minForce=-c*u,v.maxForce=y.maxForce=c*u,v.ri.copy(t.ri),v.rj.copy(t.rj),y.ri.copy(t.ri),y.rj.copy(t.rj),t.ni.tangents(v.t,y.t),v.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,s.dt),y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,s.dt),v.enabled=y.enabled=t.enabled,e.push(v,y),!0}return!1},t.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var o=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];this.averageNormal.setZero(),this.averageContactPointA.setZero(),this.averageContactPointB.setZero();for(var n=e.bi,r=(e.bj,0);r!==t;r++)(e=this.result[this.result.length-1-r]).bi!==n?(this.averageNormal.vadd(e.ni,this.averageNormal),this.averageContactPointA.vadd(e.ri,this.averageContactPointA),this.averageContactPointB.vadd(e.rj,this.averageContactPointB)):(this.averageNormal.vsub(e.ni,this.averageNormal),this.averageContactPointA.vadd(e.rj,this.averageContactPointA),this.averageContactPointB.vadd(e.ri,this.averageContactPointB));var s=1/t;this.averageContactPointA.scale(s,o.ri),this.averageContactPointB.scale(s,o.rj),i.ri.copy(o.ri),i.rj.copy(o.rj),this.averageNormal.normalize(),this.averageNormal.tangents(o.t,i.t)}},t.prototype.getContacts=function(t,e,o,i,n,r,s){this.contactPointPool=n,this.frictionEquationPool=s,this.result=i,this.frictionResult=r;for(var a=this.tmpQuat1,h=this.tmpQuat2,p=this.tmpVec1,c=this.tmpVec2,u=0,d=t.length;u!==d;u++){var v=t[u],y=e[u],f=null;v.material&&y.material&&(f=o.getContactMaterial(v.material,y.material)||null);for(var m=!!(v.type&_.KINEMATIC&&y.type&_.STATIC||v.type&_.STATIC&&y.type&_.KINEMATIC||v.type&_.KINEMATIC&&y.type&_.KINEMATIC),w=0;w<v.shapes.length;w++){v.quaternion.mult(v.shapeOrientations[w],a),v.quaternion.vmult(v.shapeOffsets[w],p),p.vadd(v.position,p);for(var b=v.shapes[w],x=0;x<y.shapes.length;x++){y.quaternion.mult(y.shapeOrientations[x],h),y.quaternion.vmult(y.shapeOffsets[x],c),c.vadd(y.position,c);var g=y.shapes[x];if(b.collisionFilterMask&g.collisionFilterGroup&&g.collisionFilterMask&b.collisionFilterGroup&&!(p.distanceTo(c)>b.boundingSphereRadius+g.boundingSphereRadius)){var B=null;b.material&&g.material&&(B=o.getContactMaterial(b.material,g.material)||null),this.currentContactMaterial=B||f||o.defaultContactMaterial;var A=b.type<g.type,E=!1;switch(b.type|g.type){case l.types.CONVEXPOLYHEDRON|l.types.CONVEXPOLYHEDRON:E=A?this.convexConvex(b,g,p,c,a,h,v,y,b,g,m):this.convexConvex(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.CONVEXPOLYHEDRON|l.types.PARTICLE:E=A?this.convexParticle(b,g,p,c,a,h,v,y,b,g,m):this.convexParticle(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.BOX|l.types.CONVEXPOLYHEDRON:E=A?this.boxConvex(b,g,p,c,a,h,v,y,b,g,m):this.boxConvex(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.SPHERE|l.types.CONVEXPOLYHEDRON:E=A?this.sphereConvex(b,g,p,c,a,h,v,y,b,g,m):this.sphereConvex(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.BOX|l.types.BOX:E=A?this.boxBox(b,g,p,c,a,h,v,y,b,g,m):this.boxBox(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.BOX|l.types.PARTICLE:E=A?this.boxParticle(b,g,p,c,a,h,v,y,b,g,m):this.boxParticle(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.SPHERE|l.types.BOX:E=A?this.sphereBox(b,g,p,c,a,h,v,y,b,g,m):this.sphereBox(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.SPHERE|l.types.SPHERE:E=A?this.sphereSphere(b,g,p,c,a,h,v,y,b,g,m):this.sphereSphere(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.SPHERE|l.types.PLANE:E=A?this.spherePlane(b,g,p,c,a,h,v,y,b,g,m):this.spherePlane(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.SPHERE|l.types.PARTICLE:E=A?this.sphereParticle(b,g,p,c,a,h,v,y,b,g,m):this.sphereParticle(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.PLANE|l.types.BOX:E=A?this.planeBox(b,g,p,c,a,h,v,y,b,g,m):this.planeBox(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.PLANE|l.types.CONVEXPOLYHEDRON:E=A?this.planeConvex(b,g,p,c,a,h,v,y,b,g,m):this.planeConvex(g,b,c,p,h,a,y,v,b,g,m);break;case l.types.PLANE|l.types.PARTICLE:E=A?this.planeParticle(b,g,p,c,a,h,v,y,b,g,m):this.planeParticle(g,b,c,p,h,a,y,v,b,g,m)}E&&m&&(o.shapeOverlapKeeper.set(b.id,g.id),o.bodyOverlapKeeper.set(v.id,y.id))}}}}},t.prototype.boxBox=function(t,e,o,i,n,r,s,a,h,p,l){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,o,i,n,r,s,a,t,e,l)},t.prototype.boxConvex=function(t,e,o,i,n,r,s,a,h,p,l){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,o,i,n,r,s,a,t,e,l)},t.prototype.boxParticle=function(t,e,o,i,n,r,s,a,h,p,l){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,o,i,n,r,s,a,t,e,l)},t.prototype.sphereSphere=function(t,e,o,i,n,r,s,a,h,p,l){var c=t,u=e;if(l)return o.distanceSquared(i)<Math.pow(c.radius+u.radius,2);var d=this.createContactEquation(s,a,t,e,h,p);return i.vsub(o,d.ni),d.ni.normalize(),d.ri.copy(d.ni),d.rj.copy(d.ni),d.ri.mult(c.radius,d.ri),d.rj.mult(-u.radius,d.rj),d.ri.vadd(o,d.ri),d.ri.vsub(s.position,d.ri),d.rj.vadd(i,d.rj),d.rj.vsub(a.position,d.rj),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult),!1},t.prototype.spherePlane=function(t,e,o,i,n,r,s,a,h,p,l){var c=this.createContactEquation(s,a,t,e,h,p);c.ni.set(0,0,1),r.vmult(c.ni,c.ni),c.ni.negate(c.ni),c.ni.normalize();var u=t;if(c.ni.mult(u.radius,c.ri),o.vsub(i,this.point_on_plane_to_sphere),c.ni.mult(c.ni.dot(this.point_on_plane_to_sphere),this.plane_to_sphere_ortho),this.point_on_plane_to_sphere.vsub(this.plane_to_sphere_ortho,c.rj),-this.point_on_plane_to_sphere.dot(c.ni)<=u.radius){if(l)return!0;var d=c.ri,v=c.rj;d.vadd(o,d),d.vsub(s.position,d),v.vadd(i,v),v.vsub(a.position,v),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}return!1},t.prototype.pointInPolygon=function(t,e,o){for(var i=null,n=t.length,r=0;r!==n;r++){var s=t[r],a=this.pointInPolygon_edge;t[(r+1)%n].vsub(s,a);var h=this.pointInPolygon_edge_x_normal;a.cross(e,h);var p=this.pointInPolygon_vtp;o.vsub(s,p);var l=h.dot(p);if(!(null===i||l>0&&!0===i||l<=0&&!1===i))return!1;null===i&&(i=l>0)}return!0},t.prototype.sphereBox=function(t,e,o,i,n,r,s,a,h,p,l){var c=this.v3pool,u=t,d=e,v=this.sphereBox_sides;o.vsub(i,this.box_to_sphere),d.getSideNormals(v,r);for(var y=u.radius,f=!1,m=this.sphereBox_side_ns,w=this.sphereBox_side_ns1,_=this.sphereBox_side_ns2,b=null,x=0,g=0,B=0,A=null,E=0,P=v.length;E!==P&&!1===f;E++){var z=this.sphereBox_ns;z.copy(v[E]);var C=z.norm();z.normalize();var S=this.box_to_sphere.dot(z);if(S<C+y&&S>0){var q=this.sphereBox_ns1,F=this.sphereBox_ns2;q.copy(v[(E+1)%3]),F.copy(v[(E+2)%3]);var N=q.norm(),M=F.norm();q.normalize(),F.normalize();var j=this.box_to_sphere.dot(q),O=this.box_to_sphere.dot(F);if(j<N&&j>-N&&O<M&&O>-M){var I=Math.abs(S-C-y);if((null===A||I<A)&&(A=I,g=j,B=O,b=C,m.copy(z),w.copy(q),_.copy(F),x++,l))return!0}}}if(x){f=!0;var T=this.createContactEquation(s,a,t,e,h,p);m.mult(-y,T.ri),T.ni.copy(m),T.ni.negate(T.ni),m.mult(b,m),w.mult(g,w),m.vadd(w,m),_.mult(B,_),m.vadd(_,T.rj),T.ri.vadd(o,T.ri),T.ri.vsub(s.position,T.ri),T.rj.vadd(i,T.rj),T.rj.vsub(a.position,T.rj),this.result.push(T),this.createFrictionEquationsFromContact(T,this.frictionResult)}for(var R=c.get(),L=this.sphereBox_sphere_to_corner,W=0;2!==W&&!f;W++)for(var V=0;2!==V&&!f;V++)for(var k=0;2!==k&&!f;k++)if(R.set(0,0,0),W?R.vadd(v[0],R):R.vsub(v[0],R),V?R.vadd(v[1],R):R.vsub(v[1],R),k?R.vadd(v[2],R):R.vsub(v[2],R),i.vadd(R,L),L.vsub(o,L),L.norm2()<y*y){if(l)return!0;f=!0,(T=this.createContactEquation(s,a,t,e,h,p)).ri.copy(L),T.ri.normalize(),T.ni.copy(T.ri),T.ri.mult(y,T.ri),T.rj.copy(R),T.ri.vadd(o,T.ri),T.ri.vsub(s.position,T.ri),T.rj.vadd(i,T.rj),T.rj.vsub(a.position,T.rj),this.result.push(T),this.createFrictionEquationsFromContact(T,this.frictionResult)}c.release(R),R=null;var U=c.get(),G=c.get(),H=c.get(),D=c.get(),X=c.get(),Y=v.length;for(W=0;W!==Y&&!f;W++)for(V=0;V!==Y&&!f;V++)if(W%3!=V%3){v[V].cross(v[W],U),U.normalize(),v[W].vadd(v[V],G),H.copy(o),H.vsub(G,H),H.vsub(i,H);var Z=H.dot(U);for(U.mult(Z,D),k=0;k===W%3||k===V%3;)k++;X.copy(o),X.vsub(D,X),X.vsub(G,X),X.vsub(i,X);var Q=Math.abs(Z),K=X.norm();if(Q<v[k].norm()&&K<y){if(l)return!0;f=!0;var J=this.createContactEquation(s,a,t,e,h,p);G.vadd(D,J.rj),J.rj.copy(J.rj),X.negate(J.ni),J.ni.normalize(),J.ri.copy(J.rj),J.ri.vadd(i,J.ri),J.ri.vsub(o,J.ri),J.ri.normalize(),J.ri.mult(y,J.ri),J.ri.vadd(o,J.ri),J.ri.vsub(s.position,J.ri),J.rj.vadd(i,J.rj),J.rj.vsub(a.position,J.rj),this.result.push(J),this.createFrictionEquationsFromContact(J,this.frictionResult)}}return c.release(U,G,H,D,X),!1},t.prototype.sphereConvex=function(t,e,o,i,n,r,s,a,h,p,l){var c=this.v3pool,u=t,d=e;o.vsub(i,this.convex_to_sphere);for(var v=d.faceNormals,y=d.faces,f=d.vertices,m=u.radius,w=0;w!==f.length;w++){var _=f[w],b=this.sphereConvex_worldCorner;r.vmult(_,b),i.vadd(b,b);var x=this.sphereConvex_sphereToCorner;if(b.vsub(o,x),x.norm2()<m*m)return!!l||((I=this.createContactEquation(s,a,t,e,h,p)).ri.copy(x),I.ri.normalize(),I.ni.copy(I.ri),I.ri.mult(m,I.ri),b.vsub(i,I.rj),I.ri.vadd(o,I.ri),I.ri.vsub(s.position,I.ri),I.rj.vadd(i,I.rj),I.rj.vsub(a.position,I.rj),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult),!1)}for(var g=!1,B=(w=0,y.length);w!==B&&!1===g;w++){var A=v[w],E=y[w],P=this.sphereConvex_worldNormal;r.vmult(A,P);var z=this.sphereConvex_worldPoint;r.vmult(f[E[0]],z),z.vadd(i,z);var C=this.sphereConvex_worldSpherePointClosestToPlane;P.mult(-m,C),o.vadd(C,C);var S=this.sphereConvex_penetrationVec;C.vsub(z,S);var q=S.dot(P),F=this.sphereConvex_sphereToWorldPoint;if(o.vsub(z,F),q<0&&F.dot(P)>0){for(var N=[],M=0,j=E.length;M!==j;M++){var O=c.get();r.vmult(f[E[M]],O),i.vadd(O,O),N.push(O)}if(this.pointInPolygon(N,P,o)){if(l)return!0;g=!0;var I=this.createContactEquation(s,a,t,e,h,p);P.mult(-m,I.ri),P.negate(I.ni);var T=c.get();P.mult(-q,T);var R=c.get();P.mult(-m,R),o.vsub(i,I.rj),I.rj.vadd(R,I.rj),I.rj.vadd(T,I.rj),I.rj.vadd(i,I.rj),I.rj.vsub(a.position,I.rj),I.ri.vadd(o,I.ri),I.ri.vsub(s.position,I.ri),c.release(T),c.release(R),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult),M=0;for(var L=N.length;M!==L;M++)c.release(N[M]);return!1}for(M=0;M!==E.length;M++){var W=c.get(),V=c.get();r.vmult(f[E[(M+1)%E.length]],W),r.vmult(f[E[(M+2)%E.length]],V),i.vadd(W,W),i.vadd(V,V);var k=this.sphereConvex_edge;V.vsub(W,k);var U=this.sphereConvex_edgeUnit;k.unit(U);var G=c.get(),H=c.get();o.vsub(W,H);var D=H.dot(U);U.mult(D,G),G.vadd(W,G);var X=c.get();if(G.vsub(o,X),D>0&&D*D<k.norm2()&&X.norm2()<m*m){if(l)return!0;I=this.createContactEquation(s,a,t,e,h,p),G.vsub(i,I.rj),G.vsub(o,I.ni),I.ni.normalize(),I.ni.mult(m,I.ri),I.rj.vadd(i,I.rj),I.rj.vsub(a.position,I.rj),I.ri.vadd(o,I.ri),I.ri.vsub(s.position,I.ri),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult);var Y=0;for(L=N.length;Y!==L;Y++)c.release(N[Y]);return c.release(W),c.release(V),c.release(G),c.release(X),c.release(H),!1}c.release(W),c.release(V),c.release(G),c.release(X),c.release(H)}for(M=0,L=N.length;M!==L;M++)c.release(N[M])}}return!1},t.prototype.planeBox=function(t,e,o,i,n,r,s,a,h,p,l){var c=e;return c.convexPolyhedronRepresentation.material=e.material,c.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,c.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,c.convexPolyhedronRepresentation,o,i,n,r,s,a,t,e,l)},t.prototype.planeConvex=function(t,e,o,i,n,r,s,a,h,p,l){var c=t,u=e,d=o,v=i,y=n,f=r,m=s,w=a,_=this.planeConvex_v,b=this.planeConvex_normal;b.set(0,0,1),y.vmult(b,b);for(var x=0,g=this.planeConvex_relpos,B=0;B!==u.vertices.length;B++)if(_.copy(u.vertices[B]),f.vmult(_,_),v.vadd(_,_),_.vsub(d,g),b.dot(g)<=0){if(l)return!0;var A=this.createContactEquation(m,w,c,u,h,p),E=this.planeConvex_projected;b.mult(b.dot(g),E),_.vsub(E,E),E.vsub(d,A.ri),A.ni.copy(b),_.vsub(v,A.rj),A.ri.vadd(d,A.ri),A.ri.vsub(m.position,A.ri),A.rj.vadd(v,A.rj),A.rj.vsub(w.position,A.rj),this.result.push(A),x++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(A,this.frictionResult)}return this.enableFrictionReduction&&x&&this.createFrictionFromAverage(x),!1},t.prototype.convexConvex=function(t,e,o,i,n,r,s,a,h,p,l,c,u){var d=this.convexConvex_sepAxis;if(o.distanceTo(i)>t.boundingSphereRadius+e.boundingSphereRadius)return!1;var v=t,y=0;if(v.findSeparatingAxis(e,o,n,i,r,d,c,u)){var f=[],m=this.convexConvex_q;v.clipAgainstHull(o,n,e,i,r,d,-100,100,f);for(var w=0;w!==f.length;w++){if(l)return!0;var _=this.createContactEquation(s,a,t,e,h,p),b=_.ri,x=_.rj;d.negate(_.ni),f[w].normal.negate(m),m.mult(f[w].depth,m),f[w].point.vadd(m,b),x.copy(f[w].point),b.vsub(o,b),x.vsub(i,x),b.vadd(o,b),b.vsub(s.position,b),x.vadd(i,x),x.vsub(a.position,x),this.result.push(_),y++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(_,this.frictionResult)}this.enableFrictionReduction&&y&&this.createFrictionFromAverage(y)}return y>0},t.prototype.planeParticle=function(t,e,o,i,n,r,s,a,h,p,l){var c=this.particlePlane_normal;c.set(0,0,1),a.quaternion.vmult(c,c);var u=this.particlePlane_relpos;if(o.vsub(a.position,u),c.dot(u)<=0){if(l)return!0;var d=this.createContactEquation(s,a,t,e,h,p);d.ni.copy(c),d.ni.negate(d.ni),d.ri.set(0,0,0);var v=this.particlePlane_projected;c.mult(c.dot(o),v),o.vsub(v,v),d.rj.copy(v),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}return!1},t.prototype.sphereParticle=function(t,e,o,i,n,r,s,a,h,p,l){var c=e,u=this.particleSphere_normal;if(u.set(0,0,1),o.vsub(i,u),u.norm2()<=c.radius*c.radius){if(l)return!0;var d=this.createContactEquation(s,a,t,e,h,p);u.normalize(),d.rj.copy(u),d.rj.mult(c.radius,d.rj),d.ni.copy(u),d.ni.negate(d.ni),d.ri.set(0,0,0),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}return!1},t.prototype.convexParticle=function(t,e,o,i,n,r,s,a,h,p,l){var c=-1,u=this.convexParticle_penetratedFaceNormal,d=this.convexParticle_worldPenetrationVec,v=null,y=e,f=this.convexParticle_local;if(f.copy(o),f.vsub(i,f),r.conjugate(this.cqj),this.cqj.vmult(f,f),y.pointIsInside(f)){y.worldVerticesNeedsUpdate&&y.computeWorldVertices(i,r),y.worldFaceNormalsNeedsUpdate&&y.computeWorldFaceNormals(r);for(var m=0,w=y.faces.length;m!==w;m++){var _=[y.worldVertices[y.faces[m][0]]],b=y.worldFaceNormals[m];o.vsub(_[0],this.convexParticle_vertexToParticle);var x=-b.dot(this.convexParticle_vertexToParticle);if(null===v||Math.abs(x)<Math.abs(v)){if(l)return!0;v=x,c=m,u.copy(b)}}if(-1!==c){var g=this.createContactEquation(s,a,t,e,h,p);u.mult(v,d),d.vadd(o,d),d.vsub(i,d),g.rj.copy(d),u.negate(g.ni),g.ri.set(0,0,0);var B=g.ri,A=g.rj;B.vadd(o,B),B.vsub(s.position,B),A.vadd(i,A),A.vsub(a.position,A),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}return!1},t}(),_t=function(){function t(){this.data={keys:[]}}return t.prototype.get=function(t,e){if(t>e){var o=e;e=t,t=o}return this.data[t+"-"+e]},t.prototype.set=function(t,e,o){if(t>e){var i=e;e=t,t=i}var n=t+"-"+e;this.get(t,e)||this.data.keys.push(n),this.data[n]=o},t.prototype.reset=function(){for(var t=this.data,e=t.keys;e.length>0;)delete t[e.pop()]},t}(),bt=function(){function t(){this.current=[],this.previous=[]}return t.prototype.getKey=function(t,e){if(e<t){var o=e;e=t,t=o}return t<<16|e},t.prototype.set=function(t,e){for(var o=this.getKey(t,e),i=this.current,n=0;o>i[n];)n++;if(o!==i[n]){for(var r=i.length-1;r>=n;r--)i[r+1]=i[r];i[n]=o}},t.prototype.tick=function(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0},t.prototype.getDiff=function(t,e){for(var o=this.current,i=this.previous,n=o.length,r=i.length,s=0,a=0;a<n;a++){for(var h=o[a];h>i[s];)s++;h===i[s]||xt(t,h)}for(s=0,a=0;a<r;a++){for(var p=i[a];p>o[s];)s++;o[s]===p||xt(e,p)}},t}();function xt(t,e){t.push((4294901760&e)>>16,65535&e)}var gt=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),Bt=function(t){function e(e){var o=t.call(this)||this;return o.gravity=new n,o.tmpRay=new P,o.removeBody=function(t){return o.remove(t)},o.World_step_preStepEvent={type:"preStep"},o.World_step_collideEvent={type:_.COLLIDE_EVENT_NAME,body:null,contact:null},o.World_step_oldContacts=[],o.World_step_frictionEquationPool=[],o.World_step_p1=[],o.World_step_p2=[],o.World_step_postStepEvent={type:"postStep"},o.emitContactEvents=function(){var t=[],e=[],i={type:"beginContact",bodyA:null,bodyB:null},n={type:"endContact",bodyA:null,bodyB:null},r={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},s={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};return function(){var a=o.hasAnyEventListener("beginContact"),h=o.hasAnyEventListener("endContact");if((a||h)&&o.bodyOverlapKeeper.getDiff(t,e),a)for(var p=0,l=t.length;p<l;p+=2)i.bodyA=o.getBodyById(t[p]),i.bodyB=o.getBodyById(t[p+1]),i.bodyA&&i.bodyB&&o.dispatchEvent(i),i.bodyA=i.bodyB=void 0;if(h)for(p=0,l=e.length;p<l;p+=2)n.bodyA=o.getBodyById(e[p]),n.bodyB=o.getBodyById(e[p+1]),n.bodyA&&n.bodyB&&o.dispatchEvent(n),n.bodyA=n.bodyB=void 0;t.length=e.length=0;var c=o.hasAnyEventListener("beginShapeContact"),u=o.hasAnyEventListener("endShapeContact");if((c||u)&&o.shapeOverlapKeeper.getDiff(t,e),c)for(p=0,l=t.length;p<l;p+=2){var d=o.getShapeById(t[p]),v=o.getShapeById(t[p+1]);r.shapeA=d,r.shapeB=v,r.bodyA=d.body,r.bodyB=v.body,o.dispatchEvent(r),r.shapeA=r.shapeB=void 0,r.bodyA=r.bodyB=void 0}if(u)for(p=0,l=e.length;p<l;p+=2)d=o.getShapeById(e[p]),v=o.getShapeById(e[p+1]),s.shapeA=d,s.shapeB=v,s.bodyA=d.body,s.bodyB=v.body,o.dispatchEvent(s),s.shapeA=s.shapeB=void 0,s.bodyA=s.bodyB=void 0}()},e=e||{},o.dt=-1,o.allowSleep=e.allowSleep,o.contacts=[],o.frictionEquations=[],o.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,o.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,o.time=0,o.stepnumber=0,o.default_dt=1/60,o.nextId=0,o.gravity=e.gravity?o.gravity.copy(e.gravity):new n,o.broadphase=e.broadphase?e.broadphase:new A,o.bodies=[],o.solver=e.solver?e.solver:new at,o.constraints=[],o.narrowphase=new wt(o),o.collisionMatrix=new a,o.collisionMatrixPrevious=new a,o.bodyOverlapKeeper=new bt,o.shapeOverlapKeeper=new bt,o.materials=[],o.contactmaterials=[],o.contactMaterialTable=new _t,o.defaultMaterial=new Y({name:"default"}),o.defaultContactMaterial=new Z(o.defaultMaterial,o.defaultMaterial,{friction:1,restitution:0}),o.doProfiling=!1,o.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},o.accumulator=0,o.subsystems=[],o.addBodyEvent={type:"addBody",body:null},o.removeBodyEvent={type:"removeBody",body:null},o.idToBodyMap={},o.broadphase.setWorld(o),o}return gt(e,t),e.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},e.prototype.numObjects=function(){return this.bodies.length},e.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},e.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof _&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))},e.prototype.addConstraint=function(t){this.constraints.push(t)},e.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},e.prototype.rayTest=function(t,e,o){o instanceof E?this.raycastClosest(t,e,{skipBackfaces:!0},o):this.raycastAll(t,e,{skipBackfaces:!0},o)},e.prototype.raycastAll=function(t,e,o,i){return o.mode=P.ALL,o.from=t,o.to=e,o.callback=i,this.tmpRay.intersectWorld(this,o)},e.prototype.raycastAny=function(t,e,o,i){return o.mode=P.ANY,o.from=t,o.to=e,o.result=i,this.tmpRay.intersectWorld(this,o)},e.prototype.raycastClosest=function(t,e,o,i){return o.mode=P.CLOSEST,o.from=t,o.to=e,o.result=i,this.tmpRay.intersectWorld(this,o)},e.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,o=this.bodies,i=o.indexOf(t);if(-1!==i){o.splice(i,1);for(var n=0;n!==o.length;n++)o[n].index=n;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete this.idToBodyMap[t.id],this.dispatchEvent(this.removeBodyEvent)}},e.prototype.getBodyById=function(t){return this.idToBodyMap[t]},e.prototype.getShapeById=function(t){for(var e=this.bodies,o=0,i=e.length;o<i;o++)for(var n=e[o].shapes,r=0,s=n.length;r<s;r++){var a=n[r];if(a.id===t)return a}},e.prototype.addMaterial=function(t){this.materials.push(t)},e.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},e.prototype.step=function(t,e,o){if(o=o||10,-1===(e=e||-1))this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var i=0;this.accumulator>=t&&i<o;)this.internalStep(t),this.accumulator-=t,i++;this.accumulator%=t;for(var n=this.accumulator/t,r=this.bodies.length,s=0;s!==r;s++){var a=this.bodies[s];a.previousPosition.lerp(a.position,n,a.interpolatedPosition),a.previousQuaternion.slerp(a.quaternion,n,a.interpolatedQuaternion),a.previousQuaternion.normalize()}this.time+=e}},e.prototype.internalStep=function(t){this.dt=t;var e,o,i=this.contacts,n=this.World_step_p1,r=this.World_step_p2,s=this.numObjects(),a=this.bodies,h=this.solver,p=this.gravity,l=this.doProfiling,c=this.profile,u=_.DYNAMIC,d=this.constraints,v=this.World_step_frictionEquationPool,y=p.x,f=p.y,m=p.z,w=0;for(l&&(e=performance.now()),w=0;w!==s;w++)if((S=a[w]).type===u){var b=S.force,x=S.mass;b.x+=x*y,b.y+=x*f,b.z+=x*m}for(w=0,o=this.subsystems.length;w!==o;w++)this.subsystems[w].update();l&&(e=performance.now()),n.length=0,r.length=0,this.broadphase.collisionPairs(this,n,r),l&&(c.broadphase=performance.now()-e);var g=d.length;for(w=0;w!==g;w++)if(!(j=d[w]).collideConnected)for(var B=n.length-1;B>=0;B-=1)(j.bodyA===n[B]&&j.bodyB===r[B]||j.bodyB===n[B]&&j.bodyA===r[B])&&(n.splice(B,1),r.splice(B,1));this.collisionMatrixTick(),l&&(e=performance.now());var A=this.World_step_oldContacts,E=i.length;for(w=0;w!==E;w++)A.push(i[w]);i.length=0;var P=this.frictionEquations.length;for(w=0;w!==P;w++)v.push(this.frictionEquations[w]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(n,r,this,i,A,this.frictionEquations,v),l&&(c.narrowphase=performance.now()-e),l&&(e=performance.now()),w=0;w<this.frictionEquations.length;w++)h.addEquation(this.frictionEquations[w]);for(var z=i.length,C=0;C!==z;C++){var S=(j=i[C]).bi,q=j.bj,F=j.si,N=j.sj;(S.material&&q.material&&this.getContactMaterial(S.material,q.material)||this.defaultContactMaterial).friction,S.material&&q.material&&(S.material.friction>=0&&q.material.friction>=0&&(S.material.friction,q.material.friction),S.material.restitution>=0&&q.material.restitution>=0&&(j.restitution=S.material.restitution*q.material.restitution)),h.addEquation(j),S.allowSleep&&S.type===_.DYNAMIC&&S.sleepState===_.SLEEPING&&q.sleepState===_.AWAKE&&q.type!==_.STATIC&&q.velocity.norm2()+q.angularVelocity.norm2()>=2*Math.pow(q.sleepSpeedLimit,2)&&(S._wakeUpAfterNarrowphase=!0),q.allowSleep&&q.type===_.DYNAMIC&&q.sleepState===_.SLEEPING&&S.sleepState===_.AWAKE&&S.type!==_.STATIC&&S.velocity.norm2()+S.angularVelocity.norm2()>=2*Math.pow(S.sleepSpeedLimit,2)&&(q._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(S,q,!0),this.collisionMatrixPrevious.get(S,q)||(this.World_step_collideEvent.body=q,this.World_step_collideEvent.contact=j,S.dispatchEvent(this.World_step_collideEvent),this.World_step_collideEvent.body=S,q.dispatchEvent(this.World_step_collideEvent)),this.bodyOverlapKeeper.set(S.id,q.id),this.shapeOverlapKeeper.set(F.id,N.id)}for(this.emitContactEvents(),l&&(c.makeContactConstraints=performance.now()-e,e=performance.now()),w=0;w!==s;w++)(S=a[w])._wakeUpAfterNarrowphase&&(S.wakeUp(),S._wakeUpAfterNarrowphase=!1);var M=d.length;for(w=0;w!==M;w++){var j;(j=d[w]).update(),B=0;for(var O=j.equations.length;B!==O;B++){var I=j.equations[B];h.addEquation(I)}}h.solve(t,this),l&&(c.solve=performance.now()-e),h.removeAllEquations();var T=Math.pow;for(w=0;w!==s;w++)if((S=a[w]).type&u){var R=T(1-S.linearDamping,t),L=S.velocity;L.mult(R,L);var W=S.angularVelocity;if(W){var V=T(1-S.angularDamping,t);W.mult(V,W)}}for(this.dispatchEvent(this.World_step_preStepEvent),w=0;w!==s;w++)(S=a[w]).preStep&&S.preStep.call(S);l&&(e=performance.now());var k=this.stepnumber%(this.quatNormalizeSkip+1)==0,U=this.quatNormalizeFast;for(w=0;w!==s;w++)a[w].integrate(t,k,U);for(this.clearForces(),this.broadphase.dirty=!0,l&&(c.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(this.World_step_postStepEvent),w=0;w!==s;w++){var G=(S=a[w]).postStep;G&&G.call(S)}if(this.allowSleep)for(w=0;w!==s;w++)a[w].sleepTick(this.time)},e.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,o=0;o!==e;o++){var i=t[o];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}},e}(h);o.d(e,"AABB",function(){return s}),o.d(e,"ArrayCollisionMatrix",function(){return a}),o.d(e,"Broadphase",function(){return b}),o.d(e,"GridBroadphase",function(){return g}),o.d(e,"NaiveBroadphase",function(){return A}),o.d(e,"Ray",function(){return P}),o.d(e,"RaycastResult",function(){return E}),o.d(e,"SAPBroadphase",function(){return C}),o.d(e,"Constraint",function(){return S}),o.d(e,"DistanceConstraint",function(){return O}),o.d(e,"LockConstraint",function(){return V}),o.d(e,"PointToPointConstraint",function(){return T}),o.d(e,"HingeConstraint",function(){return H}),o.d(e,"ContactEquation",function(){return M}),o.d(e,"Equation",function(){return F}),o.d(e,"FrictionEquation",function(){return X}),o.d(e,"RotationalEquation",function(){return L}),o.d(e,"RotationalMotorEquation",function(){return U}),o.d(e,"ContactMaterial",function(){return Z}),o.d(e,"Material",function(){return Y}),o.d(e,"Quaternion",function(){return p}),o.d(e,"Mat3",function(){return i}),o.d(e,"Transform",function(){return c}),o.d(e,"Vec3",function(){return n}),o.d(e,"Vec3Consts",function(){return r}),o.d(e,"JacobianElement",function(){return q}),o.d(e,"BodyOptions",function(){return w}),o.d(e,"Body",function(){return _}),o.d(e,"Spring",function(){return Q}),o.d(e,"Box",function(){return f}),o.d(e,"HullResult",function(){return d}),o.d(e,"ConvexPolyhedron",function(){return v}),o.d(e,"Cylinder",function(){return J}),o.d(e,"Particle",function(){return tt}),o.d(e,"Plane",function(){return ot}),o.d(e,"Shape",function(){return l}),o.d(e,"Sphere",function(){return nt}),o.d(e,"GSSolver",function(){return at}),o.d(e,"Solver",function(){return rt}),o.d(e,"SplitSolver",function(){return pt}),o.d(e,"Pool",function(){return yt}),o.d(e,"EventTarget",function(){return h}),o.d(e,"Vec3Pool",function(){return mt}),o.d(e,"Narrowphase",function(){return wt}),o.d(e,"World",function(){return Bt})}])});