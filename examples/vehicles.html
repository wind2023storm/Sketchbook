<!DOCTYPE html>
<html>

<head>
    <title>Sketchbook - Characters</title>
    <link href="https://fonts.googleapis.com/css?family=Cutive+Mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Averia+Sans+Libre:300,400,700" rel="stylesheet">
</head>

<body>

    <div class="github-corner" style="display: none"><a href="https://github.com/swift502/Sketchbook" target="_blank" title="Fork me on GitHub"><svg viewbox="0 0 100 100" fill="currentColor"><title>Fork me on GitHub</title><path d="M0 0v100h100V0H0zm60 70.2h.2c1 2.7.3 4.7 0 5.2 1.4 1.4 2 3 2 5.2 0 7.4-4.4 9-8.7 9.5.7.7 1.3 2 1.3 3.7V99c0 .5 1.4 1 1.4 1H44s1.2-.5 1.2-1v-3.8c-3.5 1.4-5.2-.8-5.2-.8-1.5-2-3-2-3-2-2-.5-.2-1-.2-1 2-.7 3.5.8 3.5.8 2 1.7 4 1 5 .3.2-1.2.7-2 1.2-2.4-4.3-.4-8.8-2-8.8-9.4 0-2 .7-4 2-5.2-.2-.5-1-2.5.2-5 0 0 1.5-.6 5.2 1.8 1.5-.4 3.2-.6 4.8-.6 1.6 0 3.3.2 4.8.7 2.8-2 4.4-2 5-2z"></path></svg></a></div><style> .github-corner{position:absolute;left:0;top:0;width:120px;height:120px;overflow:hidden;}.github-corner a{position:absolute;right:0;top:0;left:0;bottom:0;transform:translate(-50%, -50%) rotate(-45deg);color:#000000;}</style>
            
    <div id="loader">
        Loading...
    </div>

    <div id="controls-menu" class="controls-card" style="display: none">
        <div class="controls-ctrl"><span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span><span class="ctrl-desc"></span>movement</span></div>
        <div class="controls-ctrl"><span class="key">Space</span><span class="ctrl-desc"></span>jump</span></div>
        <div class="controls-ctrl"><span class="key">Shift</span><span class="ctrl-desc">sprint</span></div>
        <div class="controls-ctrl"><span class="key">F</span><span class="ctrl-desc"></span>enter/exit vehicle</span></div>
        <div class="controls-ctrl"><span class="key">Shift</span>&nbsp;+&nbsp;<span class="key">C</span><span class="ctrl-desc"></span>free camera</span></div>
    </div>
    
    <script src="/build/sketchbook.min.js"></script>
    <script>
        const SB = Sketchbook;

        //
        // Initialize
        //

        // Instantiate loaders
        const fbxLoader = new SB.FBXLoader();
        const gltfLoader = new SB.GLTFLoader();

        // Initialize sketchbook
        let world = new SB.World();
        world.addFloor();

        var gridHelper = new SB.THREE.GridHelper( 100, 50, 0x888888, 0xbbbbbb );
        gridHelper.position.y = 1.01;
        world.graphicsWorld.add( gridHelper );

        // Hide ui for loading
        document.getElementsByClassName('dg ac')[0].style.display = 'none';
        document.getElementsByClassName('statsBox')[0].style.display = 'none';

        // Setup camera
        world.cameraController.theta = 360;
        world.cameraController.target.z = -3;
        world.cameraController.target.y = 2;

        //
        // Load characters
        //

        // Spawn player
        let player = new SB.Character();
        LoadBoxmanModel(player);
        world.add(player);
        player.takeControl();

        // Make player look at the camera
        player.setOrientationTarget(new SB.THREE.Vector3(0, 0, -1));
        player.orientation = new SB.THREE.Vector3(0, 0, -1);

        //
        // Functions
        //

        function LoadBoxmanModel(character) {	
            fbxLoader.load('../build/graphics/game_man/game_man.fbx', function (object) {	
                object.traverse(function (child) {	
                    if (child.isMesh) {	
                        child.castShadow = true;	
                        child.receiveShadow = true;	
                    }	
                    if (child.name == 'game_man') {	
                        child.material = new SB.THREE.MeshLambertMaterial({	
                            map: new SB.THREE.TextureLoader().load('../build/graphics/game_man/game_man.png'),	
                            skinning: true	
                        });	
                    }	
                });	
                character.setModel(object);	
                character.setModelOffset(new SB.THREE.Vector3(0, -0.1, 0));	

                // Hide loader, display ui
                document.getElementsByClassName('dg ac')[0].style.display = 'block';
                document.getElementsByClassName('statsBox')[0].style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                document.getElementsByClassName('github-corner')[0].style.display = 'block';
                document.getElementById('controls-menu').style.display = 'flex';
            });	
        }

        let car = new SB.Car();
        car.position.y = 3;
        // car.fromGLTF();

        let carCollision = new SB.CANNON.Body({
            mass: 1
        });
        carCollision.position.y = 3;

        // Load a glTF resource
        gltfLoader.load('../build/graphics/car.glb',
            function ( gltf ) {
                
                var objectDict = {};

                console.log(gltf);

                // Set car model
                car.setModel(gltf.scene);

                gltf.scene.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }

                    if (child.hasOwnProperty('userData'))
                    {
                        if(child.userData.hasOwnProperty('data'))
                        {
                            if(child.userData.data === 'wheel')
                            {
                                var wheel = new SB.Wheel();

                                if(child.userData.hasOwnProperty('facing')) 
                                {
                                    wheel.facing = child.userData.facing;
                                }
                                if(child.userData.hasOwnProperty('steering')) 
                                {
                                    wheel.steering = (child.userData.steering == "true");
                                }

                                car.wheels.push(wheel);
                            }
                            if(child.userData.data === 'seat')
                            {
                                var seat = new SB.Seat();
                                seat.object = child;

                                if(child.userData.hasOwnProperty('door')) 
                                {
                                    console.log(child.userData.door);
                                    seat.door = gltf.scene.getObjectByName(child.userData.door);
                                }
                                if(child.userData.hasOwnProperty('entry_point')) 
                                {
                                    seat.entryPoint = gltf.scene.getObjectByName(child.userData.entry_point);
                                }
                                if(child.userData.hasOwnProperty('type')) 
                                {
                                    seat.type = child.userData.type;
                                }

                                car.seats.push(seat);
                            }
                            if(child.userData.data === 'collision')
                            {
                                if(child.userData.shape === 'box')
                                {
                                    
                                    // let phys = new SB.ObjectPhysics.BoxPhysics({
                                    //     mass: 1,
                                    //     size: new SB.THREE.Vector3(child.scale.x, child.scale.y, child.scale.z)
                                    // });
                                    
                                    // let SBobj = new SB.SBObject();
                                    // SBobj.setPhysics(phys);
                                    
                                        console.log(child.scale);
                                        console.log(child.position);

                                    child.visible = false;

                                    let phys = new SB.CANNON.Box(new SB.CANNON.Vec3(child.scale.x, child.scale.y, child.scale.z));
                                    phys.material = new SB.CANNON.Material("boxMat");
                                    phys.material.friction = 1;
                                    carCollision.addShape(phys, new SB.CANNON.Vec3(child.position.x, child.position.y, child.position.z));
                                }
                            }
                            if(child.userData.data === 'navmesh')
                            {
                                child.visible = false;
                            }
                        }
                        if(child.userData.hasOwnProperty('texture'))
                        {
                            child.material = new SB.THREE.MeshLambertMaterial({
                            map: new SB.THREE.TextureLoader().load('../build/graphics/' + child.userData.texture)
                        });
                        }
                    }
                });

                car.collision = carCollision;
                console.log(car);
                world.add(car);
            },
            function ( xhr ) {
                console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
            },
            function ( error ) {
                console.error(error);
            }
        );
    </script>
</body>
</html>